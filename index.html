<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8B5CF6">
    <title>Pok√©Run - Legendary Journey Tracker</title>
    
    <!-- üî• Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Mobile optimizations */
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0a15 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        input {
            font-size: 16px !important; /* Prevents iOS zoom */
        }
        
        button {
            cursor: pointer;
            -webkit-touch-callout: none;
        }
        
        /* PWA loading screen */
        #loading {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        
        #loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* üåü Shiny glow animation for notifications */
        @keyframes shinyGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 215, 0, 0.7); }
        }
        
        .notification-glow {
            animation: shinyGlow 2s ease-in-out infinite;
        }

        /* ‚ú® Badge illuminate animation */
        @keyframes badgeIlluminate {
            0% {
                opacity: 0;
                transform: scale(0.8);
                box-shadow: 0 0 0 rgba(255, 255, 255, 0);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            }
            100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }
        }
        
        .badge-illuminate {
            animation: badgeIlluminate 0.6s ease-out forwards;
        }

        /* üîÑ Badge loading pulse */
        @keyframes badgePulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.7; }
        }
        
        .badge-loading {
            animation: badgePulse 1.5s ease-in-out infinite;
        }
        
        /* Pok√©ball Shake Animation */
        @keyframes pokeballShake {
            0%, 100% { transform: rotate(0deg); }
            10% { transform: rotate(-15deg); }
            20% { transform: rotate(15deg); }
            30% { transform: rotate(-10deg); }
            40% { transform: rotate(10deg); }
            50% { transform: rotate(-5deg); }
            60% { transform: rotate(5deg); }
            70% { transform: rotate(0deg); }
        }
        
        .pokeball-shake {
            animation: pokeballShake 0.75s ease-in-out infinite;
        }
        
        @keyframes pokeballSuccessGlow {
            0% { filter: none; }
            100% { filter: drop-shadow(0 0 20px #3b82f6) drop-shadow(0 0 40px #60a5fa) drop-shadow(0 0 60px #93c5fd); }
        }
        
        .pokeball-success {
            animation: pokeballSuccessGlow 0.5s ease-out forwards;
            transform: rotate(0deg);
        }
        
        @keyframes pokeballFail {
            0% { 
                filter: grayscale(0%) brightness(100%);
                opacity: 1;
                transform: rotate(0deg);
            }
            50% { 
                filter: grayscale(100%) brightness(70%);
                opacity: 0.8;
                transform: rotate(0deg);
            }
            100% { 
                filter: grayscale(100%) brightness(50%);
                opacity: 0;
                transform: rotate(0deg);
            }
        }
        
        @keyframes pokeballTopPop {
            0% { 
                transform: scaleY(1) translateY(0);
            }
            30% { 
                transform: scaleY(0.3) translateY(-8px);
            }
            100% { 
                transform: scaleY(0.1) translateY(-10px);
            }
        }
        
        .pokeball-fail {
            animation: pokeballFail 1.5s ease-out forwards;
        }
        
        .pokeball-top-failed {
            animation: pokeballTopPop 0.4s ease-out forwards;
            transform-origin: center bottom;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loader"></div>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        console.log('Script starting...');
        const { useState, useRef, useEffect } = React;
        console.log('React loaded:', !!React);

        // Storage API
        if (!window.storage) {
            window.storage = {
                async get(key) {
                    const value = localStorage.getItem(key);
                    return value ? { key, value, shared: false } : null;
                },
                async set(key, value) {
                    localStorage.setItem(key, value);
                    return { key, value, shared: false };
                }
            };
        }

        // =========================
        // üî• FIREBASE INITIALIZATION
        // =========================
        const firebaseConfig = {
            apiKey: "AIzaSyDpCRERyu40mLWP7ahbzIokFg3nMRBMOrs",
            authDomain: "pokerun-e36be.firebaseapp.com",
            databaseURL: "https://pokerun-e36be-default-rtdb.firebaseio.com",
            projectId: "pokerun-e36be",
            storageBucket: "pokerun-e36be.firebasestorage.app",
            messagingSenderId: "813130222312",
            appId: "1:813130222312:web:140ab42b21341cb8c1575d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        console.log('üî• Firebase initialized successfully');

        // =========================
        // üé® TRAINER NAME GENERATION
        // =========================
        const TRAINER_NAMES = [
            'Ash', 'Red', 'Blue', 'Green', 'Yellow', 'Gold', 'Silver', 'Crystal',
            'Ruby', 'Sapphire', 'Emerald', 'Diamond', 'Pearl', 'Platinum',
            'Black', 'White', 'X', 'Y', 'Sun', 'Moon', 'Elio', 'Selene',
            'Victor', 'Gloria', 'Chase', 'Elaine', 'Leaf', 'Ethan', 'Lyra',
            'Brendan', 'May', 'Lucas', 'Dawn', 'Hilbert', 'Hilda', 'Nate', 'Rosa',
            'Calem', 'Serena', 'Hop', 'Marnie', 'Bede', 'Trace', 'Gladion',
            'Lillie', 'Hau', 'Bianca', 'Cheren', 'N', 'Barry', 'Wally', 'Zinnia'
        ];

        const TRAINER_COLORS = [
            'Crimson', 'Scarlet', 'Ruby', 'Cherry', 'Rose', 'Coral', 'Salmon',
            'Orange', 'Amber', 'Gold', 'Yellow', 'Lime', 'Emerald', 'Jade',
            'Teal', 'Cyan', 'Azure', 'Sapphire', 'Cobalt', 'Navy', 'Indigo',
            'Violet', 'Purple', 'Magenta', 'Pink', 'Silver', 'Gray', 'Slate',
            'Onyx', 'Ebony', 'Ivory', 'Pearl', 'Frost', 'Sky', 'Ocean', 'Forest'
        ];

        const COLOR_HEX_MAP = {
            'Crimson': '#DC143C', 'Scarlet': '#FF2400', 'Ruby': '#E0115F', 'Cherry': '#DE3163',
            'Rose': '#FF007F', 'Coral': '#FF7F50', 'Salmon': '#FA8072', 'Orange': '#FF8C00',
            'Amber': '#FFBF00', 'Gold': '#FFD700', 'Yellow': '#FFFF00', 'Lime': '#32CD32',
            'Emerald': '#50C878', 'Jade': '#00A86B', 'Teal': '#008080', 'Cyan': '#00FFFF',
            'Azure': '#007FFF', 'Sapphire': '#0F52BA', 'Cobalt': '#0047AB', 'Navy': '#000080',
            'Indigo': '#4B0082', 'Violet': '#8F00FF', 'Purple': '#800080', 'Magenta': '#FF00FF',
            'Pink': '#FFC0CB', 'Silver': '#C0C0C0', 'Gray': '#808080', 'Slate': '#708090',
            'Onyx': '#353839', 'Ebony': '#555D50', 'Ivory': '#FFFFF0', 'Pearl': '#F0EAD6',
            'Frost': '#E1F5FE', 'Sky': '#87CEEB', 'Ocean': '#006994', 'Forest': '#228B22'
        };

        function generateUniqueTrainerName(existingNames = []) {
            const used = new Set(existingNames);
            let attempts = 0;
            const maxAttempts = 5000;

            while (attempts < maxAttempts) {
                const color = TRAINER_COLORS[Math.floor(Math.random() * TRAINER_COLORS.length)];
                const name = TRAINER_NAMES[Math.floor(Math.random() * TRAINER_NAMES.length)];
                const prefix = attempts > 3000 ? 'Dark ' : '';
                const fullName = `${prefix}${color} ${name}`;

                if (!used.has(fullName)) {
                    return {
                        displayName: fullName,
                        badgeColor: COLOR_HEX_MAP[color] || '#808080'
                    };
                }
                attempts++;
            }

            // Fallback with timestamp
            return {
                displayName: `Trainer ${Date.now()}`,
                badgeColor: '#808080'
            };
        }

        // =========================
        // üîê FIREBASE AUTH & MIGRATION SYSTEM
        // =========================
        class FirebaseManager {
            constructor() {
                this.user = null;
                this.isOnline = navigator.onLine;
                this.migrationInProgress = false;
                this.pendingWrites = [];

                // Listen for online/offline
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('üì° Back online');
                    this.syncPendingWrites();
                });
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('üì¥ Offline mode');
                });

                // Check for existing auth state
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        this.user = user;
                        console.log('‚úÖ Auth state restored:', user.uid);
                    }
                });
            }

            async signInAnonymously() {
                try {
                    const userCredential = await auth.signInAnonymously();
                    this.user = userCredential.user;
                    console.log('‚úÖ Anonymous auth successful:', this.user.uid);
                    return this.user;
                } catch (error) {
                    console.error('‚ùå Anonymous auth failed:', error);
                    throw error;
                }
            }

            async createTrainerProfile() {
                if (!this.user) {
                    throw new Error('No authenticated user');
                }

                // Check if profile already exists
                const profileSnapshot = await database.ref(`users/${this.user.uid}/profile`).once('value');
                if (profileSnapshot.exists()) {
                    console.log('‚úÖ Profile already exists');
                    return profileSnapshot.val();
                }

                // Fetch all existing names to ensure uniqueness
                const usersSnapshot = await database.ref('users').once('value');
                const existingNames = [];
                usersSnapshot.forEach(child => {
                    const profile = child.val().profile;
                    if (profile && profile.displayName) {
                        existingNames.push(profile.displayName);
                    }
                });

                // Generate unique name
                const { displayName, badgeColor } = generateUniqueTrainerName(existingNames);

                // Create profile
                const profile = {
                    displayName,
                    badgeColor,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                await database.ref(`users/${this.user.uid}/profile`).set(profile);
                console.log('‚úÖ Trainer profile created:', displayName);

                return profile;
            }

            async migrateLocalStorageToFirebase() {
                if (!this.user || this.migrationInProgress) {
                    return;
                }

                this.migrationInProgress = true;
                console.log('üîÑ Starting migration from localStorage to Firebase...');

                try {
                    // Migrate runs
                    const runsData = localStorage.getItem('pokemonRuns');
                    if (runsData) {
                        const runs = JSON.parse(runsData);
                        if (Array.isArray(runs) && runs.length > 0) {
                            const runsRef = database.ref(`users/${this.user.uid}/runs`);
                            const runsObject = {};
                            runs.forEach((run, index) => {
                                runsObject[`run_${Date.now()}_${index}`] = run;
                            });
                            await runsRef.set(runsObject);
                            console.log(`‚úÖ Migrated ${runs.length} runs`);
                        }
                    }

                    // Migrate PC
                    const pcData = localStorage.getItem('pokemonPC');
                    if (pcData) {
                        const pc = JSON.parse(pcData);
                        if (Array.isArray(pc) && pc.length > 0) {
                            await database.ref(`users/${this.user.uid}/pc`).set(pc);
                            console.log(`‚úÖ Migrated ${pc.length} Pok√©mon to PC`);
                        }
                    }

                    // Migrate starters
                    const startersData = localStorage.getItem('starterTeam');
                    if (startersData) {
                        const starters = JSON.parse(startersData);
                        if (Array.isArray(starters) && starters.length > 0) {
                            await database.ref(`users/${this.user.uid}/starters`).set(starters);
                            console.log(`‚úÖ Migrated ${starters.length} starters`);
                        }
                    }

                    // Clear localStorage after successful migration
                    localStorage.removeItem('pokemonRuns');
                    localStorage.removeItem('pokemonPC');
                    localStorage.removeItem('starterTeam');
                    
                    // Keep profile backup in localStorage for offline recovery
                    const profile = await this.getProfile();
                    localStorage.setItem('profileBackup', JSON.stringify({
                        uid: this.user.uid,
                        displayName: profile.displayName,
                        badgeColor: profile.badgeColor,
                        timestamp: Date.now()
                    }));

                    console.log('‚úÖ Migration complete! localStorage cleared, profile backed up.');
                    this.migrationInProgress = false;
                    return true;
                } catch (error) {
                    console.error('‚ùå Migration failed:', error);
                    this.migrationInProgress = false;
                    throw error;
                }
            }

            async getProfile() {
                if (!this.user) return null;
                const snapshot = await database.ref(`users/${this.user.uid}/profile`).once('value');
                return snapshot.val();
            }

            async updateProfile(updates) {
                if (!this.user) return;
                await database.ref(`users/${this.user.uid}/profile`).update(updates);
                
                // Update backup
                const profile = await this.getProfile();
                localStorage.setItem('profileBackup', JSON.stringify({
                    uid: this.user.uid,
                    ...profile,
                    timestamp: Date.now()
                }));
            }

            async syncPendingWrites() {
                if (!this.isOnline || this.pendingWrites.length === 0) return;

                console.log(`üîÑ Syncing ${this.pendingWrites.length} pending writes...`);
                
                const writes = [...this.pendingWrites];
                this.pendingWrites = [];

                for (const write of writes) {
                    try {
                        await database.ref(write.path).set(write.data);
                        console.log('‚úÖ Synced:', write.path);
                    } catch (error) {
                        console.error('‚ùå Sync failed for:', write.path, error);
                        this.pendingWrites.push(write); // Retry later
                    }
                }
            }

            queueWrite(path, data) {
                if (this.isOnline && this.user) {
                    return database.ref(path).set(data);
                } else {
                    this.pendingWrites.push({ path, data });
                    console.log('üì¶ Queued for sync:', path);
                    
                    // Also save to localStorage as backup
                    const key = path.replace(/\//g, '_');
                    localStorage.setItem(`pending_${key}`, JSON.stringify(data));
                    
                    return Promise.resolve();
                }
            }
        }

        const firebaseManager = new FirebaseManager();


        // =========================
        // ‚úÖ NEW RARITY DATABASE (1‚Äì898)
        // =========================
        const POKEMON_RARITY_MAP = {
            // GEN 1 (1-151)
            1: 'common',     // Bulbasaur (starter base)
            2: 'uncommon',   // Ivysaur (starter mid)
            3: 'rare',       // Venusaur (starter final)
            4: 'common',     // Charmander (starter base)
            5: 'uncommon',   // Charmeleon (starter mid)
            6: 'rare',       // Charizard (starter final)
            7: 'common',     // Squirtle (starter base)
            8: 'uncommon',   // Wartortle (starter mid)
            9: 'rare',       // Blastoise (starter final)
            10: 'common',    // Caterpie (very common, stage 1)
            11: 'uncommon',  // Metapod (stage 2)
            12: 'rare',      // Butterfree (stage 3)
            13: 'common',    // Weedle (very common, stage 1)
            14: 'uncommon',  // Kakuna (stage 2)
            15: 'rare',      // Beedrill (stage 3)
            16: 'common',    // Pidgey (very common, stage 1)
            17: 'uncommon',  // Pidgeotto (stage 2)
            18: 'rare',      // Pidgeot (stage 3)
            19: 'common',    // Rattata (very common, stage 1)
            20: 'uncommon',  // Raticate (stage 2)
            21: 'common',    // Spearow (common, stage 1)
            22: 'uncommon',  // Fearow (stage 2)
            23: 'common',    // Ekans (common, stage 1)
            24: 'uncommon',  // Arbok (stage 2)
            25: 'common',    // Pikachu (common, stage 1)
            26: 'uncommon',  // Raichu (stage 2)
            27: 'common',    // Sandshrew (common, stage 1)
            28: 'uncommon',  // Sandslash (stage 2)
            29: 'common',    // Nidoran‚ôÄ (common, stage 1)
            30: 'uncommon',  // Nidorina (stage 2)
            31: 'rare',      // Nidoqueen (stage 3)
            32: 'common',    // Nidoran‚ôÇ (common, stage 1)
            33: 'uncommon',  // Nidorino (stage 2)
            34: 'rare',      // Nidoking (stage 3)
            35: 'common',    // Clefairy (common, stage 1)
            36: 'uncommon',  // Clefable (stage 2)
            37: 'common',    // Vulpix (uncommon in games, stage 1)
            38: 'uncommon',  // Ninetales (stage 2)
            39: 'common',    // Jigglypuff (common, stage 1)
            40: 'uncommon',  // Wigglytuff (stage 2)
            41: 'common',    // Zubat (very common, stage 1)
            42: 'uncommon',  // Golbat (stage 2)
            43: 'common',    // Oddish (common, stage 1)
            44: 'uncommon',  // Gloom (stage 2)
            45: 'rare',      // Vileplume (stage 3)
            46: 'common',    // Paras (common, stage 1)
            47: 'uncommon',  // Parasect (stage 2)
            48: 'common',    // Venonat (common, stage 1)
            49: 'uncommon',  // Venomoth (stage 2)
            50: 'common',    // Diglett (common, stage 1)
            51: 'uncommon',  // Dugtrio (stage 2)
            52: 'common',    // Meowth (common, stage 1)
            53: 'uncommon',  // Persian (stage 2)
            54: 'common',    // Psyduck (common, stage 1)
            55: 'uncommon',  // Golduck (stage 2)
            56: 'common',    // Mankey (common, stage 1)
            57: 'uncommon',  // Primeape (stage 2)
            58: 'common',    // Growlithe (uncommon in games, stage 1)
            59: 'uncommon',  // Arcanine (stage 2, low catch rate)
            60: 'common',    // Poliwag (common, stage 1)
            61: 'uncommon',  // Poliwhirl (stage 2)
            62: 'rare',      // Poliwrath (stage 3)
            63: 'common',    // Abra (stage 1, but teleports)
            64: 'uncommon',  // Kadabra (stage 2)
            65: 'rare',      // Alakazam (stage 3, trade evolution)
            66: 'common',    // Machop (common, stage 1)
            67: 'uncommon',  // Machoke (stage 2)
            68: 'rare',      // Machamp (stage 3, trade evolution)
            69: 'common',    // Bellsprout (common, stage 1)
            70: 'uncommon',  // Weepinbell (stage 2)
            71: 'rare',      // Victreebel (stage 3)
            72: 'common',    // Tentacool (very common, stage 1)
            73: 'uncommon',  // Tentacruel (stage 2)
            74: 'common',    // Geodude (very common, stage 1)
            75: 'uncommon',  // Graveler (stage 2)
            76: 'rare',      // Golem (stage 3, trade evolution)
            77: 'common',    // Ponyta (uncommon, stage 1)
            78: 'uncommon',  // Rapidash (stage 2)
            79: 'common',    // Slowpoke (common, stage 1)
            80: 'uncommon',  // Slowbro (stage 2)
            81: 'common',    // Magnemite (uncommon, stage 1)
            82: 'uncommon',  // Magneton (stage 2)
            83: 'uncommon',  // Farfetch'd (rare encounter, no evolution)
            84: 'common',    // Doduo (uncommon, stage 1)
            85: 'uncommon',  // Dodrio (stage 2)
            86: 'common',    // Seel (uncommon, stage 1)
            87: 'uncommon',  // Dewgong (stage 2)
            88: 'common',    // Grimer (uncommon, stage 1)
            89: 'uncommon',  // Muk (stage 2)
            90: 'common',    // Shellder (uncommon, stage 1)
            91: 'uncommon',  // Cloyster (stage 2)
            92: 'common',    // Gastly (common, stage 1)
            93: 'uncommon',  // Haunter (stage 2)
            94: 'rare',      // Gengar (stage 3, trade evolution)
            95: 'uncommon',  // Onix (uncommon encounter, stage 1 but evolves later)
            96: 'common',    // Drowzee (common, stage 1)
            97: 'uncommon',  // Hypno (stage 2)
            98: 'common',    // Krabby (common, stage 1)
            99: 'uncommon',  // Kingler (stage 2)
            100: 'common',   // Voltorb (common, stage 1)
            101: 'uncommon', // Electrode (stage 2)
            102: 'common',   // Exeggcute (uncommon, stage 1)
            103: 'uncommon', // Exeggutor (stage 2)
            104: 'common',   // Cubone (uncommon, stage 1)
            105: 'uncommon', // Marowak (stage 2)
            106: 'uncommon', // Hitmonlee (rare, no evolution)
            107: 'uncommon', // Hitmonchan (rare, no evolution)
            108: 'uncommon', // Lickitung (rare, stage 1 but evolves later)
            109: 'common',   // Koffing (common, stage 1)
            110: 'uncommon', // Weezing (stage 2)
            111: 'common',   // Rhyhorn (uncommon, stage 1)
            112: 'uncommon', // Rhydon (stage 2)
            113: 'uncommon', // Chansey (very rare encounter, stage 1)
            114: 'uncommon', // Tangela (rare encounter, stage 1)
            115: 'uncommon', // Kangaskhan (rare encounter, no evolution)
            116: 'common',   // Horsea (common, stage 1)
            117: 'uncommon', // Seadra (stage 2)
            118: 'common',   // Goldeen (common, stage 1)
            119: 'uncommon', // Seaking (stage 2)
            120: 'common',   // Staryu (uncommon, stage 1)
            121: 'uncommon', // Starmie (stage 2)
            122: 'uncommon', // Mr. Mime (rare encounter, no evolution)
            123: 'uncommon', // Scyther (rare encounter, stage 1)
            124: 'uncommon', // Jynx (rare encounter, stage 1)
            125: 'uncommon', // Electabuzz (rare encounter, stage 1)
            126: 'uncommon', // Magmar (rare encounter, stage 1)
            127: 'uncommon', // Pinsir (rare encounter, no evolution)
            128: 'uncommon', // Tauros (rare encounter, no evolution)
            129: 'common',   // Magikarp (very common, stage 1)
            130: 'rare',     // Gyarados (stage 2, pseudo-legendary stats)
            131: 'rare',     // Lapras (very rare encounter, no evolution)
            132: 'uncommon', // Ditto (rare encounter, no evolution)
            133: 'common',   // Eevee (uncommon, stage 1)
            134: 'uncommon', // Vaporeon (stage 2)
            135: 'uncommon', // Jolteon (stage 2)
            136: 'uncommon', // Flareon (stage 2)
            137: 'uncommon', // Porygon (rare, stage 1)
            138: 'common',   // Omanyte (fossil, stage 1)
            139: 'uncommon', // Omastar (stage 2)
            140: 'common',   // Kabuto (fossil, stage 1)
            141: 'uncommon', // Kabutops (stage 2)
            142: 'rare',     // Aerodactyl (fossil, no evolution, rare)
            143: 'rare',     // Snorlax (very rare encounter, stage 1)
            144: 'legendary', // Articuno
            145: 'legendary', // Zapdos
            146: 'legendary', // Moltres
            147: 'common',   // Dratini (rare but stage 1)
            148: 'uncommon', // Dragonair (stage 2)
            149: 'rare',     // Dragonite (pseudo-legendary)
            150: 'legendary', // Mewtwo
            151: 'legendary', // Mew

            // GEN 2 (152-251)
            152: 'common',   // Chikorita (starter base)
            153: 'uncommon', // Bayleef (starter mid)
            154: 'rare',     // Meganium (starter final)
            155: 'common',   // Cyndaquil (starter base)
            156: 'uncommon', // Quilava (starter mid)
            157: 'rare',     // Typhlosion (starter final)
            158: 'common',   // Totodile (starter base)
            159: 'uncommon', // Croconaw (starter mid)
            160: 'rare',     // Feraligatr (starter final)
            161: 'common',   // Sentret (very common, stage 1)
            162: 'uncommon', // Furret (stage 2)
            163: 'common',   // Hoothoot (very common, stage 1)
            164: 'uncommon', // Noctowl (stage 2)
            165: 'common',   // Ledyba (common, stage 1)
            166: 'uncommon', // Ledian (stage 2)
            167: 'common',   // Spinarak (common, stage 1)
            168: 'uncommon', // Ariados (stage 2)
            169: 'rare',     // Crobat (stage 3 from Golbat)
            170: 'common',   // Chinchou (uncommon, stage 1)
            171: 'uncommon', // Lanturn (stage 2)
            172: 'common',   // Pichu (baby, stage 1)
            173: 'common',   // Cleffa (baby, stage 1)
            174: 'common',   // Igglybuff (baby, stage 1)
            175: 'common',   // Togepi (rare but stage 1)
            176: 'uncommon', // Togetic (stage 2)
            177: 'common',   // Natu (uncommon, stage 1)
            178: 'uncommon', // Xatu (stage 2)
            179: 'common',   // Mareep (uncommon, stage 1)
            180: 'uncommon', // Flaaffy (stage 2)
            181: 'rare',     // Ampharos (stage 3)
            182: 'rare',     // Bellossom (alternate stage 3 from Gloom)
            183: 'common',   // Marill (common, stage 1)
            184: 'uncommon', // Azumarill (stage 2)
            185: 'uncommon', // Sudowoodo (rare encounter, no evolution)
            186: 'rare',     // Politoed (alternate stage 3 from Poliwhirl)
            187: 'common',   // Hoppip (common, stage 1)
            188: 'uncommon', // Skiploom (stage 2)
            189: 'rare',     // Jumpluff (stage 3)
            190: 'common',   // Aipom (uncommon, stage 1)
            191: 'common',   // Sunkern (common, stage 1)
            192: 'uncommon', // Sunflora (stage 2)
            193: 'common',   // Yanma (uncommon, stage 1)
            194: 'common',   // Wooper (common, stage 1)
            195: 'uncommon', // Quagsire (stage 2)
            196: 'uncommon', // Espeon (Eevee evolution)
            197: 'uncommon', // Umbreon (Eevee evolution)
            198: 'common',   // Murkrow (uncommon, stage 1)
            199: 'rare',     // Slowking (alternate stage 3)
            200: 'uncommon', // Misdreavus (rare encounter, stage 1)
            201: 'uncommon', // Unown (rare encounter, no evolution)
            202: 'uncommon', // Wobbuffet (rare encounter, stage 2)
            203: 'uncommon', // Girafarig (rare encounter, no evolution)
            204: 'common',   // Pineco (uncommon, stage 1)
            205: 'uncommon', // Forretress (stage 2)
            206: 'uncommon', // Dunsparce (rare encounter, no evolution)
            207: 'common',   // Gligar (uncommon, stage 1)
            208: 'rare',     // Steelix (stage 3 from Onix, trade)
            209: 'common',   // Snubbull (uncommon, stage 1)
            210: 'uncommon', // Granbull (stage 2)
            211: 'uncommon', // Qwilfish (rare encounter, no evolution)
            212: 'rare',     // Scizor (stage 2 from Scyther, trade)
            213: 'uncommon', // Shuckle (rare encounter, no evolution)
            214: 'uncommon', // Heracross (rare encounter, no evolution)
            215: 'common',   // Sneasel (uncommon, stage 1)
            216: 'common',   // Teddiursa (uncommon, stage 1)
            217: 'uncommon', // Ursaring (stage 2)
            218: 'common',   // Slugma (uncommon, stage 1)
            219: 'uncommon', // Magcargo (stage 2)
            220: 'common',   // Swinub (common, stage 1)
            221: 'uncommon', // Piloswine (stage 2)
            222: 'uncommon', // Corsola (rare encounter, no evolution)
            223: 'common',   // Remoraid (common, stage 1)
            224: 'uncommon', // Octillery (stage 2)
            225: 'uncommon', // Delibird (rare encounter, no evolution)
            226: 'uncommon', // Mantine (rare encounter, stage 2)
            227: 'uncommon', // Skarmory (rare encounter, no evolution)
            228: 'common',   // Houndour (uncommon, stage 1)
            229: 'uncommon', // Houndoom (stage 2)
            230: 'rare',     // Kingdra (stage 3 from Seadra, trade)
            231: 'common',   // Phanpy (uncommon, stage 1)
            232: 'uncommon', // Donphan (stage 2)
            233: 'uncommon', // Porygon2 (stage 2 from Porygon, trade)
            234: 'uncommon', // Stantler (rare encounter, no evolution)
            235: 'uncommon', // Smeargle (rare encounter, no evolution)
            236: 'common',   // Tyrogue (rare but stage 1)
            237: 'uncommon', // Hitmontop (stage 2)
            238: 'common',   // Smoochum (baby, stage 1)
            239: 'common',   // Elekid (baby, stage 1)
            240: 'common',   // Magby (baby, stage 1)
            241: 'uncommon', // Miltank (rare encounter, no evolution)
            242: 'rare',     // Blissey (stage 3 from Chansey)
            243: 'legendary', // Raikou
            244: 'legendary', // Entei
            245: 'legendary', // Suicune
            246: 'common',   // Larvitar (rare but stage 1)
            247: 'uncommon', // Pupitar (stage 2)
            248: 'rare',     // Tyranitar (pseudo-legendary)
            249: 'legendary', // Lugia
            250: 'legendary', // Ho-Oh
            251: 'legendary', // Celebi

            // GEN 3 (252-386)
            252: 'common',   // Treecko (starter base)
            253: 'uncommon', // Grovyle (starter mid)
            254: 'rare',     // Sceptile (starter final)
            255: 'common',   // Torchic (starter base)
            256: 'uncommon', // Combusken (starter mid)
            257: 'rare',     // Blaziken (starter final)
            258: 'common',   // Mudkip (starter base)
            259: 'uncommon', // Marshtomp (starter mid)
            260: 'rare',     // Swampert (starter final)
            261: 'common',   // Poochyena (very common, stage 1)
            262: 'uncommon', // Mightyena (stage 2)
            263: 'common',   // Zigzagoon (very common, stage 1)
            264: 'uncommon', // Linoone (stage 2)
            265: 'common',   // Wurmple (very common, stage 1)
            266: 'uncommon', // Silcoon (stage 2)
            267: 'rare',     // Beautifly (stage 3)
            268: 'uncommon', // Cascoon (stage 2)
            269: 'rare',     // Dustox (stage 3)
            270: 'common',   // Lotad (common, stage 1)
            271: 'uncommon', // Lombre (stage 2)
            272: 'rare',     // Ludicolo (stage 3)
            273: 'common',   // Seedot (common, stage 1)
            274: 'uncommon', // Nuzleaf (stage 2)
            275: 'rare',     // Shiftry (stage 3)
            276: 'common',   // Taillow (common, stage 1)
            277: 'uncommon', // Swellow (stage 2)
            278: 'common',   // Wingull (very common, stage 1)
            279: 'uncommon', // Pelipper (stage 2)
            280: 'common',   // Ralts (uncommon, stage 1)
            281: 'uncommon', // Kirlia (stage 2)
            282: 'rare',     // Gardevoir (stage 3)
            283: 'common',   // Surskit (common, stage 1)
            284: 'uncommon', // Masquerain (stage 2)
            285: 'common',   // Shroomish (common, stage 1)
            286: 'uncommon', // Breloom (stage 2)
            287: 'common',   // Slakoth (uncommon, stage 1)
            288: 'uncommon', // Vigoroth (stage 2)
            289: 'rare',     // Slaking (stage 3, high BST)
            290: 'common',   // Nincada (uncommon, stage 1)
            291: 'uncommon', // Ninjask (stage 2)
            292: 'rare',     // Shedinja (special evolution, rare)
            293: 'common',   // Whismur (common, stage 1)
            294: 'uncommon', // Loudred (stage 2)
            295: 'rare',     // Exploud (stage 3)
            296: 'common',   // Makuhita (common, stage 1)
            297: 'uncommon', // Hariyama (stage 2)
            298: 'common',   // Azurill (baby, stage 1)
            299: 'uncommon', // Nosepass (uncommon, stage 1)
            300: 'common',   // Skitty (common, stage 1)
            301: 'uncommon', // Delcatty (stage 2)
            302: 'uncommon', // Sableye (rare encounter, no evolution)
            303: 'uncommon', // Mawile (rare encounter, no evolution)
            304: 'common',   // Aron (uncommon, stage 1)
            305: 'uncommon', // Lairon (stage 2)
            306: 'rare',     // Aggron (stage 3)
            307: 'common',   // Meditite (uncommon, stage 1)
            308: 'uncommon', // Medicham (stage 2)
            309: 'common',   // Electrike (common, stage 1)
            310: 'uncommon', // Manectric (stage 2)
            311: 'uncommon', // Plusle (uncommon, no evolution)
            312: 'uncommon', // Minun (uncommon, no evolution)
            313: 'uncommon', // Volbeat (uncommon, no evolution)
            314: 'uncommon', // Illumise (uncommon, no evolution)
            315: 'uncommon', // Roselia (uncommon, stage 2)
            316: 'common',   // Gulpin (common, stage 1)
            317: 'uncommon', // Swalot (stage 2)
            318: 'common',   // Carvanha (common, stage 1)
            319: 'uncommon', // Sharpedo (stage 2)
            320: 'common',   // Wailmer (common, stage 1)
            321: 'uncommon', // Wailord (stage 2)
            322: 'common',   // Numel (common, stage 1)
            323: 'uncommon', // Camerupt (stage 2)
            324: 'uncommon', // Torkoal (uncommon, no evolution)
            325: 'common',   // Spoink (uncommon, stage 1)
            326: 'uncommon', // Grumpig (stage 2)
            327: 'uncommon', // Spinda (rare encounter, no evolution)
            328: 'common',   // Trapinch (uncommon, stage 1)
            329: 'uncommon', // Vibrava (stage 2)
            330: 'rare',     // Flygon (stage 3)
            331: 'common',   // Cacnea (uncommon, stage 1)
            332: 'uncommon', // Cacturne (stage 2)
            333: 'common',   // Swablu (common, stage 1)
            334: 'uncommon', // Altaria (stage 2)
            335: 'uncommon', // Zangoose (rare encounter, no evolution)
            336: 'uncommon', // Seviper (rare encounter, no evolution)
            337: 'uncommon', // Lunatone (rare encounter, no evolution)
            338: 'uncommon', // Solrock (rare encounter, no evolution)
            339: 'common',   // Barboach (common, stage 1)
            340: 'uncommon', // Whiscash (stage 2)
            341: 'common',   // Corphish (common, stage 1)
            342: 'uncommon', // Crawdaunt (stage 2)
            343: 'common',   // Baltoy (uncommon, stage 1)
            344: 'uncommon', // Claydol (stage 2)
            345: 'common',   // Lileep (fossil, stage 1)
            346: 'uncommon', // Cradily (stage 2)
            347: 'common',   // Anorith (fossil, stage 1)
            348: 'uncommon', // Armaldo (stage 2)
            349: 'rare',     // Feebas (very rare encounter, stage 1)
            350: 'rare',     // Milotic (stage 2, special evolution)
            351: 'uncommon', // Castform (rare encounter, no evolution)
            352: 'uncommon', // Kecleon (rare encounter, no evolution)
            353: 'common',   // Shuppet (uncommon, stage 1)
            354: 'uncommon', // Banette (stage 2)
            355: 'common',   // Duskull (uncommon, stage 1)
            356: 'uncommon', // Dusclops (stage 2)
            357: 'uncommon', // Tropius (rare encounter, no evolution)
            358: 'uncommon', // Chimecho (rare encounter, stage 2)
            359: 'uncommon', // Absol (rare encounter, no evolution)
            360: 'common',   // Wynaut (baby, stage 1)
            361: 'common',   // Snorunt (uncommon, stage 1)
            362: 'uncommon', // Glalie (stage 2)
            363: 'common',   // Spheal (common, stage 1)
            364: 'uncommon', // Sealeo (stage 2)
            365: 'rare',     // Walrein (stage 3)
            366: 'common',   // Clamperl (uncommon, stage 1)
            367: 'uncommon', // Huntail (stage 2)
            368: 'uncommon', // Gorebyss (stage 2)
            369: 'rare',     // Relicanth (very rare encounter, no evolution)
            370: 'uncommon', // Luvdisc (uncommon, no evolution)
            371: 'common',   // Bagon (rare but stage 1)
            372: 'uncommon', // Shelgon (stage 2)
            373: 'rare',     // Salamence (pseudo-legendary)
            374: 'common',   // Beldum (very rare but stage 1)
            375: 'uncommon', // Metang (stage 2)
            376: 'rare',     // Metagross (pseudo-legendary)
            377: 'legendary', // Regirock
            378: 'legendary', // Regice
            379: 'legendary', // Registeel
            380: 'legendary', // Latias
            381: 'legendary', // Latios
            382: 'legendary', // Kyogre
            383: 'legendary', // Groudon
            384: 'legendary', // Rayquaza
            385: 'legendary', // Jirachi
            386: 'legendary', // Deoxys

            // GEN 4 (387-493)
            387: 'common',   // Turtwig (starter base)
            388: 'uncommon', // Grotle (starter mid)
            389: 'rare',     // Torterra (starter final)
            390: 'common',   // Chimchar (starter base)
            391: 'uncommon', // Monferno (starter mid)
            392: 'rare',     // Infernape (starter final)
            393: 'common',   // Piplup (starter base)
            394: 'uncommon', // Prinplup (starter mid)
            395: 'rare',     // Empoleon (starter final)
            396: 'common',   // Starly (very common, stage 1)
            397: 'uncommon', // Staravia (stage 2)
            398: 'rare',     // Staraptor (stage 3)
            399: 'common',   // Bidoof (very common, stage 1)
            400: 'uncommon', // Bibarel (stage 2)
            401: 'common',   // Kricketot (common, stage 1)
            402: 'uncommon', // Kricketune (stage 2)
            403: 'common',   // Shinx (common, stage 1)
            404: 'uncommon', // Luxio (stage 2)
            405: 'rare',     // Luxray (stage 3)
            406: 'common',   // Budew (baby, stage 1)
            407: 'rare',     // Roserade (stage 3 from Roselia)
            408: 'common',   // Cranidos (fossil, stage 1)
            409: 'uncommon', // Rampardos (stage 2)
            410: 'common',   // Shieldon (fossil, stage 1)
            411: 'uncommon', // Bastiodon (stage 2)
            412: 'common',   // Burmy (common, stage 1)
            413: 'uncommon', // Wormadam (stage 2)
            414: 'uncommon', // Mothim (stage 2)
            415: 'common',   // Combee (common, stage 1)
            416: 'uncommon', // Vespiquen (stage 2)
            417: 'uncommon', // Pachirisu (uncommon, no evolution)
            418: 'common',   // Buizel (common, stage 1)
            419: 'uncommon', // Floatzel (stage 2)
            420: 'common',   // Cherubi (uncommon, stage 1)
            421: 'uncommon', // Cherrim (stage 2)
            422: 'common',   // Shellos (common, stage 1)
            423: 'uncommon', // Gastrodon (stage 2)
            424: 'rare',     // Ambipom (stage 3 from Aipom)
            425: 'common',   // Drifloon (uncommon, stage 1)
            426: 'uncommon', // Drifblim (stage 2)
            427: 'common',   // Buneary (common, stage 1)
            428: 'uncommon', // Lopunny (stage 2)
            429: 'uncommon', // Mismagius (stage 2 from Misdreavus)
            430: 'rare',     // Honchkrow (stage 3 from Murkrow)
            431: 'common',   // Glameow (common, stage 1)
            432: 'uncommon', // Purugly (stage 2)
            433: 'common',   // Chingling (baby, stage 1)
            434: 'common',   // Stunky (common, stage 1)
            435: 'uncommon', // Skuntank (stage 2)
            436: 'common',   // Bronzor (uncommon, stage 1)
            437: 'uncommon', // Bronzong (stage 2)
            438: 'common',   // Bonsly (baby, stage 1)
            439: 'common',   // Mime Jr. (baby, stage 1)
            440: 'uncommon', // Happiny (baby, stage 1)
            441: 'uncommon', // Chatot (uncommon, no evolution)
            442: 'rare',     // Spiritomb (very rare encounter, no evolution)
            443: 'common',   // Gible (rare but stage 1)
            444: 'uncommon', // Gabite (stage 2)
            445: 'rare',     // Garchomp (pseudo-legendary)
            446: 'rare',     // Munchlax (very rare, stage 1)
            447: 'common',   // Riolu (rare but stage 1)
            448: 'uncommon', // Lucario (stage 2)
            449: 'common',   // Hippopotas (uncommon, stage 1)
            450: 'uncommon', // Hippowdon (stage 2)
            451: 'common',   // Skorupi (uncommon, stage 1)
            452: 'uncommon', // Drapion (stage 2)
            453: 'common',   // Croagunk (uncommon, stage 1)
            454: 'uncommon', // Toxicroak (stage 2)
            455: 'uncommon', // Carnivine (rare encounter, no evolution)
            456: 'common',   // Finneon (uncommon, stage 1)
            457: 'uncommon', // Lumineon (stage 2)
            458: 'rare',     // Mantyke (baby but rare, stage 1)
            459: 'common',   // Snover (uncommon, stage 1)
            460: 'uncommon', // Abomasnow (stage 2)
            461: 'rare',     // Weavile (stage 3 from Sneasel)
            462: 'rare',     // Magnezone (stage 3 from Magneton)
            463: 'rare',     // Lickilicky (stage 3 from Lickitung)
            464: 'rare',     // Rhyperior (stage 3 from Rhydon)
            465: 'rare',     // Tangrowth (stage 3 from Tangela)
            466: 'rare',     // Electivire (stage 3 from Electabuzz)
            467: 'rare',     // Magmortar (stage 3 from Magmar)
            468: 'rare',     // Togekiss (stage 3 from Togetic)
            469: 'rare',     // Yanmega (stage 3 from Yanma)
            470: 'uncommon', // Leafeon (Eevee evolution)
            471: 'uncommon', // Glaceon (Eevee evolution)
            472: 'rare',     // Gliscor (stage 3 from Gligar)
            473: 'rare',     // Mamoswine (stage 3 from Piloswine)
            474: 'uncommon', // Porygon-Z (stage 3 from Porygon2)
            475: 'rare',     // Gallade (alternate stage 3 from Kirlia)
            476: 'uncommon', // Probopass (stage 2 from Nosepass)
            477: 'rare',     // Dusknoir (stage 3 from Dusclops)
            478: 'rare',     // Froslass (alternate stage 3 from Snorunt)
            479: 'uncommon', // Rotom (rare encounter, no evolution)
            480: 'legendary', // Uxie
            481: 'legendary', // Mesprit
            482: 'legendary', // Azelf
            483: 'legendary', // Dialga
            484: 'legendary', // Palkia
            485: 'legendary', // Heatran
            486: 'legendary', // Regigigas
            487: 'legendary', // Giratina
            488: 'legendary', // Cresselia
            489: 'legendary', // Phione
            490: 'legendary', // Manaphy
            491: 'legendary', // Darkrai
            492: 'legendary', // Shaymin
            493: 'legendary', // Arceus

            // GEN 5 (494-649)
            494: 'legendary', // Victini
            495: 'common',   // Snivy (starter base)
            496: 'uncommon', // Servine (starter mid)
            497: 'rare',     // Serperior (starter final)
            498: 'common',   // Tepig (starter base)
            499: 'uncommon', // Pignite (starter mid)
            500: 'rare',     // Emboar (starter final)
            501: 'common',   // Oshawott (starter base)
            502: 'uncommon', // Dewott (starter mid)
            503: 'rare',     // Samurott (starter final)
            504: 'common',   // Patrat (very common, stage 1)
            505: 'uncommon', // Watchog (stage 2)
            506: 'common',   // Lillipup (common, stage 1)
            507: 'uncommon', // Herdier (stage 2)
            508: 'rare',     // Stoutland (stage 3)
            509: 'common',   // Purrloin (common, stage 1)
            510: 'uncommon', // Liepard (stage 2)
            511: 'common',   // Pansage (uncommon, stage 1)
            512: 'uncommon', // Simisage (stage 2)
            513: 'common',   // Pansear (uncommon, stage 1)
            514: 'uncommon', // Simisear (stage 2)
            515: 'common',   // Panpour (uncommon, stage 1)
            516: 'uncommon', // Simipour (stage 2)
            517: 'common',   // Munna (uncommon, stage 1)
            518: 'uncommon', // Musharna (stage 2)
            519: 'common',   // Pidove (very common, stage 1)
            520: 'uncommon', // Tranquill (stage 2)
            521: 'rare',     // Unfezant (stage 3)
            522: 'common',   // Blitzle (common, stage 1)
            523: 'uncommon', // Zebstrika (stage 2)
            524: 'common',   // Roggenrola (common, stage 1)
            525: 'uncommon', // Boldore (stage 2)
            526: 'rare',     // Gigalith (stage 3, trade)
            527: 'common',   // Woobat (common, stage 1)
            528: 'uncommon', // Swoobat (stage 2)
            529: 'common',   // Drilbur (common, stage 1)
            530: 'uncommon', // Excadrill (stage 2)
            531: 'uncommon', // Audino (common, no evolution)
            532: 'common',   // Timburr (uncommon, stage 1)
            533: 'uncommon', // Gurdurr (stage 2)
            534: 'rare',     // Conkeldurr (stage 3, trade)
            535: 'common',   // Tympole (common, stage 1)
            536: 'uncommon', // Palpitoad (stage 2)
            537: 'rare',     // Seismitoad (stage 3)
            538: 'uncommon', // Throh (uncommon, no evolution)
            539: 'uncommon', // Sawk (uncommon, no evolution)
            540: 'common',   // Sewaddle (common, stage 1)
            541: 'uncommon', // Swadloon (stage 2)
            542: 'rare',     // Leavanny (stage 3)
            543: 'common',   // Venipede (common, stage 1)
            544: 'uncommon', // Whirlipede (stage 2)
            545: 'rare',     // Scolipede (stage 3)
            546: 'common',   // Cottonee (common, stage 1)
            547: 'uncommon', // Whimsicott (stage 2)
            548: 'common',   // Petilil (common, stage 1)
            549: 'uncommon', // Lilligant (stage 2)
            550: 'uncommon', // Basculin (uncommon, no evolution)
            551: 'common',   // Sandile (uncommon, stage 1)
            552: 'uncommon', // Krokorok (stage 2)
            553: 'rare',     // Krookodile (stage 3)
            554: 'common',   // Darumaka (uncommon, stage 1)
            555: 'uncommon', // Darmanitan (stage 2)
            556: 'uncommon', // Maractus (uncommon, no evolution)
            557: 'common',   // Dwebble (common, stage 1)
            558: 'uncommon', // Crustle (stage 2)
            559: 'common',   // Scraggy (uncommon, stage 1)
            560: 'uncommon', // Scrafty (stage 2)
            561: 'uncommon', // Sigilyph (rare encounter, no evolution)
            562: 'common',   // Yamask (uncommon, stage 1)
            563: 'uncommon', // Cofagrigus (stage 2)
            564: 'common',   // Tirtouga (fossil, stage 1)
            565: 'uncommon', // Carracosta (stage 2)
            566: 'common',   // Archen (fossil, stage 1)
            567: 'uncommon', // Archeops (stage 2)
            568: 'common',   // Trubbish (common, stage 1)
            569: 'uncommon', // Garbodor (stage 2)
            570: 'common',   // Zorua (rare but stage 1)
            571: 'uncommon', // Zoroark (stage 2)
            572: 'common',   // Minccino (common, stage 1)
            573: 'uncommon', // Cinccino (stage 2)
            574: 'common',   // Gothita (uncommon, stage 1)
            575: 'uncommon', // Gothorita (stage 2)
            576: 'rare',     // Gothitelle (stage 3)
            577: 'common',   // Solosis (uncommon, stage 1)
            578: 'uncommon', // Duosion (stage 2)
            579: 'rare',     // Reuniclus (stage 3)
            580: 'common',   // Ducklett (common, stage 1)
            581: 'uncommon', // Swanna (stage 2)
            582: 'common',   // Vanillite (common, stage 1)
            583: 'uncommon', // Vanillish (stage 2)
            584: 'rare',     // Vanilluxe (stage 3)
            585: 'common',   // Deerling (common, stage 1)
            586: 'uncommon', // Sawsbuck (stage 2)
            587: 'uncommon', // Emolga (uncommon, no evolution)
            588: 'common',   // Karrablast (uncommon, stage 1)
            589: 'uncommon', // Escavalier (stage 2, trade)
            590: 'common',   // Foongus (common, stage 1)
            591: 'uncommon', // Amoonguss (stage 2)
            592: 'common',   // Frillish (uncommon, stage 1)
            593: 'uncommon', // Jellicent (stage 2)
            594: 'uncommon', // Alomomola (uncommon, no evolution)
            595: 'common',   // Joltik (common, stage 1)
            596: 'uncommon', // Galvantula (stage 2)
            597: 'common',   // Ferroseed (uncommon, stage 1)
            598: 'uncommon', // Ferrothorn (stage 2)
            599: 'common',   // Klink (uncommon, stage 1)
            600: 'uncommon', // Klang (stage 2)
            601: 'rare',     // Klinklang (stage 3)
            602: 'common',   // Tynamo (uncommon, stage 1)
            603: 'uncommon', // Eelektrik (stage 2)
            604: 'rare',     // Eelektross (stage 3)
            605: 'common',   // Elgyem (uncommon, stage 1)
            606: 'uncommon', // Beheeyem (stage 2)
            607: 'common',   // Litwick (uncommon, stage 1)
            608: 'uncommon', // Lampent (stage 2)
            609: 'rare',     // Chandelure (stage 3)
            610: 'common',   // Axew (rare but stage 1)
            611: 'uncommon', // Fraxure (stage 2)
            612: 'rare',     // Haxorus (stage 3)
            613: 'common',   // Cubchoo (uncommon, stage 1)
            614: 'uncommon', // Beartic (stage 2)
            615: 'uncommon', // Cryogonal (rare encounter, no evolution)
            616: 'common',   // Shelmet (uncommon, stage 1)
            617: 'uncommon', // Accelgor (stage 2, trade)
            618: 'uncommon', // Stunfisk (uncommon, no evolution)
            619: 'common',   // Mienfoo (uncommon, stage 1)
            620: 'uncommon', // Mienshao (stage 2)
            621: 'uncommon', // Druddigon (rare encounter, no evolution)
            622: 'common',   // Golett (uncommon, stage 1)
            623: 'uncommon', // Golurk (stage 2)
            624: 'common',   // Pawniard (uncommon, stage 1)
            625: 'uncommon', // Bisharp (stage 2)
            626: 'uncommon', // Bouffalant (uncommon, no evolution)
            627: 'common',   // Rufflet (uncommon, stage 1)
            628: 'uncommon', // Braviary (stage 2)
            629: 'common',   // Vullaby (uncommon, stage 1)
            630: 'uncommon', // Mandibuzz (stage 2)
            631: 'uncommon', // Heatmor (uncommon, no evolution)
            632: 'uncommon', // Durant (uncommon, no evolution)
            633: 'common',   // Deino (rare but stage 1)
            634: 'uncommon', // Zweilous (stage 2)
            635: 'rare',     // Hydreigon (pseudo-legendary)
            636: 'common',   // Larvesta (very rare but stage 1)
            637: 'uncommon', // Volcarona (stage 2, pseudo-legendary stats)
            638: 'legendary', // Cobalion
            639: 'legendary', // Terrakion
            640: 'legendary', // Virizion
            641: 'legendary', // Tornadus
            642: 'legendary', // Thundurus
            643: 'legendary', // Reshiram
            644: 'legendary', // Zekrom
            645: 'legendary', // Landorus
            646: 'legendary', // Kyurem
            647: 'legendary', // Keldeo
            648: 'legendary', // Meloetta
            649: 'legendary', // Genesect

            // GEN 6 (650-721)
            650: 'common',   // Chespin (starter base)
            651: 'uncommon', // Quilladin (starter mid)
            652: 'rare',     // Chesnaught (starter final)
            653: 'common',   // Fennekin (starter base)
            654: 'uncommon', // Braixen (starter mid)
            655: 'rare',     // Delphox (starter final)
            656: 'common',   // Froakie (starter base)
            657: 'uncommon', // Frogadier (starter mid)
            658: 'rare',     // Greninja (starter final)
            659: 'common',   // Bunnelby (common, stage 1)
            660: 'uncommon', // Diggersby (stage 2)
            661: 'common',   // Fletchling (common, stage 1)
            662: 'uncommon', // Fletchinder (stage 2)
            663: 'rare',     // Talonflame (stage 3)
            664: 'common',   // Scatterbug (common, stage 1)
            665: 'uncommon', // Spewpa (stage 2)
            666: 'rare',     // Vivillon (stage 3)
            667: 'common',   // Litleo (uncommon, stage 1)
            668: 'uncommon', // Pyroar (stage 2)
            669: 'common',   // Flab√©b√© (uncommon, stage 1)
            670: 'uncommon', // Floette (stage 2)
            671: 'rare',     // Florges (stage 3)
            672: 'common',   // Skiddo (uncommon, stage 1)
            673: 'uncommon', // Gogoat (stage 2)
            674: 'common',   // Pancham (uncommon, stage 1)
            675: 'uncommon', // Pangoro (stage 2)
            676: 'uncommon', // Furfrou (uncommon, no evolution)
            677: 'common',   // Espurr (uncommon, stage 1)
            678: 'uncommon', // Meowstic (stage 2)
            679: 'common',   // Honedge (uncommon, stage 1)
            680: 'uncommon', // Doublade (stage 2)
            681: 'rare',     // Aegislash (stage 3)
            682: 'common',   // Spritzee (uncommon, stage 1)
            683: 'uncommon', // Aromatisse (stage 2)
            684: 'common',   // Swirlix (uncommon, stage 1)
            685: 'uncommon', // Slurpuff (stage 2)
            686: 'common',   // Inkay (uncommon, stage 1)
            687: 'uncommon', // Malamar (stage 2)
            688: 'common',   // Binacle (uncommon, stage 1)
            689: 'uncommon', // Barbaracle (stage 2)
            690: 'common',   // Skrelp (uncommon, stage 1)
            691: 'uncommon', // Dragalge (stage 2)
            692: 'common',   // Clauncher (uncommon, stage 1)
            693: 'uncommon', // Clawitzer (stage 2)
            694: 'common',   // Helioptile (uncommon, stage 1)
            695: 'uncommon', // Heliolisk (stage 2)
            696: 'common',   // Tyrunt (fossil, stage 1)
            697: 'uncommon', // Tyrantrum (stage 2)
            698: 'common',   // Amaura (fossil, stage 1)
            699: 'uncommon', // Aurorus (stage 2)
            700: 'uncommon', // Sylveon (Eevee evolution)
            701: 'uncommon', // Hawlucha (uncommon, no evolution)
            702: 'uncommon', // Dedenne (uncommon, no evolution)
            703: 'uncommon', // Carbink (rare encounter, no evolution)
            704: 'common',   // Goomy (uncommon, stage 1)
            705: 'uncommon', // Sliggoo (stage 2)
            706: 'rare',     // Goodra (pseudo-legendary)
            707: 'uncommon', // Klefki (uncommon, no evolution)
            708: 'common',   // Phantump (uncommon, stage 1)
            709: 'uncommon', // Trevenant (stage 2)
            710: 'common',   // Pumpkaboo (uncommon, stage 1)
            711: 'uncommon', // Gourgeist (stage 2)
            712: 'common',   // Bergmite (uncommon, stage 1)
            713: 'uncommon', // Avalugg (stage 2)
            714: 'common',   // Noibat (rare but stage 1)
            715: 'uncommon', // Noivern (stage 2)
            716: 'legendary', // Xerneas
            717: 'legendary', // Yveltal
            718: 'legendary', // Zygarde
            719: 'legendary', // Diancie
            720: 'legendary', // Hoopa
            721: 'legendary', // Volcanion

            // GEN 7 (722-809)
            722: 'common',   // Rowlet (starter base)
            723: 'uncommon', // Dartrix (starter mid)
            724: 'rare',     // Decidueye (starter final)
            725: 'common',   // Litten (starter base)
            726: 'uncommon', // Torracat (starter mid)
            727: 'rare',     // Incineroar (starter final)
            728: 'common',   // Popplio (starter base)
            729: 'uncommon', // Brionne (starter mid)
            730: 'rare',     // Primarina (starter final)
            731: 'common',   // Pikipek (common, stage 1)
            732: 'uncommon', // Trumbeak (stage 2)
            733: 'rare',     // Toucannon (stage 3)
            734: 'common',   // Yungoos (very common, stage 1)
            735: 'uncommon', // Gumshoos (stage 2)
            736: 'common',   // Grubbin (common, stage 1)
            737: 'uncommon', // Charjabug (stage 2)
            738: 'rare',     // Vikavolt (stage 3)
            739: 'common',   // Crabrawler (uncommon, stage 1)
            740: 'uncommon', // Crabominable (stage 2)
            741: 'uncommon', // Oricorio (uncommon, no evolution)
            742: 'common',   // Cutiefly (common, stage 1)
            743: 'uncommon', // Ribombee (stage 2)
            744: 'common',   // Rockruff (uncommon, stage 1)
            745: 'uncommon', // Lycanroc (stage 2)
            746: 'common',   // Wishiwashi (uncommon, no evolution)
            747: 'common',   // Mareanie (uncommon, stage 1)
            748: 'uncommon', // Toxapex (stage 2)
            749: 'common',   // Mudbray (common, stage 1)
            750: 'uncommon', // Mudsdale (stage 2)
            751: 'common',   // Dewpider (common, stage 1)
            752: 'uncommon', // Araquanid (stage 2)
            753: 'common',   // Fomantis (uncommon, stage 1)
            754: 'uncommon', // Lurantis (stage 2)
            755: 'common',   // Morelull (uncommon, stage 1)
            756: 'uncommon', // Shiinotic (stage 2)
            757: 'common',   // Salandit (uncommon, stage 1)
            758: 'uncommon', // Salazzle (stage 2)
            759: 'common',   // Stufful (common, stage 1)
            760: 'uncommon', // Bewear (stage 2)
            761: 'common',   // Bounsweet (common, stage 1)
            762: 'uncommon', // Steenee (stage 2)
            763: 'rare',     // Tsareena (stage 3)
            764: 'uncommon', // Comfey (uncommon, no evolution)
            765: 'uncommon', // Oranguru (rare encounter, no evolution)
            766: 'uncommon', // Passimian (rare encounter, no evolution)
            767: 'common',   // Wimpod (uncommon, stage 1)
            768: 'uncommon', // Golisopod (stage 2)
            769: 'common',   // Sandygast (uncommon, stage 1)
            770: 'uncommon', // Palossand (stage 2)
            771: 'uncommon', // Pyukumuku (uncommon, no evolution)
            772: 'legendary', // Type: Null
            773: 'legendary', // Silvally
            774: 'uncommon', // Minior (rare encounter, no evolution)
            775: 'uncommon', // Komala (uncommon, no evolution)
            776: 'uncommon', // Turtonator (rare encounter, no evolution)
            777: 'uncommon', // Togedemaru (uncommon, no evolution)
            778: 'uncommon', // Mimikyu (rare encounter, no evolution)
            779: 'uncommon', // Bruxish (uncommon, no evolution)
            780: 'uncommon', // Drampa (rare encounter, no evolution)
            781: 'uncommon', // Dhelmise (rare encounter, no evolution)
            782: 'common',   // Jangmo-o (rare but stage 1)
            783: 'uncommon', // Hakamo-o (stage 2)
            784: 'rare',     // Kommo-o (pseudo-legendary)
            785: 'legendary', // Tapu Koko
            786: 'legendary', // Tapu Lele
            787: 'legendary', // Tapu Bulu
            788: 'legendary', // Tapu Fini
            789: 'legendary', // Cosmog
            790: 'legendary', // Cosmoem
            791: 'legendary', // Solgaleo
            792: 'legendary', // Lunala
            793: 'epic',     // Nihilego (Ultra Beast)
            794: 'epic',     // Buzzwole (Ultra Beast)
            795: 'epic',     // Pheromosa (Ultra Beast)
            796: 'epic',     // Xurkitree (Ultra Beast)
            797: 'epic',     // Celesteela (Ultra Beast)
            798: 'epic',     // Kartana (Ultra Beast)
            799: 'epic',     // Guzzlord (Ultra Beast)
            800: 'legendary', // Necrozma
            801: 'legendary', // Magearna
            802: 'legendary', // Marshadow
            803: 'epic',     // Poipole (Ultra Beast)
            804: 'epic',     // Naganadel (Ultra Beast)
            805: 'epic',     // Stakataka (Ultra Beast)
            806: 'epic',     // Blacephalon (Ultra Beast)
            807: 'legendary', // Zeraora
            808: 'legendary', // Meltan
            809: 'legendary', // Melmetal

            // GEN 8 (810-898)
            810: 'common',   // Grookey (starter base)
            811: 'uncommon', // Thwackey (starter mid)
            812: 'rare',     // Rillaboom (starter final)
            813: 'common',   // Scorbunny (starter base)
            814: 'uncommon', // Raboot (starter mid)
            815: 'rare',     // Cinderace (starter final)
            816: 'common',   // Sobble (starter base)
            817: 'uncommon', // Drizzile (starter mid)
            818: 'rare',     // Inteleon (starter final)
            819: 'common',   // Skwovet (common, stage 1)
            820: 'uncommon', // Greedent (stage 2)
            821: 'common',   // Rookidee (common, stage 1)
            822: 'uncommon', // Corvisquire (stage 2)
            823: 'rare',     // Corviknight (stage 3)
            824: 'common',   // Blipbug (common, stage 1)
            825: 'uncommon', // Dottler (stage 2)
            826: 'rare',     // Orbeetle (stage 3)
            827: 'common',   // Nickit (common, stage 1)
            828: 'uncommon', // Thievul (stage 2)
            829: 'common',   // Gossifleur (common, stage 1)
            830: 'uncommon', // Eldegoss (stage 2)
            831: 'common',   // Wooloo (common, stage 1)
            832: 'uncommon', // Dubwool (stage 2)
            833: 'common',   // Chewtle (common, stage 1)
            834: 'uncommon', // Drednaw (stage 2)
            835: 'common',   // Yamper (common, stage 1)
            836: 'uncommon', // Boltund (stage 2)
            837: 'common',   // Rolycoly (common, stage 1)
            838: 'uncommon', // Carkol (stage 2)
            839: 'rare',     // Coalossal (stage 3)
            840: 'common',   // Applin (uncommon, stage 1)
            841: 'uncommon', // Flapple (stage 2)
            842: 'uncommon', // Appletun (stage 2)
            843: 'common',   // Silicobra (uncommon, stage 1)
            844: 'uncommon', // Sandaconda (stage 2)
            845: 'uncommon', // Cramorant (uncommon, no evolution)
            846: 'common',   // Arrokuda (common, stage 1)
            847: 'uncommon', // Barraskewda (stage 2)
            848: 'uncommon', // Toxel (uncommon, stage 1)
            849: 'uncommon', // Toxtricity (stage 2)
            850: 'common',   // Sizzlipede (common, stage 1)
            851: 'uncommon', // Centiskorch (stage 2)
            852: 'common',   // Clobbopus (uncommon, stage 1)
            853: 'uncommon', // Grapploct (stage 2)
            854: 'uncommon', // Sinistea (uncommon, stage 1)
            855: 'uncommon', // Polteageist (stage 2)
            856: 'common',   // Hatenna (uncommon, stage 1)
            857: 'uncommon', // Hattrem (stage 2)
            858: 'rare',     // Hatterene (stage 3)
            859: 'common',   // Impidimp (uncommon, stage 1)
            860: 'uncommon', // Morgrem (stage 2)
            861: 'rare',     // Grimmsnarl (stage 3)
            862: 'rare',     // Obstagoon (stage 3 from Linoone)
            863: 'uncommon', // Perrserker (alternate stage 2 from Meowth)
            864: 'uncommon', // Cursola (alternate stage 2 from Corsola)
            865: 'uncommon', // Sirfetch'd (alternate stage 2 from Farfetch'd)
            866: 'uncommon', // Mr. Rime (stage 3 from Mr. Mime)
            867: 'uncommon', // Runerigus (alternate stage 2 from Yamask)
            868: 'uncommon', // Milcery (uncommon, stage 1)
            869: 'uncommon', // Alcremie (stage 2)
            870: 'uncommon', // Falinks (uncommon, no evolution)
            871: 'uncommon', // Pincurchin (uncommon, no evolution)
            872: 'common',   // Snom (uncommon, stage 1)
            873: 'uncommon', // Frosmoth (stage 2)
            874: 'uncommon', // Stonjourner (uncommon, no evolution)
            875: 'uncommon', // Eiscue (uncommon, no evolution)
            876: 'uncommon', // Indeedee (uncommon, no evolution)
            877: 'uncommon', // Morpeko (uncommon, no evolution)
            878: 'common',   // Cufant (uncommon, stage 1)
            879: 'uncommon', // Copperajah (stage 2)
            880: 'epic',     // Dracozolt (fossil fusion, rare)
            881: 'epic',     // Arctozolt (fossil fusion, rare)
            882: 'epic',     // Dracovish (fossil fusion, rare)
            883: 'epic',     // Arctovish (fossil fusion, rare)
            884: 'rare',     // Duraludon (rare encounter, stage 1)
            885: 'common',   // Dreepy (rare but stage 1)
            886: 'uncommon', // Drakloak (stage 2)
            887: 'rare',     // Dragapult (pseudo-legendary)
            888: 'legendary', // Zacian
            889: 'legendary', // Zamazenta
            890: 'legendary', // Eternatus
            891: 'legendary', // Kubfu
            892: 'legendary', // Urshifu
            893: 'legendary', // Zarude
            894: 'legendary', // Regieleki
            895: 'legendary', // Regidrago
            896: 'legendary', // Glastrier
            897: 'legendary', // Spectrier
            898: 'legendary'  // Calyrex
        };

        function getPokemonRarity(id) {
            return POKEMON_RARITY_MAP[id] || 'common';
        }

        // Precompute ID lists per rarity for fast selection
        const POKEMON_IDS_BY_RARITY = Object.keys(POKEMON_RARITY_MAP).reduce((acc, idStr) => {
            const id = Number(idStr);
            const rarity = POKEMON_RARITY_MAP[id];
            if (!acc[rarity]) acc[rarity] = [];
            acc[rarity].push(id);
            return acc;
        }, {});

        // Defensive fallback if any tier is missing
        ['common', 'uncommon', 'rare', 'epic', 'legendary'].forEach(t => {
            if (!POKEMON_IDS_BY_RARITY[t]) POKEMON_IDS_BY_RARITY[t] = [];
        });

        const RARITY_TIERS = {
            common:    { name: 'Common',    color: 'gray',   chance: 0.50 },
            uncommon:  { name: 'Uncommon',  color: 'green',  chance: 0.30 },
            rare:      { name: 'Rare',      color: 'blue',   chance: 0.15 },
            epic:      { name: 'Epic',      color: 'purple', chance: 0.04 },
            legendary: { name: 'Legendary', color: 'orange', chance: 0.01 }
        };

        // ========================================
        // üé¥ POKEBALL IMAGE (Inline SVG for reliability)
        // ========================================
        const PokeballIcon = ({ size = 20, className = "", failed = false }) => (
            <svg 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                className={className}
                style={{ imageRendering: 'pixelated' }}
            >
                {/* Bottom half (white) - always visible */}
                <defs>
                    <clipPath id="bottomHalf">
                        <rect x="0" y="12" width="24" height="12"/>
                    </clipPath>
                </defs>
                
                {/* Bottom white half */}
                <g clipPath="url(#bottomHalf)">
                    <circle cx="12" cy="12" r="11" fill="#fff" stroke="#000" strokeWidth="1"/>
                    <circle cx="12" cy="12" r="10" fill="#fff"/>
                </g>
                
                {/* Black center line */}
                <path d="M 2 12 L 22 12" stroke="#000" strokeWidth="2"/>
                
                {/* Center button (always visible) */}
                <circle cx="12" cy="12" r="3" fill="#fff" stroke="#000" strokeWidth="1.5"/>
                <circle cx="12" cy="12" r="2" fill="#fff"/>
                
                {/* Top half (red) - animatable */}
                <g 
                    className={failed ? "pokeball-top-failed" : ""}
                    style={{ transformOrigin: '12px 12px' }}
                >
                    <defs>
                        <clipPath id="topHalf">
                            <rect x="0" y="0" width="24" height="12"/>
                        </clipPath>
                    </defs>
                    <g clipPath="url(#topHalf)">
                        <circle cx="12" cy="12" r="11" fill="#f00" stroke="#000" strokeWidth="1"/>
                        <circle cx="12" cy="12" r="10" fill="#f00"/>
                        <circle cx="12" cy="12" r="6" fill="#c00"/>
                        {/* Top highlight */}
                        <rect x="11" y="1" width="2" height="3" fill="#fff"/>
                    </g>
                </g>
            </svg>
        );

        // ========================================
        // üì∏ ACTIVITY CARD STACK COMPONENT
        // ========================================
        const ActivityCardStack = ({ activities, onGiveCandy, currentUserId }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [dragState, setDragState] = useState({ x: 0, y: 0, rotation: 0, isDragging: false });
            const [touchStart, setTouchStart] = useState(null);
            const cardRef = React.useRef(null);

            const currentActivity = activities[currentIndex];
            const progress = `${currentIndex + 1} / ${activities.length}`;

            // Handle touch start
            const handleTouchStart = (e) => {
                const touch = e.touches[0];
                setTouchStart({ x: touch.clientX, y: touch.clientY });
                setDragState(prev => ({ ...prev, isDragging: true }));
            };

            // Handle touch move
            const handleTouchMove = (e) => {
                if (!touchStart) return;
                const touch = e.touches[0];
                const deltaX = touch.clientX - touchStart.x;
                const deltaY = touch.clientY - touchStart.y;
                const rotation = deltaX * 0.1; // Rotation based on horizontal drag

                setDragState({
                    x: deltaX,
                    y: deltaY,
                    rotation: rotation,
                    isDragging: true
                });
            };

            // Handle touch end
            const handleTouchEnd = () => {
                const threshold = 100;
                const fastSwipeThreshold = 50;
                const velocity = Math.abs(dragState.x);

                // Fast swipe or threshold reached
                if (velocity > fastSwipeThreshold || Math.abs(dragState.x) > threshold) {
                    if (dragState.x > 0) {
                        // Swiped right - go to previous
                        goToPrevious();
                    } else {
                        // Swiped left - go to next
                        goToNext();
                    }
                } else {
                    // Spring back to center
                    setDragState({ x: 0, y: 0, rotation: 0, isDragging: false });
                }
                setTouchStart(null);
            };

            // Navigation functions
            const goToNext = () => {
                if (currentIndex < activities.length - 1) {
                    // Animate out to left
                    setDragState({ x: -500, y: 0, rotation: -30, isDragging: false });
                    setTimeout(() => {
                        setCurrentIndex(prev => prev + 1);
                        setDragState({ x: 0, y: 0, rotation: 0, isDragging: false });
                    }, 300);
                } else {
                    // Bounce at the end
                    setDragState({ x: 0, y: 0, rotation: 0, isDragging: false });
                }
            };

            const goToPrevious = () => {
                if (currentIndex > 0) {
                    // Animate out to right
                    setDragState({ x: 500, y: 0, rotation: 30, isDragging: false });
                    setTimeout(() => {
                        setCurrentIndex(prev => prev - 1);
                        setDragState({ x: 0, y: 0, rotation: 0, isDragging: false });
                    }, 300);
                } else {
                    // Bounce at the start
                    setDragState({ x: 0, y: 0, rotation: 0, isDragging: false });
                }
            };

            // Keyboard controls
            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowLeft') goToPrevious();
                    if (e.key === 'ArrowRight') goToNext();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentIndex]);

            if (!currentActivity) return null;

            return (
                <div className="flex-1 flex flex-col items-center justify-center p-4 relative">
                    {/* Progress Dots */}
                    <div className="absolute top-4 left-0 right-0 flex justify-center gap-2 z-20">
                        {activities.map((_, index) => (
                            <div
                                key={index}
                                className={`w-2 h-2 rounded-full transition-all ${
                                    index === currentIndex 
                                        ? 'bg-white w-8' 
                                        : index < currentIndex 
                                        ? 'bg-white bg-opacity-50' 
                                        : 'bg-white bg-opacity-20'
                                }`}
                            />
                        ))}
                    </div>

                    {/* Card Counter */}
                    <div className="absolute top-12 left-0 right-0 text-center z-20">
                        <div className="text-white text-sm font-medium opacity-75">{progress}</div>
                    </div>

                    {/* Background Cards (for depth effect) */}
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        {[2, 1].map(offset => {
                            const index = currentIndex + offset;
                            if (index >= activities.length) return null;
                            const activity = activities[index];
                            return (
                                <div
                                    key={index}
                                    className="absolute"
                                    style={{
                                        transform: `scale(${1 - offset * 0.05}) translateY(${offset * 10}px)`,
                                        opacity: 0.3 - offset * 0.1,
                                        zIndex: -offset
                                    }}
                                >
                                    <ActivityCard 
                                        activity={activity}
                                        onGiveCandy={onGiveCandy}
                                        currentUserId={currentUserId}
                                        isInteractive={false}
                                    />
                                </div>
                            );
                        })}
                    </div>

                    {/* Main Card */}
                    <div
                        ref={cardRef}
                        className="relative z-10 cursor-grab active:cursor-grabbing"
                        style={{
                            transform: `translateX(${dragState.x}px) translateY(${dragState.y}px) rotate(${dragState.rotation}deg)`,
                            transition: dragState.isDragging ? 'none' : 'transform 0.3s ease-out'
                        }}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                    >
                        <ActivityCard 
                            activity={currentActivity}
                            onGiveCandy={onGiveCandy}
                            currentUserId={currentUserId}
                            isInteractive={true}
                        />
                    </div>

                    {/* Navigation Buttons */}
                    <div className="absolute bottom-8 left-0 right-0 flex justify-center gap-4 z-20">
                        <button
                            onClick={goToPrevious}
                            disabled={currentIndex === 0}
                            className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold shadow-lg transition ${
                                currentIndex === 0 
                                    ? 'bg-gray-400 text-gray-600 opacity-50 cursor-not-allowed' 
                                    : 'bg-white text-purple-600 hover:bg-gray-100'
                            }`}
                        >
                            ‚Üê
                        </button>
                        <button
                            onClick={goToNext}
                            disabled={currentIndex === activities.length - 1}
                            className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold shadow-lg transition ${
                                currentIndex === activities.length - 1 
                                    ? 'bg-gray-400 text-gray-600 opacity-50 cursor-not-allowed' 
                                    : 'bg-white text-purple-600 hover:bg-gray-100'
                            }`}
                        >
                            ‚Üí
                        </button>
                    </div>

                    {/* Swipe Hint (show on first card) */}
                    {currentIndex === 0 && (
                        <div className="absolute bottom-32 left-0 right-0 text-center z-20 animate-pulse">
                            <div className="text-white text-sm font-medium">
                                ‚Üê Swipe or tap arrows ‚Üí
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ========================================
        // üì∏ ACTIVITY CARD COMPONENT
        // ========================================
        const ActivityCard = ({ activity, onGiveCandy, currentUserId, isInteractive }) => {
            const [cardImageUrl, setCardImageUrl] = useState(null);
            const [isLoadingCard, setIsLoadingCard] = useState(true);
            const [hasGivenCandy, setHasGivenCandy] = useState(false);
            const [candyCount, setCandyCount] = useState(0);
            const canvasRef = React.useRef(null);

            // Check if current user has already given candy - USE ACTIVITY ID AS KEY
            React.useEffect(() => {
                // Reset state when activity changes
                setHasGivenCandy(false);
                setCandyCount(0);
                
                if (activity && activity.candyGivers && currentUserId) {
                    const userGaveCandy = activity.candyGivers[currentUserId] === true;
                    setHasGivenCandy(userGaveCandy);
                }
                if (activity) {
                    setCandyCount(activity.candyCount || 0);
                }
            }, [activity?.id, currentUserId]); // Use activity?.id to properly detect changes

            // Generate card image
            React.useEffect(() => {
                const generateCard = async () => {
                    setIsLoadingCard(true);
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = 1080;
                        canvas.height = 1080;
                        const ctx = canvas.getContext('2d');

                        // Helper function to draw stars (reusing existing logic)
                        const drawStar = (ctx, cx, cy, spikes, outerRadius, innerRadius) => {
                            let rot = Math.PI / 2 * 3;
                            let x = cx;
                            let y = cy;
                            const step = Math.PI / spikes;

                            ctx.beginPath();
                            ctx.moveTo(cx, cy - outerRadius);
                            
                            for (let i = 0; i < spikes; i++) {
                                x = cx + Math.cos(rot) * outerRadius;
                                y = cy + Math.sin(rot) * outerRadius;
                                ctx.lineTo(x, y);
                                rot += step;

                                x = cx + Math.cos(rot) * innerRadius;
                                y = cy + Math.sin(rot) * innerRadius;
                                ctx.lineTo(x, y);
                                rot += step;
                            }
                            
                            ctx.lineTo(cx, cy - outerRadius);
                            ctx.closePath();
                            ctx.fill();
                        };

                        // Helper function to draw rarity icons (reusing existing logic)
                        const drawRarityIcon = (ctx, x, y, size, tier) => {
                            ctx.save();
                            
                            switch(tier) {
                                case 'common':
                                    ctx.fillStyle = '#6B7280';
                                    ctx.beginPath();
                                    ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
                                    ctx.fill();
                                    ctx.strokeStyle = '#FFFFFF';
                                    ctx.lineWidth = 3;
                                    ctx.stroke();
                                    break;
                                case 'uncommon':
                                    ctx.fillStyle = '#10B981';
                                    ctx.beginPath();
                                    ctx.moveTo(x + size/2, y);
                                    ctx.lineTo(x + size, y + size/2);
                                    ctx.lineTo(x + size/2, y + size);
                                    ctx.lineTo(x, y + size/2);
                                    ctx.closePath();
                                    ctx.fill();
                                    ctx.strokeStyle = '#FFFFFF';
                                    ctx.lineWidth = 3;
                                    ctx.stroke();
                                    break;
                                case 'rare':
                                    ctx.fillStyle = '#3B82F6';
                                    drawStar(ctx, x + size/2, y + size/2, 5, size/2, size/4);
                                    ctx.strokeStyle = '#FFFFFF';
                                    ctx.lineWidth = 3;
                                    ctx.stroke();
                                    break;
                                case 'epic':
                                    ctx.fillStyle = '#8B5CF6';
                                    ctx.globalAlpha = 0.7;
                                    drawStar(ctx, x + size/2 - 8, y + size/2, 5, size/2.2, size/4.4);
                                    ctx.globalAlpha = 1;
                                    drawStar(ctx, x + size/2 + 8, y + size/2, 5, size/2.2, size/4.4);
                                    ctx.strokeStyle = '#FFFFFF';
                                    ctx.lineWidth = 2;
                                    ctx.stroke();
                                    break;
                                case 'legendary':
                                    ctx.fillStyle = '#F59E0B';
                                    drawStar(ctx, x + size/2, y + size/3, 5, size/2.5, size/5);
                                    drawStar(ctx, x + size/4, y + size*2/3, 5, size/3, size/6);
                                    drawStar(ctx, x + size*3/4, y + size*2/3, 5, size/3, size/6);
                                    ctx.strokeStyle = '#FFFFFF';
                                    ctx.lineWidth = 2;
                                    ctx.stroke();
                                    break;
                            }
                            
                            ctx.restore();
                        };

                        // Light gray background (like starter cards)
                        ctx.fillStyle = '#F3F4F6'; // gray-100
                        ctx.fillRect(0, 0, 1080, 1080);

                        // Draw rarity icon at very top with more space
                        const iconSize = 70;
                        const iconX = 540 - iconSize / 2;
                        const iconY = 25;
                        drawRarityIcon(ctx, iconX, iconY, iconSize, activity.rarity);

                        // Pokemon name below icon - moved down to prevent touching
                        ctx.fillStyle = '#1F2937';
                        ctx.font = 'bold 56px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(activity.pokemonName.toUpperCase(), 540, 150); // Was 130, now 150
                        ctx.textAlign = 'left';

                        // Load and draw Pokemon sprite first
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.src = activity.spriteUrl;
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = reject;
                        });

                        // Draw sprite (centered, good size)
                        const spriteSize = 450;
                        const spriteY = 200;
                        ctx.drawImage(img, (1080 - spriteSize) / 2, spriteY, spriteSize, spriteSize);

                        // Rarity badge colors
                        const rarityColors = {
                            legendary: '#F59E0B',
                            epic: '#A855F7',
                            rare: '#3B82F6',
                            uncommon: '#10B981',
                            common: '#9CA3AF'
                        };

                        // Rarity badge below sprite - moved up
                        const rarityBadgeY = spriteY + spriteSize + 30; // Was +50, now +30
                        const rarityBadgeWidth = 380;
                        const rarityBadgeHeight = 90;
                        const rarityBadgeX = (1080 - rarityBadgeWidth) / 2;
                        
                        const radius = 16;
                        ctx.fillStyle = rarityColors[activity.rarity] || rarityColors.common;
                        ctx.beginPath();
                        ctx.moveTo(rarityBadgeX + radius, rarityBadgeY);
                        ctx.lineTo(rarityBadgeX + rarityBadgeWidth - radius, rarityBadgeY);
                        ctx.quadraticCurveTo(rarityBadgeX + rarityBadgeWidth, rarityBadgeY, rarityBadgeX + rarityBadgeWidth, rarityBadgeY + radius);
                        ctx.lineTo(rarityBadgeX + rarityBadgeWidth, rarityBadgeY + rarityBadgeHeight - radius);
                        ctx.quadraticCurveTo(rarityBadgeX + rarityBadgeWidth, rarityBadgeY + rarityBadgeHeight, rarityBadgeX + rarityBadgeWidth - radius, rarityBadgeY + rarityBadgeHeight);
                        ctx.lineTo(rarityBadgeX + radius, rarityBadgeY + rarityBadgeHeight);
                        ctx.quadraticCurveTo(rarityBadgeX, rarityBadgeY + rarityBadgeHeight, rarityBadgeX, rarityBadgeY + rarityBadgeHeight - radius);
                        ctx.lineTo(rarityBadgeX, rarityBadgeY + radius);
                        ctx.quadraticCurveTo(rarityBadgeX, rarityBadgeY, rarityBadgeX + radius, rarityBadgeY);
                        ctx.closePath();
                        ctx.fill();
                        
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 52px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(activity.rarity.toUpperCase(), 540, rarityBadgeY + 62);
                        ctx.textAlign = 'left';

                        // Trainer badge below rarity - moved up
                        const trainerName = activity.trainerName || 'Trainer';
                        const trainerBadgeHeight = 45;
                        const trainerBadgeWidth = Math.max(190, trainerName.length * 13 + 40);
                        const trainerBadgeY = rarityBadgeY + rarityBadgeHeight + 15; // Was +25, now +15
                        const trainerBadgeX = (1080 - trainerBadgeWidth) / 2;
                        
                        ctx.fillStyle = '#000000';
                        ctx.beginPath();
                        ctx.moveTo(trainerBadgeX + radius, trainerBadgeY);
                        ctx.lineTo(trainerBadgeX + trainerBadgeWidth - radius, trainerBadgeY);
                        ctx.quadraticCurveTo(trainerBadgeX + trainerBadgeWidth, trainerBadgeY, trainerBadgeX + trainerBadgeWidth, trainerBadgeY + radius);
                        ctx.lineTo(trainerBadgeX + trainerBadgeWidth, trainerBadgeY + trainerBadgeHeight - radius);
                        ctx.quadraticCurveTo(trainerBadgeX + trainerBadgeWidth, trainerBadgeY + trainerBadgeHeight, trainerBadgeX + trainerBadgeWidth - radius, trainerBadgeY + trainerBadgeHeight);
                        ctx.lineTo(trainerBadgeX + radius, trainerBadgeY + trainerBadgeHeight);
                        ctx.quadraticCurveTo(trainerBadgeX, trainerBadgeY + trainerBadgeHeight, trainerBadgeX, trainerBadgeY + trainerBadgeHeight - radius);
                        ctx.lineTo(trainerBadgeX, trainerBadgeY + radius);
                        ctx.quadraticCurveTo(trainerBadgeX, trainerBadgeY, trainerBadgeX + radius, trainerBadgeY);
                        ctx.closePath();
                        ctx.fill();
                        
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 26px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(trainerName, 540, trainerBadgeY + 30);

                        // Workout data below trainer badge - with units
                        const workoutDataY = trainerBadgeY + trainerBadgeHeight + 35;
                        ctx.fillStyle = '#4B5563';
                        ctx.font = '36px sans-serif';
                        ctx.textAlign = 'center';
                        
                        // Check if lift or cardio
                        const isLift = activity.pace === '--' || !activity.pace || activity.pace === 'undefined';
                        const statsText = isLift
                            ? `${activity.duration || '--'} min    ${activity.caloriesBurned || '--'} kcal    ${activity.avgHR || '--'} bpm`
                            : `${activity.pace} min/mi    ${activity.distance} mi    ${activity.duration}`;
                        
                        ctx.fillText(statsText, 540, workoutDataY);
                        ctx.textAlign = 'left';

                        // Shiny badge (if shiny) - small badge in top right corner
                        if (activity.isShiny) {
                            const shinySize = 70;
                            ctx.fillStyle = '#FCD34D'; // Yellow-300
                            ctx.beginPath();
                            ctx.arc(1000, 80, shinySize / 2, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.font = 'bold 42px sans-serif';
                            ctx.textAlign = 'center';
                            ctx.fillText('‚ú®', 1000, 92);
                            ctx.textAlign = 'left';
                        }

                        setCardImageUrl(canvas.toDataURL());
                        setIsLoadingCard(false);
                    } catch (error) {
                        console.error('Error generating card:', error);
                        setIsLoadingCard(false);
                    }
                };

                generateCard();
            }, [activity]);

            // Handle candy click - NOW WITH TOGGLE FUNCTIONALITY
            const handleCandyClick = async () => {
                if (!isInteractive || !activity.trainerId) return;
                
                try {
                    if (hasGivenCandy) {
                        // Remove candy (toggle off)
                        await onGiveCandy(activity.id, activity.trainerId, true); // Pass true for removal
                        setHasGivenCandy(false);
                        setCandyCount(prev => Math.max(0, prev - 1));
                    } else {
                        // Give candy
                        await onGiveCandy(activity.id, activity.trainerId, false);
                        setHasGivenCandy(true);
                        setCandyCount(prev => prev + 1);
                    }
                } catch (error) {
                    console.error('Error toggling candy:', error);
                }
            };

            return (
                <div className="relative w-full max-w-md aspect-square">
                    {/* Loading State */}
                    {isLoadingCard && (
                        <div className="absolute inset-0 flex items-center justify-center bg-gray-100 rounded-2xl border-4 border-purple-600">
                            <div className="loader"></div>
                        </div>
                    )}

                    {/* Card Image */}
                    {cardImageUrl && (
                        <div className="relative">
                            <img
                                src={cardImageUrl}
                                alt={activity.pokemonName}
                                className="w-full h-full object-cover rounded-2xl shadow-2xl"
                                style={{
                                    border: activity.isOwnCard 
                                        ? `4px solid ${activity.trainerBadgeColor}` 
                                        : '4px solid white'
                                }}
                            />

                            {/* Rare Candy Button (top-left) - Embossed/chiseled style with accumulated counter */}
                            {isInteractive && (
                                <button
                                    onClick={handleCandyClick}
                                    className={`absolute top-4 left-4 w-16 h-16 rounded-lg flex flex-col items-center justify-center transition-all ${
                                        hasGivenCandy 
                                            ? 'bg-gradient-to-br from-yellow-300 to-yellow-500 shadow-lg active:scale-95' 
                                            : 'bg-gray-300 shadow-inner active:scale-95'
                                    }`}
                                    style={{
                                        boxShadow: hasGivenCandy 
                                            ? '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                                            : 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.2)'
                                    }}
                                >
                                    <div 
                                        className="text-3xl transition-all"
                                        style={{
                                            filter: hasGivenCandy ? 'none' : 'grayscale(100%) opacity(0.4)',
                                            textShadow: hasGivenCandy ? 'none' : 'inset 0 2px 4px rgba(0,0,0,0.3)'
                                        }}
                                    >
                                        üç¨
                                    </div>
                                    {/* Show accumulated candy count */}
                                    <div className={`text-xs font-bold mt-0.5 ${hasGivenCandy ? 'text-gray-800' : 'text-gray-600'}`}>
                                        {candyCount}
                                    </div>
                                </button>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // ========================================
        // üé¥ POKEMON CARD COMPONENT (for PC, Starters, Activity Feed)
        // ========================================
        const PokemonCard = ({ pokemon, onClick, showDelete, onDelete, className = "" }) => {
            const canvasRef = useRef(null);
            const [cardImage, setCardImage] = useState(null);

            // Helper to draw rarity icon
            const drawRarityIcon = (ctx, x, y, size, tier) => {
                const drawStar = (ctx, cx, cy, spikes, outerRadius, innerRadius) => {
                    let rot = Math.PI / 2 * 3;
                    const step = Math.PI / spikes;
                    ctx.beginPath();
                    ctx.moveTo(cx, cy - outerRadius);
                    for (let i = 0; i < spikes; i++) {
                        let x = cx + Math.cos(rot) * outerRadius;
                        let y = cy + Math.sin(rot) * outerRadius;
                        ctx.lineTo(x, y);
                        rot += step;
                        x = cx + Math.cos(rot) * innerRadius;
                        y = cy + Math.sin(rot) * innerRadius;
                        ctx.lineTo(x, y);
                        rot += step;
                    }
                    ctx.lineTo(cx, cy - outerRadius);
                    ctx.closePath();
                    ctx.fill();
                };

                ctx.save();
                switch(tier) {
                    case 'common':
                        ctx.fillStyle = '#6B7280';
                        ctx.beginPath();
                        ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'uncommon':
                        ctx.fillStyle = '#10B981';
                        ctx.beginPath();
                        ctx.moveTo(x + size/2, y);
                        ctx.lineTo(x + size, y + size/2);
                        ctx.lineTo(x + size/2, y + size);
                        ctx.lineTo(x, y + size/2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'rare':
                        ctx.fillStyle = '#3B82F6';
                        drawStar(ctx, x + size/2, y + size/2, 5, size/2, size/4);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'epic':
                        ctx.fillStyle = '#8B5CF6';
                        ctx.globalAlpha = 0.7;
                        drawStar(ctx, x + size/2 - 6, y + size/2, 5, size/2.2, size/4.4);
                        ctx.globalAlpha = 1;
                        drawStar(ctx, x + size/2 + 6, y + size/2, 5, size/2.2, size/4.4);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 2.5;
                        ctx.stroke();
                        break;
                    case 'legendary':
                        ctx.fillStyle = '#F59E0B';
                        drawStar(ctx, x + size/2, y + size/3, 5, size/2.5, size/5);
                        drawStar(ctx, x + size/4, y + size*2/3, 5, size/3, size/6);
                        drawStar(ctx, x + size*3/4, y + size*2/3, 5, size/3, size/6);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 2.5;
                        ctx.stroke();
                        break;
                }
                ctx.restore();
            };

            useEffect(() => {
                const canvas = document.createElement('canvas');
                canvas.width = 400; // Higher resolution (was 200)
                canvas.height = 400;
                const ctx = canvas.getContext('2d');

                // Light gray background
                ctx.fillStyle = '#F3F4F6';
                ctx.fillRect(0, 0, 400, 400);

                // Pokemon name
                ctx.fillStyle = '#1F2937';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(pokemon.pokemonName.toUpperCase(), 200, 35);

                // Rarity icon at top
                const iconSize = 40;
                const iconX = 200 - iconSize / 2;
                const iconY = 45;
                drawRarityIcon(ctx, iconX, iconY, iconSize, pokemon.rarity);

                // Load sprite
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.src = pokemon.spriteUrl;
                img.onload = () => {
                    // Draw sprite
                    const spriteSize = 140;
                    const spriteX = (400 - spriteSize) / 2;
                    const spriteY = 105;
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(img, spriteX, spriteY, spriteSize, spriteSize);

                    // Rarity badge below sprite
                    const rarityColors = {
                        legendary: '#F59E0B',
                        epic: '#8B5CF6',
                        rare: '#3B82F6',
                        uncommon: '#10B981',
                        common: '#9CA3AF'
                    };
                    
                    const badgeY = 260;
                    const badgeWidth = 180;
                    const badgeHeight = 32;
                    const badgeX = (400 - badgeWidth) / 2;
                    
                    ctx.fillStyle = rarityColors[pokemon.rarity] || rarityColors.common;
                    ctx.beginPath();
                    ctx.roundRect(badgeX, badgeY, badgeWidth, badgeHeight, 8);
                    ctx.fill();
                    
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(pokemon.rarity.toUpperCase(), 200, badgeY + 21);

                    // Workout data below badge - single row with units
                    ctx.fillStyle = '#4B5563';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    
                    const isLift = pokemon.pace === '--' || !pokemon.pace || pokemon.pace === 'undefined';
                    
                    console.log('üé¥ Rendering card for:', pokemon.pokemonName, {
                        isLift,
                        pace: pokemon.pace,
                        distance: pokemon.distance,
                        duration: pokemon.duration,
                        caloriesBurned: pokemon.caloriesBurned,
                        avgHR: pokemon.avgHR
                    });
                    
                    if (isLift) {
                        // Lift: duration min | calories kcal | HR bpm
                        const duration = pokemon.duration || '--';
                        const calories = pokemon.caloriesBurned || '--';
                        const hr = pokemon.avgHR || '--';
                        ctx.fillText(`${duration} min  ${calories} kcal  ${hr} bpm`, 200, 330);
                    } else {
                        // Cardio: pace min/mi | distance mi | duration
                        const pace = pokemon.pace || '--';
                        const distance = pokemon.distance || '--';
                        const duration = pokemon.duration || '--';
                        ctx.fillText(`${pace} min/mi  ${distance} mi  ${duration}`, 200, 330);
                    }

                    setCardImage(canvas.toDataURL());
                };
            }, [pokemon]);

            return (
                <div className={`relative ${className}`} onClick={onClick}>
                    {showDelete && (
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                onDelete();
                            }}
                            className="absolute bottom-2 left-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-lg text-lg font-bold shadow-lg z-10"
                        >
                            √ó
                        </button>
                    )}
                    {cardImage && (
                        <img src={cardImage} alt={pokemon.pokemonName} className="w-full h-auto rounded-lg" />
                    )}
                </div>
            );
        };

        // ========================================
        // üéØ ENCOUNTER CARD COMPONENT (Canvas-based like old shareable cards)
        // ========================================
        const EncounterCard = ({ encounter, workoutData, isCatchAnimating, catchResult, shakeCount }) => {
            const [cardImageUrl, setCardImageUrl] = useState(null);
            const canvasRef = useRef(null);

            // Helper functions for drawing (copied from existing code)
            const drawStar = (ctx, cx, cy, spikes, outerRadius, innerRadius) => {
                let rot = Math.PI / 2 * 3;
                let x = cx;
                let y = cy;
                const step = Math.PI / spikes;

                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                
                for (let i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    ctx.lineTo(x, y);
                    rot += step;

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y);
                    rot += step;
                }
                
                ctx.lineTo(cx, cy - outerRadius);
                ctx.closePath();
                ctx.fill();
            };

            const drawRarityIcon = (ctx, x, y, size, tier) => {
                ctx.save();
                
                switch(tier) {
                    case 'common':
                        ctx.fillStyle = '#6B7280';
                        ctx.beginPath();
                        ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'uncommon':
                        ctx.fillStyle = '#10B981';
                        ctx.beginPath();
                        ctx.moveTo(x + size/2, y);
                        ctx.lineTo(x + size, y + size/2);
                        ctx.lineTo(x + size/2, y + size);
                        ctx.lineTo(x, y + size/2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'rare':
                        ctx.fillStyle = '#3B82F6';
                        drawStar(ctx, x + size/2, y + size/2, 5, size/2, size/4);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'epic':
                        ctx.fillStyle = '#8B5CF6';
                        ctx.globalAlpha = 0.7;
                        drawStar(ctx, x + size/2 - 8, y + size/2, 5, size/2.2, size/4.4);
                        ctx.globalAlpha = 1;
                        drawStar(ctx, x + size/2 + 8, y + size/2, 5, size/2.2, size/4.4);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        break;
                    case 'legendary':
                        ctx.fillStyle = '#F59E0B';
                        drawStar(ctx, x + size/2, y + size/3, 5, size/2.5, size/5);
                        drawStar(ctx, x + size/4, y + size*2/3, 5, size/3, size/6);
                        drawStar(ctx, x + size*3/4, y + size*2/3, 5, size/3, size/6);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        break;
                }
                
                ctx.restore();
            };

            const drawStatsBox = (ctx, width, height, pace, distance, duration) => {
                const boxWidth = 800;
                const boxHeight = 250;
                const boxX = (width - boxWidth) / 2;
                const boxY = height - 330;

                // Black border
                ctx.fillStyle = '#000000';
                ctx.fillRect(boxX - 8, boxY - 8, boxWidth + 16, boxHeight + 16);
                
                // White border
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(boxX - 4, boxY - 4, boxWidth + 8, boxHeight + 8);
                
                // Tan background
                ctx.fillStyle = '#E8E8D0';
                ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

                // Stats text
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'left';
                
                const labelX = boxX + 40;
                let currentY = boxY + 60;
                
                ctx.fillText('Avg Pace', labelX, currentY);
                ctx.fillText('min/mi', labelX + 480, currentY);
                
                currentY += 70;
                ctx.fillText('Distance', labelX, currentY);
                ctx.fillText('mi', labelX + 480, currentY);
                
                currentY += 70;
                ctx.fillText('Duration', labelX, currentY);

                // Timestamp
                ctx.font = '20px monospace';
                ctx.fillStyle = '#666666';
                ctx.textAlign = 'right';
                const timestamp = new Date().toLocaleString();
                ctx.fillText(timestamp, boxX + boxWidth - 40, boxY + boxHeight - 20);
            };

            useEffect(() => {
                const generateCard = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 1080;
                    canvas.height = 1080;
                    const ctx = canvas.getContext('2d');

                    // Background
                    ctx.fillStyle = '#C5C9B8';
                    ctx.fillRect(0, 0, 1080, 1080);

                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.src = encounter.spriteUrl;
                    
                    img.onload = () => {
                        // Draw rarity icon at very top (not obstructing name)
                        const iconSize = 60;
                        const iconX = 540 - iconSize / 2;
                        const iconY = 50; // Top of card
                        drawRarityIcon(ctx, iconX, iconY, iconSize, encounter.rarity);

                        // Pokemon name below icon
                        ctx.fillStyle = '#000000';
                        ctx.font = 'bold 48px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(encounter.pokemonName.toUpperCase(), 540, 180);

                        // Draw sprite higher up to avoid clipping
                        const scale = 5.5; // Slightly smaller
                        const spriteWidth = img.width * scale;
                        const spriteHeight = img.height * scale;
                        const spriteX = (1080 - spriteWidth) / 2;
                        const spriteY = 240; // Moved up from 280
                        
                        ctx.imageSmoothingEnabled = false;
                        
                        // Shiny glow effect
                        if (encounter.isShiny) {
                            ctx.shadowColor = '#FFD700';
                            ctx.shadowBlur = 30;
                            for (let i = 0; i < 5; i++) {
                                ctx.drawImage(img, spriteX, spriteY, spriteWidth, spriteHeight);
                            }
                            ctx.shadowBlur = 0;
                        }
                        
                        ctx.drawImage(img, spriteX, spriteY, spriteWidth, spriteHeight);

                        // Draw rarity badge below sprite - with spacing from stats box
                        const rarityColors = {
                            legendary: '#F59E0B',
                            epic: '#8B5CF6',
                            rare: '#3B82F6',
                            uncommon: '#10B981',
                            common: '#9CA3AF'
                        };
                        
                        const badgeY = spriteY + spriteHeight + 30;
                        const badgeWidth = 300;
                        const badgeHeight = 70;
                        const badgeX = (1080 - badgeWidth) / 2;
                        
                        // Rounded rectangle for badge
                        ctx.fillStyle = rarityColors[encounter.rarity] || rarityColors.common;
                        ctx.beginPath();
                        ctx.moveTo(badgeX + 15, badgeY);
                        ctx.lineTo(badgeX + badgeWidth - 15, badgeY);
                        ctx.quadraticCurveTo(badgeX + badgeWidth, badgeY, badgeX + badgeWidth, badgeY + 15);
                        ctx.lineTo(badgeX + badgeWidth, badgeY + badgeHeight - 15);
                        ctx.quadraticCurveTo(badgeX + badgeWidth, badgeY + badgeHeight, badgeX + badgeWidth - 15, badgeY + badgeHeight);
                        ctx.lineTo(badgeX + 15, badgeY + badgeHeight);
                        ctx.quadraticCurveTo(badgeX, badgeY + badgeHeight, badgeX, badgeY + badgeHeight - 15);
                        ctx.lineTo(badgeX, badgeY + 15);
                        ctx.quadraticCurveTo(badgeX, badgeY, badgeX + 15, badgeY);
                        ctx.closePath();
                        ctx.fill();
                        
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 40px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(encounter.rarity.toUpperCase(), 540, badgeY + 50);

                        // Draw horizontal stats box - narrower with even spacing
                        const boxWidth = 700; // Narrower (was 950)
                        const boxHeight = 140;
                        const boxX = (1080 - boxWidth) / 2;
                        const boxY = 1080 - 200; // Higher to fit better

                        // Black border
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(boxX - 8, boxY - 8, boxWidth + 16, boxHeight + 16);
                        
                        // White border
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(boxX - 4, boxY - 4, boxWidth + 8, boxHeight + 8);
                        
                        // Tan background
                        ctx.fillStyle = '#E8E8D0';
                        ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

                        // Stats text - evenly spaced horizontally
                        ctx.fillStyle = '#000000';
                        ctx.textAlign = 'center'; // Center align for even spacing
                        
                        const columnWidth = boxWidth / 3;
                        
                        if (workoutData.workoutType === 'lift') {
                            // Lift: Duration | Calories | Avg HR (evenly spaced)
                            
                            // Column 1: Duration
                            const col1X = boxX + columnWidth / 2;
                            ctx.font = 'bold 28px Arial';
                            ctx.fillText('Duration', col1X, boxY + 45);
                            ctx.font = 'bold 32px Arial';
                            ctx.fillText((workoutData.liftDuration || '--') + ' min', col1X, boxY + 90);
                            
                            // Column 2: Calories
                            const col2X = boxX + columnWidth * 1.5;
                            ctx.font = 'bold 28px Arial';
                            ctx.fillText('Calories', col2X, boxY + 45);
                            ctx.font = 'bold 32px Arial';
                            ctx.fillText((workoutData.caloriesBurned || '--') + ' kcal', col2X, boxY + 90);
                            
                            // Column 3: Avg HR
                            const col3X = boxX + columnWidth * 2.5;
                            ctx.font = 'bold 28px Arial';
                            ctx.fillText('Avg HR', col3X, boxY + 45);
                            ctx.font = 'bold 32px Arial';
                            ctx.fillText(workoutData.avgHR || '--', col3X, boxY + 90);
                        } else {
                            // Cardio: Avg Pace | Distance | Duration (evenly spaced)
                            
                            // Column 1: Avg Pace
                            const col1X = boxX + columnWidth / 2;
                            ctx.font = 'bold 28px Arial';
                            ctx.fillText('Avg Pace', col1X, boxY + 45);
                            ctx.font = 'bold 32px Arial';
                            ctx.fillText((workoutData.pace || '--') + ' min/mi', col1X, boxY + 90);
                            
                            // Column 2: Distance
                            const col2X = boxX + columnWidth * 1.5;
                            ctx.font = 'bold 28px Arial';
                            ctx.fillText('Distance', col2X, boxY + 45);
                            ctx.font = 'bold 32px Arial';
                            ctx.fillText((workoutData.distance || '--') + ' mi', col2X, boxY + 90);
                            
                            // Column 3: Duration
                            const col3X = boxX + columnWidth * 2.5;
                            ctx.font = 'bold 28px Arial';
                            ctx.fillText('Duration', col3X, boxY + 45);
                            ctx.font = 'bold 32px Arial';
                            ctx.fillText(workoutData.duration || '--', col3X, boxY + 90);
                        }

                        // Timestamp in bottom right corner (no overlap with data)
                        ctx.font = '16px monospace';
                        ctx.fillStyle = '#666666';
                        ctx.textAlign = 'right';
                        const timestamp = new Date().toLocaleString();
                        ctx.fillText(timestamp, boxX + boxWidth - 15, boxY + boxHeight - 10);

                        setCardImageUrl(canvas.toDataURL());
                    };

                    img.onerror = () => {
                        console.error('Failed to load sprite');
                    };
                };

                generateCard();
            }, [encounter, workoutData]);

            return (
                <div className="relative" style={{ paddingTop: '100%' }}>
                    {cardImageUrl && (
                        <img 
                            src={cardImageUrl}
                            alt={encounter.pokemonName}
                            className="absolute inset-0 w-full h-full object-cover"
                        />
                    )}
                    
                    {/* Pok√©ball Animation Overlay */}
                    {(isCatchAnimating || (catchResult && !isCatchAnimating)) && (
                        <div className="absolute inset-0 bg-black bg-opacity-50 rounded-2xl flex items-center justify-center">
                            <div className={
                                isCatchAnimating 
                                    ? "pokeball-shake" 
                                    : catchResult === 'success' 
                                        ? "pokeball-success" 
                                        : "pokeball-fail"
                            }>
                                <PokeballIcon 
                                    size={128} 
                                    failed={catchResult === 'fail' && !isCatchAnimating}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const PokemonRunTracker = () => {
            // Cardio workout inputs (existing)
            const [pace, setPace] = useState('');
            const [distance, setDistance] = useState('');
            const [duration, setDuration] = useState('');
            const [lastEdited, setLastEdited] = useState(null);
            
            // üèãÔ∏è Lift workout inputs (NEW)
            const [liftDuration, setLiftDuration] = useState('');
            const [caloriesBurned, setCaloriesBurned] = useState('');
            const [avgHR, setAvgHR] = useState('');
            
            // üéÆ Pok√©ball System (Phase 1)
            const [storedPokeballs, setStoredPokeballs] = useState(0);
            const [workoutTab, setWorkoutTab] = useState('cardio');
            const [hasExchanged, setHasExchanged] = useState(false);
            
            // üéØ Capture Session System (Phase 2)
            const [captureSession, setCaptureSession] = useState(null); // { sessionId, encounters[], currentIndex, createdAt }
            const [currentEncounter, setCurrentEncounter] = useState(null);
            const [isCatchAnimating, setIsCatchAnimating] = useState(false);
            const [catchResult, setCatchResult] = useState(null); // 'success' | 'fail' | null
            const [shakeCount, setShakeCount] = useState(0);
            const [lastWorkoutIntensity, setLastWorkoutIntensity] = useState(null); // Store for session generation
            
            const [pokemonData, setPokemonData] = useState(null);
            const [spriteVariant, setSpriteVariant] = useState('default');
            const [availableVariants, setAvailableVariants] = useState([]);
            const [isShiny, setIsShiny] = useState(false);
            
            // üî• Firebase Profile State
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [firebaseProfile, setFirebaseProfile] = useState(null);
            const [isCreatingProfile, setIsCreatingProfile] = useState(false);
            const [hasNotifications, setHasNotifications] = useState(false); // For future friend requests
            const [showWipeConfirmation, setShowWipeConfirmation] = useState(false);
            const [isWiping, setIsWiping] = useState(false);
            const [isLoadingProfile, setIsLoadingProfile] = useState(true); // Loading state for badge
            
            // üë• Friend System State
            const [showFriendSearch, setShowFriendSearch] = useState(false);
            const [friendSearchQuery, setFriendSearchQuery] = useState('');
            const [friendSearchResults, setFriendSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [friends, setFriends] = useState([]);
            const [friendProfiles, setFriendProfiles] = useState({}); // Map of friendId -> profile
            const [incomingRequests, setIncomingRequests] = useState([]);
            const [outgoingRequests, setOutgoingRequests] = useState([]);
            const [requestCounts, setRequestCounts] = useState({}); // Track request attempts per user
            const [friendModalTab, setFriendModalTab] = useState('list'); // 'list' or 'search'
            
            // üì∏ Activity Feed State
            const [activityFeed, setActivityFeed] = useState([]);
            const [isLoadingFeed, setIsLoadingFeed] = useState(false);
            const [feedFilter, setFeedFilter] = useState('all'); // 'all' or 'mine'
            
            // üë§ Friend Profile View State
            const [viewingFriendId, setViewingFriendId] = useState(null);
            const [viewingFriendStarters, setViewingFriendStarters] = useState([]);
            const [viewingFriendPC, setViewingFriendPC] = useState([]);
            const [friendProfileTab, setFriendProfileTab] = useState('starters'); // 'starters' or 'pc'
            
            // ü§ù Trading System State
            const [tradingWithFriend, setTradingWithFriend] = useState(null); // Friend ID when trade initiated
            const [tradeView, setTradeView] = useState('their'); // 'their' or 'my' PC view
            const [selectedTheirPokemon, setSelectedTheirPokemon] = useState([]); // Up to 3 from friend's PC
            const [selectedMyPokemon, setSelectedMyPokemon] = useState([]); // Up to 3 from my PC
            const [pendingTrades, setPendingTrades] = useState({}); // { friendId: tradeData }
            const [viewingTradeRequest, setViewingTradeRequest] = useState(null); // Trade request being reviewed
            
            // Profile customization
            const [trainerName, setTrainerName] = useState('Trainer');
            const [profileColor, setProfileColor] = useState('#FF6B6B');
            const [showProfileMenu, setShowProfileMenu] = useState(false);
            const [isEditingName, setIsEditingName] = useState(false);
            
            // PC Storage & Starters
            const [pokemonPC, setPokemonPC] = useState([]); // All caught Pokemon
            const [starterTeam, setStarterTeam] = useState([null, null, null, null, null, null]); // 6 starter slots
            const [currentView, setCurrentView] = useState('main'); // 'main', 'pc', 'starters', 'friends', 'feed'
            const [showDeletePrompt, setShowDeletePrompt] = useState(null); // Pokemon ID to delete
            const [selectingForSlot, setSelectingForSlot] = useState(null); // Which starter slot is being filled
            const [deleteMode, setDeleteMode] = useState(false); // Delete mode for PC
            
            // 8 evenly-spaced vibrant Pantone-inspired colors (45¬∞ apart on color wheel)
            const PROFILE_COLORS = [
                { name: 'Fiery Red', hex: '#FF6B6B', angle: 0 },      // Red
                { name: 'Sunset Orange', hex: '#FFA94D', angle: 45 },  // Orange
                { name: 'Golden Yellow', hex: '#FFD93D', angle: 90 },  // Yellow
                { name: 'Spring Green', hex: '#6BCF7F', angle: 135 },  // Yellow-Green
                { name: 'Ocean Teal', hex: '#4ECDC4', angle: 180 },    // Cyan
                { name: 'Royal Blue', hex: '#4D96FF', angle: 225 },    // Blue
                { name: 'Mystic Purple', hex: '#9D4EDD', angle: 270 }, // Purple
                { name: 'Rose Pink', hex: '#FF6BA9', angle: 315 }      // Magenta
            ];
            
            // Auto-calculate third value ONLY when two are entered and third is empty
            const isFieldEmpty = (value) => {
                return !value || value === '' || value === '0' || value === '0:00' || value === '0.0' || value === ':';
            };
            
            // Simplified calculation logic:
            // - Duration is ALWAYS calculated from Pace + Distance
            // - If user edits Duration, recalculate Pace to match
            
            const handlePaceChange = (value) => {
                setPace(value);
                setLastEdited('pace');
                
                // Calculate duration if we have distance
                const dist = parseFloat(distance);
                if (value.includes(':') && !isNaN(dist) && dist > 0) {
                    const [min, sec] = value.split(':').map(Number);
                    if (!isNaN(min) && !isNaN(sec)) {
                        const paceSeconds = min * 60 + (sec || 0);
                        const totalSeconds = paceSeconds * dist;
                        const durMin = Math.floor(totalSeconds / 60);
                        const durSec = Math.round(totalSeconds % 60);
                        setDuration(`${durMin}:${durSec.toString().padStart(2, '0')}`);
                    }
                }
            };

            const handlePaceBlur = () => {
                // Ensure calculation happens even with partial input
                const dist = parseFloat(distance);
                if (pace.includes(':') && !isNaN(dist) && dist > 0) {
                    const [min, sec] = pace.split(':').map(Number);
                    if (!isNaN(min) && !isNaN(sec)) {
                        const paceSeconds = min * 60 + (sec || 0);
                        const totalSeconds = paceSeconds * dist;
                        const durMin = Math.floor(totalSeconds / 60);
                        const durSec = Math.round(totalSeconds % 60);
                        setDuration(`${durMin}:${durSec.toString().padStart(2, '0')}`);
                    }
                }
            };

            const handleDistanceChange = (value) => {
                setDistance(value);
                setLastEdited('distance');
                
                const dist = parseFloat(value);
                
                // Skip calculation if still typing decimal or invalid
                if ((value.length < 3 && value.endsWith('.')) || isNaN(dist) || dist <= 0) {
                    return;
                }
                
                // Calculate duration if we have pace
                if (pace.includes(':')) {
                    const [min, sec] = pace.split(':').map(Number);
                    if (!isNaN(min) && !isNaN(sec)) {
                        const paceSeconds = min * 60 + (sec || 0);
                        const totalSeconds = paceSeconds * dist;
                        const durMin = Math.floor(totalSeconds / 60);
                        const durSec = Math.round(totalSeconds % 60);
                        setDuration(`${durMin}:${durSec.toString().padStart(2, '0')}`);
                    }
                }
            };

            const handleDistanceBlur = () => {
                // Trigger calculation on blur for single-digit entries
                const dist = parseFloat(distance);
                if (!isNaN(dist) && dist > 0 && pace.includes(':')) {
                    const [min, sec] = pace.split(':').map(Number);
                    if (!isNaN(min) && !isNaN(sec)) {
                        const paceSeconds = min * 60 + (sec || 0);
                        const totalSeconds = paceSeconds * dist;
                        const durMin = Math.floor(totalSeconds / 60);
                        const durSec = Math.round(totalSeconds % 60);
                        setDuration(`${durMin}:${durSec.toString().padStart(2, '0')}`);
                    }
                }
            };

            const handleDurationChange = (value) => {
                setDuration(value);
                setLastEdited('duration');
                
                // If user manually edits duration, recalculate pace to match
                const dist = parseFloat(distance);
                if (value.includes(':') && !isNaN(dist) && dist > 0) {
                    const [min, sec] = value.split(':').map(Number);
                    if (!isNaN(min) && !isNaN(sec)) {
                        const durationSeconds = min * 60 + (sec || 0);
                        const paceSeconds = durationSeconds / dist;
                        const paceMin = Math.floor(paceSeconds / 60);
                        const paceSec = Math.round(paceSeconds % 60);
                        setPace(`${paceMin}:${paceSec.toString().padStart(2, '0')}`);
                    }
                }
            };

            const handleDurationBlur = () => {
                // Ensure pace recalculation happens on blur
                const dist = parseFloat(distance);
                if (duration.includes(':') && !isNaN(dist) && dist > 0) {
                    const [min, sec] = duration.split(':').map(Number);
                    if (!isNaN(min) && !isNaN(sec)) {
                        const durationSeconds = min * 60 + (sec || 0);
                        const paceSeconds = durationSeconds / dist;
                        const paceMin = Math.floor(paceSeconds / 60);
                        const paceSec = Math.round(paceSeconds % 60);
                        setPace(`${paceMin}:${paceSec.toString().padStart(2, '0')}`);
                    }
                }
            };
            
            const [runHistory, setRunHistory] = useState([]);
            const [currentStreak, setCurrentStreak] = useState({ days: 0, weeks: 0 });
            const [personalRecords, setPersonalRecords] = useState({
                fastestPace: null,
                longestDistance: null,
                longestDuration: null
            });
            const [rarityRoll, setRarityRoll] = useState(null);
            const [isNewPR, setIsNewPR] = useState({});
            
            const [currentJourney, setCurrentJourney] = useState(null);
            const [journeyHistory, setJourneyHistory] = useState([]);
            const [showJourneyModal, setShowJourneyModal] = useState(false);
            const [completedJourney, setCompletedJourney] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            
            const canvasRef = useRef(null);
            const imageGenerationRef = useRef(0); // Track generation to prevent stale draws
            const journeyCanvasRef = useRef(null);
            const profileMenuRef = useRef(null);

            useEffect(() => {
                loadRunHistory();
                checkFirebaseAuth(); // üî• Check if user is already authenticated
                
                // üéÆ Load stored Pok√©balls
                window.storage.get('stored-pokeballs').then(result => {
                    if (result && result.value) {
                        const balls = parseInt(result.value);
                        if (!isNaN(balls)) {
                            setStoredPokeballs(balls);
                            console.log('üéÆ Loaded stored Pok√©balls:', balls);
                        }
                    }
                }).catch(err => console.error('Error loading pokeballs:', err));
                
                // üéØ Load active capture session
                loadCaptureSession().then(session => {
                    if (session) {
                        console.log('üìÇ Resumed capture session');
                    }
                });
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                }, 500);
            }, []);

            // üîç Live search with debouncing
            useEffect(() => {
                if (friendSearchQuery.length >= 3 && firebaseProfile) {
                    const timer = setTimeout(() => {
                        searchTrainers();
                    }, 300); // 300ms debounce
                    
                    return () => clearTimeout(timer);
                } else {
                    setFriendSearchResults([]);
                }
            }, [friendSearchQuery]);

            // üì∏ Load activity feed when opening feed view
            useEffect(() => {
                if (currentView === 'feed' && firebaseProfile && activityFeed.length === 0) {
                    loadActivityFeedData();
                }
            }, [currentView]);

            const loadActivityFeedData = async () => {
                setIsLoadingFeed(true);
                try {
                    const feed = await loadActivityFeed();
                    setActivityFeed(feed);
                } catch (error) {
                    console.error('‚ùå Error loading activity feed:', error);
                } finally {
                    setIsLoadingFeed(false);
                }
            };

            // Close profile menu when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (profileMenuRef.current && !profileMenuRef.current.contains(event.target)) {
                        setShowProfileMenu(false);
                        if (isEditingName) {
                            setIsEditingName(false);
                            // Don't call handleNameChange here to avoid dependency issues
                            saveProfile(trainerName, profileColor);
                        }
                    }
                };

                if (showProfileMenu) {
                    document.addEventListener('mousedown', handleClickOutside);
                } else {
                    document.removeEventListener('mousedown', handleClickOutside);
                }

                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [showProfileMenu, isEditingName, trainerName, profileColor]);

            // Safe JSON parse with fallback
            const safeParse = (raw, fallback) => {
                try {
                    const v = JSON.parse(raw);
                    return v ?? fallback;
                } catch {
                    return fallback;
                }
            };

            // üìù Auto-save trainer name with debounce
            const [nameEditTimeout, setNameEditTimeout] = useState(null);
            const [originalTrainerName, setOriginalTrainerName] = useState('');

            const handleNameInputChange = (newValue) => {
                setTrainerName(newValue);
                
                // Clear existing timeout
                if (nameEditTimeout) {
                    clearTimeout(nameEditTimeout);
                }
                
                // Set new timeout to save after 1 second of no typing
                const timeout = setTimeout(() => {
                    const trimmedName = newValue.trim();
                    if (trimmedName && trimmedName !== originalTrainerName && trimmedName !== firebaseProfile?.displayName) {
                        console.log('üíæ Auto-saving name after typing stopped:', trimmedName);
                        handleNameChange(trimmedName);
                        setOriginalTrainerName(trimmedName);
                    }
                }, 1000);
                
                setNameEditTimeout(timeout);
            };

            // üî• Check Firebase Auth State
            const checkFirebaseAuth = async () => {
                try {
                    // Wait for auth state to be determined
                    const user = await new Promise((resolve) => {
                        const unsubscribe = auth.onAuthStateChanged((user) => {
                            unsubscribe();
                            resolve(user);
                        });
                    });

                    if (user) {
                        firebaseManager.user = user;
                        setFirebaseUser(user);
                        const profile = await firebaseManager.getProfile();
                        if (profile) {
                            setFirebaseProfile(profile);
                            setTrainerName(profile.displayName);
                            setProfileColor(profile.badgeColor);
                            console.log('‚úÖ Firebase profile loaded:', profile.displayName);
                            
                            // Load friends data
                            await loadFriendsData();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error checking Firebase auth:', error);
                } finally {
                    // Always set loading to false, even if no profile
                    setIsLoadingProfile(false);
                }
            };

            // üî• Handle Trainer Badge Click - Create Profile if First Time
            const handleTrainerBadgeClick = async () => {
                console.log('üëÜ Trainer badge clicked', { 
                    hasProfile: !!firebaseProfile, 
                    currentMenuState: showProfileMenu 
                });
                
                // If already has Firebase profile, just toggle menu
                if (firebaseProfile) {
                    setShowProfileMenu(!showProfileMenu);
                    console.log('üìã Toggling profile menu to:', !showProfileMenu);
                    return;
                }

                // First time clicking - create Firebase profile
                setIsCreatingProfile(true);
                try {
                    console.log('üéØ First badge click - creating Firebase profile...');
                    
                    // Sign in anonymously
                    await firebaseManager.signInAnonymously();
                    setFirebaseUser(firebaseManager.user);
                    
                    // Create profile
                    const profile = await firebaseManager.createTrainerProfile();
                    setFirebaseProfile(profile);
                    setTrainerName(profile.displayName);
                    setProfileColor(profile.badgeColor);
                    
                    // Migrate existing data
                    await firebaseManager.migrateLocalStorageToFirebase();
                    
                    // Load friends data (will be empty for new user)
                    await loadFriendsData();
                    
                    console.log('‚úÖ Firebase profile created:', profile.displayName);
                    
                    // Open menu to show the new profile
                    setShowProfileMenu(true);
                    
                } catch (error) {
                    console.error('‚ùå Failed to create Firebase profile:', error);
                    alert('Failed to create trainer profile. Please try again.');
                } finally {
                    setIsCreatingProfile(false);
                }
            };

            // Update trainer name in Firebase when changed
            const handleNameChange = async (newName) => {
                if (newName.length > 12) {
                    newName = newName.substring(0, 12);
                    setTrainerName(newName);
                }
                
                // Update in Firebase if profile exists
                if (firebaseProfile) {
                    try {
                        await firebaseManager.updateProfile({ displayName: newName });
                        setFirebaseProfile({ ...firebaseProfile, displayName: newName });
                        console.log('‚úÖ Name updated in Firebase:', newName);
                    } catch (error) {
                        console.error('‚ùå Failed to update name:', error);
                    }
                }
                
                // Also save to localStorage for backward compatibility
                saveProfile(newName, profileColor);
            };

            // Update badge color in Firebase when changed
            const handleColorChange = async (newColor) => {
                setProfileColor(newColor);
                
                // Update in Firebase if profile exists
                if (firebaseProfile) {
                    try {
                        await firebaseManager.updateProfile({ badgeColor: newColor });
                        setFirebaseProfile({ ...firebaseProfile, badgeColor: newColor });
                        console.log('‚úÖ Color updated in Firebase:', newColor);
                    } catch (error) {
                        console.error('‚ùå Failed to update color:', error);
                    }
                }
                
                // Also save to localStorage for backward compatibility
                saveProfile(trainerName, newColor);
            };

            // üî• Wipe Firebase Profile & Reset to Fresh State
            const handleWipeProfile = async () => {
                setIsWiping(true);
                try {
                    console.log('üóëÔ∏è Wiping profile data...');
                    
                    // Delete Firebase data
                    if (firebaseManager.user) {
                        await database.ref(`users/${firebaseManager.user.uid}`).remove();
                        console.log('‚úÖ Firebase data deleted');
                    }
                    
                    // Sign out
                    await auth.signOut();
                    firebaseManager.user = null;
                    
                    // Clear all localStorage
                    localStorage.clear();
                    console.log('‚úÖ localStorage cleared');
                    
                    // Reset all state
                    setFirebaseUser(null);
                    setFirebaseProfile(null);
                    setTrainerName('Trainer');
                    setProfileColor('#FF6B6B');
                    setPokemonPC([]);
                    setStarterTeam([null, null, null, null, null, null]);
                    setRunHistory([]);
                    setCurrentStreak({ days: 0, weeks: 0 });
                    setPersonalRecords({ fastestPace: null, longestDistance: null, longestDuration: null });
                    setCurrentJourney(null);
                    setJourneyHistory([]);
                    setShowWipeConfirmation(false);
                    setShowProfileMenu(false);
                    
                    console.log('‚úÖ Profile wiped! Fresh start as Arceus intended.');
                    alert('Profile wiped! Arceus has deemed you start from scratch... tough luck! üå©Ô∏è');
                    
                    // Reload page for clean slate
                    setTimeout(() => window.location.reload(), 1000);
                    
                } catch (error) {
                    console.error('‚ùå Error wiping profile:', error);
                    alert('Failed to wipe profile. Please try again.');
                } finally {
                    setIsWiping(false);
                }
            };

            // =========================
            // üë• FRIEND SYSTEM FUNCTIONS
            // =========================

            // Load friends and friend requests
            const loadFriendsData = async () => {
                if (!firebaseManager.user) return;

                try {
                    const uid = firebaseManager.user.uid;

                    // Load friend list
                    const friendsSnapshot = await database.ref(`users/${uid}/friends`).once('value');
                    const friendsData = friendsSnapshot.val() || {};
                    const friendIds = Object.keys(friendsData);
                    setFriends(friendIds);

                    // Load friend profiles
                    const profiles = {};
                    for (const friendId of friendIds) {
                        const profileSnapshot = await database.ref(`users/${friendId}/profile`).once('value');
                        if (profileSnapshot.exists()) {
                            profiles[friendId] = profileSnapshot.val();
                        }
                    }
                    setFriendProfiles(profiles);

                    // Load incoming requests
                    const incomingSnapshot = await database.ref(`users/${uid}/friendRequests/incoming`).once('value');
                    const incomingData = incomingSnapshot.val() || {};
                    const incoming = Object.keys(incomingData);
                    setIncomingRequests(incoming);

                    // Update notification badge
                    setHasNotifications(incoming.length > 0);

                    // Load outgoing requests
                    const outgoingSnapshot = await database.ref(`users/${uid}/friendRequests/outgoing`).once('value');
                    const outgoingData = outgoingSnapshot.val() || {};
                    setOutgoingRequests(Object.keys(outgoingData));

                    console.log(`‚úÖ Loaded ${friendIds.length} friends, ${incoming.length} incoming requests`);
                } catch (error) {
                    console.error('‚ùå Error loading friends:', error);
                }
            };

            // Search for trainers by exact name or partial match (3+ chars)
            const searchTrainers = async () => {
                const query = friendSearchQuery.trim();
                
                // Need at least 3 characters for suggestions
                if (query.length < 3 || !firebaseManager.user) {
                    setFriendSearchResults([]);
                    return;
                }

                setIsSearching(true);

                try {
                    const usersSnapshot = await database.ref('users').once('value');
                    const results = [];
                    const exactMatches = [];
                    const partialMatches = [];

                    usersSnapshot.forEach(child => {
                        const uid = child.key;
                        const profile = child.val().profile;

                        // Skip self
                        if (uid === firebaseManager.user.uid || !profile || !profile.displayName) {
                            return;
                        }

                        const displayName = profile.displayName;
                        const queryLower = query.toLowerCase();
                        const nameLower = displayName.toLowerCase();

                        // Exact match (case-insensitive)
                        if (nameLower === queryLower) {
                            exactMatches.push({
                                uid,
                                displayName: profile.displayName,
                                badgeColor: profile.badgeColor,
                                isFriend: friends.includes(uid),
                                hasPendingRequest: outgoingRequests.includes(uid),
                                matchType: 'exact'
                            });
                        }
                        // Partial match - starts with query
                        else if (nameLower.startsWith(queryLower)) {
                            partialMatches.push({
                                uid,
                                displayName: profile.displayName,
                                badgeColor: profile.badgeColor,
                                isFriend: friends.includes(uid),
                                hasPendingRequest: outgoingRequests.includes(uid),
                                matchType: 'partial'
                            });
                        }
                        // Partial match - contains query
                        else if (nameLower.includes(queryLower)) {
                            partialMatches.push({
                                uid,
                                displayName: profile.displayName,
                                badgeColor: profile.badgeColor,
                                isFriend: friends.includes(uid),
                                hasPendingRequest: outgoingRequests.includes(uid),
                                matchType: 'contains'
                            });
                        }
                    });

                    // Sort partial matches alphabetically
                    partialMatches.sort((a, b) => a.displayName.localeCompare(b.displayName));

                    // Combine: exact matches first, then partials (max 10 total)
                    const allMatches = [...exactMatches, ...partialMatches].slice(0, 10);
                    
                    setFriendSearchResults(allMatches);
                    console.log(`üîç Found ${allMatches.length} trainers matching "${query}" (${exactMatches.length} exact, ${partialMatches.length} partial)`);
                } catch (error) {
                    console.error('‚ùå Search error:', error);
                } finally {
                    setIsSearching(false);
                }
            };

            // Send friend request
            const sendFriendRequest = async (targetUid) => {
                if (!firebaseManager.user) return;

                try {
                    const myUid = firebaseManager.user.uid;

                    // Check request count (max 5 attempts)
                    const currentCount = requestCounts[targetUid] || 0;
                    if (currentCount >= 5) {
                        alert('You have already sent 5 requests to this trainer.');
                        return;
                    }

                    // Check if already friends
                    if (friends.includes(targetUid)) {
                        alert('Already friends with this trainer!');
                        return;
                    }

                    // Check if already has pending request
                    if (outgoingRequests.includes(targetUid)) {
                        // Cancel the request
                        await database.ref(`users/${myUid}/friendRequests/outgoing/${targetUid}`).remove();
                        await database.ref(`users/${targetUid}/friendRequests/incoming/${myUid}`).remove();
                        
                        setOutgoingRequests(prev => prev.filter(id => id !== targetUid));
                        
                        // Update search results immediately
                        setFriendSearchResults(prev => 
                            prev.map(result => 
                                result.uid === targetUid 
                                    ? { ...result, hasPendingRequest: false }
                                    : result
                            )
                        );
                        
                        console.log('‚úÖ Friend request cancelled');
                        return;
                    }

                    // Send request
                    const timestamp = firebase.database.ServerValue.TIMESTAMP;
                    await database.ref(`users/${myUid}/friendRequests/outgoing/${targetUid}`).set(timestamp);
                    await database.ref(`users/${targetUid}/friendRequests/incoming/${myUid}`).set(timestamp);

                    // Update request count
                    setRequestCounts(prev => ({
                        ...prev,
                        [targetUid]: currentCount + 1
                    }));

                    setOutgoingRequests(prev => [...prev, targetUid]);
                    
                    // Update search results immediately
                    setFriendSearchResults(prev => 
                        prev.map(result => 
                            result.uid === targetUid 
                                ? { ...result, hasPendingRequest: true }
                                : result
                        )
                    );
                    
                    console.log('‚úÖ Friend request sent');
                } catch (error) {
                    console.error('‚ùå Error sending friend request:', error);
                    alert('Failed to send friend request. Please try again.');
                }
            };

            // Accept friend request
            const acceptFriendRequest = async (senderUid) => {
                if (!firebaseManager.user) return;

                try {
                    const myUid = firebaseManager.user.uid;

                    // Add to both friend lists
                    await database.ref(`users/${myUid}/friends/${senderUid}`).set(true);
                    await database.ref(`users/${senderUid}/friends/${myUid}`).set(true);

                    // Remove friend requests
                    await database.ref(`users/${myUid}/friendRequests/incoming/${senderUid}`).remove();
                    await database.ref(`users/${senderUid}/friendRequests/outgoing/${myUid}`).remove();

                    console.log('‚úÖ Friend request accepted');

                    // Reload friends data
                    await loadFriendsData();
                } catch (error) {
                    console.error('‚ùå Error accepting friend request:', error);
                    alert('Failed to accept friend request. Please try again.');
                }
            };

            // Decline friend request
            const declineFriendRequest = async (senderUid) => {
                if (!firebaseManager.user) return;

                try {
                    const myUid = firebaseManager.user.uid;

                    // Remove friend requests
                    await database.ref(`users/${myUid}/friendRequests/incoming/${senderUid}`).remove();
                    await database.ref(`users/${senderUid}/friendRequests/outgoing/${myUid}`).remove();

                    console.log('‚úÖ Friend request declined');

                    // Reload friends data
                    await loadFriendsData();
                } catch (error) {
                    console.error('‚ùå Error declining friend request:', error);
                }
            };

            // =========================
            // üì∏ ACTIVITY FEED SYSTEM
            // =========================

            // Create activity feed entry when catching Pokemon
            const createActivityFeedEntry = async (catchData) => {
                if (!firebaseManager.user) return;

                try {
                    const activityId = `activity_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const myUid = firebaseManager.user.uid;

                    const activityEntry = {
                        type: 'catch',
                        trainerId: myUid,
                        trainerName: catchData.trainerName,
                        trainerBadgeColor: catchData.trainerBadgeColor,
                        pokemonId: catchData.pokemonId,
                        pokemonName: catchData.pokemonName,
                        spriteUrl: catchData.spriteUrl,
                        isShiny: catchData.isShiny,
                        rarity: catchData.rarity,
                        pace: catchData.pace,
                        distance: catchData.distance,
                        duration: catchData.duration,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        candyCount: 0,
                        candyGivers: {} // For future: {userId: true}
                    };

                    // Save to user's activity feed
                    await database.ref(`users/${myUid}/activity/${activityId}`).set(activityEntry);
                    
                    console.log('üì∏ Activity feed entry created:', activityId);
                } catch (error) {
                    console.error('‚ùå Error creating activity entry:', error);
                }
            };

            // Load activity feed (self + friends, last 7 days)
            const loadActivityFeed = async () => {
                if (!firebaseManager.user) return [];

                try {
                    const myUid = firebaseManager.user.uid;
                    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                    const allActivities = [];

                    // Load my activity
                    const myActivitySnapshot = await database.ref(`users/${myUid}/activity`)
                        .orderByChild('timestamp')
                        .startAt(sevenDaysAgo)
                        .once('value');
                    
                    myActivitySnapshot.forEach(child => {
                        allActivities.push({
                            id: child.key,
                            ...child.val(),
                            isOwnCard: true
                        });
                    });

                    // Load friends' activity
                    for (const friendId of friends) {
                        const friendActivitySnapshot = await database.ref(`users/${friendId}/activity`)
                            .orderByChild('timestamp')
                            .startAt(sevenDaysAgo)
                            .once('value');
                        
                        friendActivitySnapshot.forEach(child => {
                            allActivities.push({
                                id: child.key,
                                ...child.val(),
                                isOwnCard: false
                            });
                        });
                    }

                    // Sort by timestamp (newest first)
                    allActivities.sort((a, b) => b.timestamp - a.timestamp);

                    console.log(`üì∏ Loaded ${allActivities.length} activity entries (last 7 days)`);
                    return allActivities;
                } catch (error) {
                    console.error('‚ùå Error loading activity feed:', error);
                    return [];
                }
            };

            // Give rare candy to a card (hook for Phase 2)
            const giveRareCandy = async (activityId, activityOwnerId, isRemoval = false) => {
                if (!firebaseManager.user) return;

                try {
                    const myUid = firebaseManager.user.uid;

                    if (isRemoval) {
                        // Remove candy
                        const candySnapshot = await database.ref(`users/${activityOwnerId}/activity/${activityId}/candyGivers/${myUid}`).once('value');
                        if (candySnapshot.exists()) {
                            await database.ref(`users/${activityOwnerId}/activity/${activityId}/candyGivers/${myUid}`).remove();
                            await database.ref(`users/${activityOwnerId}/activity/${activityId}/candyCount`).set(firebase.database.ServerValue.increment(-1));
                            console.log('üç¨ Rare candy removed!');
                        }
                    } else {
                        // Check if already gave candy
                        const candySnapshot = await database.ref(`users/${activityOwnerId}/activity/${activityId}/candyGivers/${myUid}`).once('value');
                        if (candySnapshot.exists()) {
                            console.log('Already gave candy to this card');
                            return;
                        }

                        // Add candy
                        await database.ref(`users/${activityOwnerId}/activity/${activityId}/candyGivers/${myUid}`).set(true);
                        await database.ref(`users/${activityOwnerId}/activity/${activityId}/candyCount`).set(firebase.database.ServerValue.increment(1));

                        console.log('üç¨ Rare candy given!');
                    }
                } catch (error) {
                    console.error('‚ùå Error toggling candy:', error);
                }
            };

            // üë§ View friend's starters
            const viewFriendStarters = async (friendId) => {
                console.log('üîç Clicking friend:', friendId);
                try {
                    // Load friend's starters
                    const startersSnapshot = await database.ref(`users/${friendId}/starters`).once('value');
                    const starters = startersSnapshot.val() || [null, null, null, null, null, null];
                    setViewingFriendStarters(Array.isArray(starters) ? starters : [null, null, null, null, null, null]);
                    console.log('‚úÖ Loaded starters:', starters);
                    
                    // Load friend's PC
                    const pcSnapshot = await database.ref(`users/${friendId}/pc`).once('value');
                    const pc = pcSnapshot.val() || [];
                    setViewingFriendPC(Array.isArray(pc) ? pc : []);
                    console.log('‚úÖ Loaded PC:', pc.length, 'pokemon');
                    
                    setViewingFriendId(friendId);
                    setFriendProfileTab('starters'); // Default to starters tab
                    setCurrentView('friendProfile');
                    console.log('‚úÖ Set view to friendProfile');
                    
                } catch (error) {
                    console.error('‚ùå Error loading friend data:', error);
                }
            };

            // =========================
            // ü§ù TRADING SYSTEM
            // =========================
            
            const initiateTrade = () => {
                setTradingWithFriend(viewingFriendId);
                setTradeView('their');
                setSelectedTheirPokemon([]);
                setSelectedMyPokemon([]);
            };

            const toggleTheirPokemon = (pokemon) => {
                setSelectedTheirPokemon(prev => {
                    const isSelected = prev.find(p => p.id === pokemon.id);
                    if (isSelected) {
                        return prev.filter(p => p.id !== pokemon.id);
                    } else if (prev.length < 3) {
                        return [...prev, pokemon];
                    }
                    return prev;
                });
            };

            const toggleMyPokemon = (pokemon) => {
                setSelectedMyPokemon(prev => {
                    const isSelected = prev.find(p => p.id === pokemon.id);
                    if (isSelected) {
                        return prev.filter(p => p.id !== pokemon.id);
                    } else if (prev.length < 3) {
                        return [...prev, pokemon];
                    }
                    return prev;
                });
            };

            const sendTradeRequest = async () => {
                if (!firebaseManager.user || !tradingWithFriend) return;
                if (selectedTheirPokemon.length === 0 || selectedMyPokemon.length === 0) {
                    alert('Please select at least 1 Pok√©mon from each side');
                    return;
                }

                try {
                    const myUid = firebaseManager.user.uid;
                    const tradeData = {
                        from: myUid,
                        to: tradingWithFriend,
                        fromPokemon: selectedMyPokemon,
                        toPokemon: selectedTheirPokemon,
                        timestamp: Date.now(),
                        status: 'pending'
                    };

                    // Store trade request in recipient's pending trades
                    await database.ref(`users/${tradingWithFriend}/tradeRequests/${myUid}`).set(tradeData);

                    console.log('‚úÖ Trade request sent');
                    alert('Trade request sent!');
                    
                    // Reset trade state
                    setTradingWithFriend(null);
                    setSelectedTheirPokemon([]);
                    setSelectedMyPokemon([]);
                    setCurrentView('friends');
                } catch (error) {
                    console.error('‚ùå Error sending trade request:', error);
                    alert('Failed to send trade request');
                }
            };

            const acceptTrade = async (tradeRequest) => {
                if (!firebaseManager.user) return;

                try {
                    const myUid = firebaseManager.user.uid;
                    const theirUid = tradeRequest.from;

                    // Swap Pokemon in both PCs
                    // Remove from my PC, add to theirs
                    const myPC = [...pokemonPC];
                    const pokemonToGive = tradeRequest.toPokemon;
                    const updatedMyPC = myPC.filter(p => !pokemonToGive.find(tp => tp.id === p.id));
                    
                    // Add their Pokemon to my PC
                    const pokemonToReceive = tradeRequest.fromPokemon;
                    updatedMyPC.unshift(...pokemonToReceive);
                    
                    // Update my PC
                    setPokemonPC(updatedMyPC);
                    await database.ref(`users/${myUid}/pc`).set(updatedMyPC);

                    // Update their PC
                    const theirPCSnapshot = await database.ref(`users/${theirUid}/pc`).once('value');
                    const theirPC = theirPCSnapshot.val() || [];
                    const updatedTheirPC = theirPC.filter(p => !pokemonToReceive.find(pr => pr.id === p.id));
                    updatedTheirPC.unshift(...pokemonToGive);
                    await database.ref(`users/${theirUid}/pc`).set(updatedTheirPC);

                    // Delete trade request
                    await database.ref(`users/${myUid}/tradeRequests/${theirUid}`).remove();

                    console.log('‚úÖ Trade completed');
                    alert('Trade completed!');
                    setViewingTradeRequest(null);
                    setCurrentView('friends');
                } catch (error) {
                    console.error('‚ùå Error completing trade:', error);
                    alert('Trade failed');
                }
            };

            const denyTrade = async (tradeRequest) => {
                if (!firebaseManager.user) return;

                try {
                    const myUid = firebaseManager.user.uid;
                    await database.ref(`users/${myUid}/tradeRequests/${tradeRequest.from}`).remove();
                    
                    console.log('‚úÖ Trade denied');
                    setViewingTradeRequest(null);
                    setCurrentView('friends');
                } catch (error) {
                    console.error('‚ùå Error denying trade:', error);
                }
            };

            // Load pending trade requests
            const loadPendingTrades = async () => {
                if (!firebaseManager.user) return;

                try {
                    const myUid = firebaseManager.user.uid;
                    const snapshot = await database.ref(`users/${myUid}/tradeRequests`).once('value');
                    const trades = snapshot.val() || {};
                    setPendingTrades(trades);
                    console.log('‚úÖ Loaded pending trades:', Object.keys(trades).length);
                } catch (error) {
                    console.error('‚ùå Error loading trades:', error);
                }
            };

            // Load trades when firebase profile loads
            useEffect(() => {
                if (firebaseProfile) {
                    loadPendingTrades();
                    
                    // Sync PC to Firebase if user has local data
                    const syncPCToFirebase = async () => {
                        if (pokemonPC.length > 0 && firebaseManager.user) {
                            try {
                                await database.ref(`users/${firebaseManager.user.uid}/pc`).set(pokemonPC);
                                console.log(`‚úÖ Synced ${pokemonPC.length} Pok√©mon to Firebase PC`);
                            } catch (error) {
                                console.error('‚ùå Error syncing PC to Firebase:', error);
                            }
                        }
                    };
                    
                    // Sync Starters to Firebase
                    const syncStartersToFirebase = async () => {
                        if (starterTeam.some(s => s !== null) && firebaseManager.user) {
                            try {
                                await database.ref(`users/${firebaseManager.user.uid}/starters`).set(starterTeam);
                                console.log('‚úÖ Synced starters to Firebase');
                            } catch (error) {
                                console.error('‚ùå Error syncing starters to Firebase:', error);
                            }
                        }
                    };
                    
                    syncPCToFirebase();
                    syncStartersToFirebase();
                }
            }, [firebaseProfile, pokemonPC, starterTeam]);

            const loadRunHistory = async () => {
                try {
                    const historyResult = await window.storage.get('run-history');
                    const streakResult = await window.storage.get('current-streak');
                    const prResult = await window.storage.get('personal-records');
                    const journeyResult = await window.storage.get('current-journey');
                    const journeyHistoryResult = await window.storage.get('journey-history');
                    const profileResult = await window.storage.get('trainer-profile');
                    const pcResult = await window.storage.get('pokemon-pc');
                    const startersResult = await window.storage.get('starter-team');

                    if (historyResult?.value) setRunHistory(safeParse(historyResult.value, []));
                    if (streakResult?.value) setCurrentStreak(safeParse(streakResult.value, { days: 0, weeks: 0 }));
                    if (prResult?.value) setPersonalRecords(safeParse(prResult.value, {
                        fastestPace: null, 
                        longestDistance: null, 
                        longestDuration: null
                    }));
                    if (journeyResult?.value) setCurrentJourney(safeParse(journeyResult.value, null));
                    if (journeyHistoryResult?.value) setJourneyHistory(safeParse(journeyHistoryResult.value, []));

                    // ‚úÖ PC must be an array
                    if (pcResult?.value) {
                        const pc = safeParse(pcResult.value, []);
                        setPokemonPC(Array.isArray(pc) ? pc : []);
                    }

                    // ‚úÖ Starters must be an array of length 6
                    if (startersResult?.value) {
                        const starters = safeParse(startersResult.value, [null, null, null, null, null, null]);
                        setStarterTeam(Array.isArray(starters) && starters.length === 6
                            ? starters
                            : [null, null, null, null, null, null]
                        );
                    }

                    // Load or initialize profile
                    if (profileResult?.value) {
                        const profile = safeParse(profileResult.value, null);
                        if (profile) {
                            setTrainerName(profile.name || 'Trainer');
                            setProfileColor(profile.color || PROFILE_COLORS[0].hex);
                        }
                    } else {
                        // First time - pick random color
                        const randomColor = PROFILE_COLORS[Math.floor(Math.random() * PROFILE_COLORS.length)];
                        setProfileColor(randomColor.hex);
                        await window.storage.set('trainer-profile', JSON.stringify({
                            name: 'Trainer',
                            color: randomColor.hex
                        }));
                    }
                } catch (error) {
                    console.log('Starting fresh', error);
                    // Initialize with random color for new users
                    const randomColor = PROFILE_COLORS[Math.floor(Math.random() * PROFILE_COLORS.length)];
                    setProfileColor(randomColor.hex);
                }
            };

            const saveProfile = async (name, color) => {
                await window.storage.set('trainer-profile', JSON.stringify({
                    name: name || 'Trainer',
                    color: color || profileColor
                }));
            };

            // PC Storage functions
            const addPokemonToPC = async (pokemonData) => {
                const pcEntry = {
                    id: Date.now(), // Unique ID for deletion
                    pokemonId: pokemonData.pokemonId,
                    pokemonName: pokemonData.name,
                    isShiny: pokemonData.isShiny,
                    rarity: pokemonData.rarity,
                    timestamp: new Date().toISOString(),
                    spriteUrl: pokemonData.spriteUrl,
                    pace: pokemonData.pace,
                    distance: pokemonData.distance,
                    duration: pokemonData.duration,
                    // Lift workout fields
                    caloriesBurned: pokemonData.caloriesBurned,
                    avgHR: pokemonData.avgHR
                };
                
                console.log('üíæ PC Entry created:', pcEntry);
                
                const updatedPC = [pcEntry, ...pokemonPC]; // Add to beginning (newest first)
                setPokemonPC(updatedPC);
                
                // Save to local storage
                await window.storage.set('pokemon-pc', JSON.stringify(updatedPC));
                
                // Sync to Firebase if user is authenticated
                if (firebaseManager.user) {
                    try {
                        await database.ref(`users/${firebaseManager.user.uid}/pc`).set(updatedPC);
                        console.log('‚úÖ PC synced to Firebase');
                    } catch (error) {
                        console.error('‚ùå Error syncing PC to Firebase:', error);
                    }
                }
            };

            const deletePokemonFromPC = async (entryId) => {
                const updatedPC = (Array.isArray(pokemonPC) ? pokemonPC : []).filter(p => p.id !== entryId);
                setPokemonPC(updatedPC);
                await window.storage.set('pokemon-pc', JSON.stringify(updatedPC));
                
                // Sync to Firebase
                if (firebaseManager.user) {
                    try {
                        await database.ref(`users/${firebaseManager.user.uid}/pc`).set(updatedPC);
                        console.log('‚úÖ PC deletion synced to Firebase');
                    } catch (error) {
                        console.error('‚ùå Error syncing PC deletion to Firebase:', error);
                    }
                }
                
                // Also remove from starters if it's there
                const updatedStarters = (Array.isArray(starterTeam) ? starterTeam : [null, null, null, null, null, null]).map(starter => 
                    starter?.id === entryId ? null : starter
                );
                setStarterTeam(updatedStarters);
                await window.storage.set('starter-team', JSON.stringify(updatedStarters));
                
                setShowDeletePrompt(null);
            };

            const addToStarters = async (slotIndex, pcEntry) => {
                const updatedStarters = [...(Array.isArray(starterTeam) ? starterTeam : [null, null, null, null, null, null])];
                updatedStarters[slotIndex] = pcEntry;
                setStarterTeam(updatedStarters);
                await window.storage.set('starter-team', JSON.stringify(updatedStarters));
                
                // Sync to Firebase
                if (firebaseManager.user) {
                    try {
                        await database.ref(`users/${firebaseManager.user.uid}/starters`).set(updatedStarters);
                        console.log('‚úÖ Starters synced to Firebase');
                    } catch (error) {
                        console.error('‚ùå Error syncing starters to Firebase:', error);
                    }
                }
                
                setSelectingForSlot(null);
                setCurrentView('starters');
            };

            const removeFromStarters = async (slotIndex) => {
                const updatedStarters = [...(Array.isArray(starterTeam) ? starterTeam : [null, null, null, null, null, null])];
                updatedStarters[slotIndex] = null;
                setStarterTeam(updatedStarters);
                await window.storage.set('starter-team', JSON.stringify(updatedStarters));
                
                // Sync to Firebase
                if (firebaseManager.user) {
                    try {
                        await database.ref(`users/${firebaseManager.user.uid}/starters`).set(updatedStarters);
                        console.log('‚úÖ Starter removal synced to Firebase');
                    } catch (error) {
                        console.error('‚ùå Error syncing starter removal to Firebase:', error);
                    }
                }
            };

            const saveRunHistory = async (newRun) => {
                const updatedHistory = [...runHistory, newRun];
                await window.storage.set('run-history', JSON.stringify(updatedHistory));
                setRunHistory(updatedHistory);
            };

            const updateStreak = async () => {
                const today = new Date().toDateString();
                const lastRun = runHistory.length > 0 ? new Date(runHistory[runHistory.length - 1].date).toDateString() : null;
                
                let newStreak = { ...currentStreak };
                
                if (lastRun === today) return currentStreak;
                
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                if (lastRun === yesterdayStr || runHistory.length === 0) {
                    newStreak.days = currentStreak.days + 1;
                    if (newStreak.days % 7 === 0) {
                        newStreak.weeks = Math.floor(newStreak.days / 7);
                    }
                } else {
                    newStreak = { days: 1, weeks: 0 };
                }
                
                await window.storage.set('current-streak', JSON.stringify(newStreak));
                setCurrentStreak(newStreak);
                return newStreak;
            };

            const checkForPRs = (paceSeconds, distanceNum, durationSeconds) => {
                const newPRs = {};
                if (!personalRecords.fastestPace || paceSeconds < personalRecords.fastestPace) {
                    newPRs.fastestPace = true;
                }
                if (!personalRecords.longestDistance || distanceNum > personalRecords.longestDistance) {
                    newPRs.longestDistance = true;
                }
                if (!personalRecords.longestDuration || durationSeconds > personalRecords.longestDuration) {
                    newPRs.longestDuration = true;
                }
                setIsNewPR(newPRs);
                return newPRs;
            };

            const updatePersonalRecords = async (paceSeconds, distanceNum, durationSeconds) => {
                const newPRs = {
                    fastestPace: !personalRecords.fastestPace ? paceSeconds : Math.min(personalRecords.fastestPace, paceSeconds),
                    longestDistance: !personalRecords.longestDistance ? distanceNum : Math.max(personalRecords.longestDistance, distanceNum),
                    longestDuration: !personalRecords.longestDuration ? durationSeconds : Math.max(personalRecords.longestDuration, durationSeconds)
                };
                await window.storage.set('personal-records', JSON.stringify(newPRs));
                setPersonalRecords(newPRs);
            };

            const updateJourney = async (runData, isLegendary = false, fetchedPokemonData = null) => {
                let journey = currentJourney;
                
                if (!journey) {
                    journey = {
                        startDate: new Date().toISOString(),
                        runs: [],
                        totalDistance: 0,
                        totalDuration: 0,
                        bestPace: null,
                        prCount: 0,
                        maxStreak: 0,
                        legendaryEncounters: 0
                    };
                }
                
                journey.runs.push(runData);
                journey.totalDistance += runData.distance;
                journey.totalDuration += runData.duration;
                journey.bestPace = !journey.bestPace ? runData.pace : Math.min(journey.bestPace, runData.pace);
                journey.prCount += runData.newPRs.length;
                journey.maxStreak = Math.max(journey.maxStreak, currentStreak.days);
                
                if (isLegendary) {
                    journey.legendaryEncounters++;
                    journey.endDate = new Date().toISOString();
                    journey.legendary = {
                        id: runData.pokemonId,
                        name: runData.pokemonName || fetchedPokemonData?.name || 'unknown',
                        isShiny: runData.isShiny
                    };
                    
                    const completedJourneyData = { ...journey };
                    setCompletedJourney(completedJourneyData);
                    
                    const updatedJourneyHistory = [...journeyHistory, completedJourneyData];
                    await window.storage.set('journey-history', JSON.stringify(updatedJourneyHistory));
                    setJourneyHistory(updatedJourneyHistory);
                    
                    await window.storage.set('current-journey', 'null');
                    setCurrentJourney(null);
                    setShowJourneyModal(true);
                    
                    return completedJourneyData;
                } else {
                    await window.storage.set('current-journey', JSON.stringify(journey));
                    setCurrentJourney(journey);
                    return journey;
                }
            };

            const calculateIntensity = (paceSeconds, distanceNum, durationSeconds) => {
                let intensity = 0;
                if (paceSeconds < 360) intensity += 40;
                else if (paceSeconds < 420) intensity += 35;
                else if (paceSeconds < 480) intensity += 30;
                else if (paceSeconds < 540) intensity += 25;
                else if (paceSeconds < 600) intensity += 20;
                else intensity += 15;
                
                if (distanceNum >= 26.2) intensity += 40;
                else if (distanceNum >= 13.1) intensity += 35;
                else if (distanceNum >= 10) intensity += 30;
                else if (distanceNum >= 6.2) intensity += 25;
                else if (distanceNum >= 3.1) intensity += 20;
                else if (distanceNum >= 1) intensity += 15;
                else intensity += 10;
                
                const minutes = durationSeconds / 60;
                if (minutes >= 120) intensity += 20;
                else if (minutes >= 60) intensity += 17;
                else if (minutes >= 30) intensity += 14;
                else intensity += 10;
                
                return Math.min(100, intensity);
            };

            const calculateRarityChances = (intensity, streak, newPRs) => {
                let chances = { ...RARITY_TIERS };
                const intensityMultiplier = 1 + (intensity / 50);
                const dayStreakMultiplier = 1 + (Math.min(streak.days, 30) * 0.05);
                const weekStreakMultiplier = 1 + (Math.min(streak.weeks, 10) * 0.1);
                const prCount = Object.values(newPRs).filter(Boolean).length;
                const prMultiplier = 1 + (prCount * 0.5);
                const totalMultiplier = intensityMultiplier * dayStreakMultiplier * weekStreakMultiplier * prMultiplier;
                
                const adjustedChances = {
                    common:    { ...chances.common,    chance: Math.max(0.1, chances.common.chance / totalMultiplier) },
                    uncommon:  { ...chances.uncommon,  chance: chances.uncommon.chance * 1.2 },
                    rare:      { ...chances.rare,      chance: chances.rare.chance * totalMultiplier * 0.8 },
                    epic:      { ...chances.epic,      chance: chances.epic.chance * totalMultiplier * 1.2 },
                    legendary: { ...chances.legendary, chance: Math.min(0.25, chances.legendary.chance * totalMultiplier * 2) }
                };
                
                const total = Object.values(adjustedChances).reduce((sum, tier) => sum + tier.chance, 0);
                Object.keys(adjustedChances).forEach(key => {
                    adjustedChances[key].chance = adjustedChances[key].chance / total;
                });
                
                return { chances: adjustedChances, multiplier: totalMultiplier };
            };

            const rollRarity = (chances) => {
                const roll = Math.random();
                let cumulative = 0;
                for (const [tier, data] of Object.entries(chances)) {
                    cumulative += data.chance;
                    if (roll <= cumulative) return { tier, ...data };
                }
                return { tier: 'common', ...chances.common };
            };

            // ‚úÖ Pick a Pokemon ID that *matches the tier* based on your map
            const pickPokemonIdForTier = (tier) => {
                const list = POKEMON_IDS_BY_RARITY[tier] || [];
                if (!list.length) {
                    // Hard fallback: any mapped ID
                    const allIds = Object.keys(POKEMON_RARITY_MAP).map(Number);
                    return allIds[Math.floor(Math.random() * allIds.length)];
                }
                return list[Math.floor(Math.random() * list.length)];
            };

            const getPokemonByRarity = async (rarity) => {
                const pokemonId = pickPokemonIdForTier(rarity.tier);

                const baseShinyChance = 1/4096;
                const streakBonus = currentStreak.days * (1/500);
                const shinyChance = Math.min(0.1, baseShinyChance + streakBonus);
                const isShinyRoll = Math.random() < shinyChance;
                setIsShiny(isShinyRoll);

                return { pokemonId, isShiny: isShinyRoll, shinyChance };
            };

            // =========================
            // üéÆ POK√âBALL EXCHANGE SYSTEM
            // =========================
            
            const POKEBALL_CONFIG = {
                MIN: 3,
                MAX: 50,
                // Cardio
                CARDIO_BASE_MINUTES_PER_BALL: 6,
                CARDIO_DISTANCE_THRESHOLD: 2,
                CARDIO_DISTANCE_MULTIPLIER: 1.25,
                CARDIO_PACE_TIERS: [
                    { pace: 450, mult: 2.15 },   // < 7:30
                    { pace: 510, mult: 1.9 },    // < 8:30
                    { pace: 570, mult: 1.75 },   // < 9:30
                    { pace: 630, mult: 1.5 }     // < 10:30
                ],
                // Lift
                LIFT_CALORIES_PER_BALL: 70,
                LIFT_TIME_THRESHOLD: 90,
                LIFT_TIME_MULTIPLIER: 1.5,
                // Streak
                STREAK_BONUS_DIVISOR: 1.5
            };

            const handlePokeballExchange = () => {
                let earned = 0;
                
                if (workoutTab === 'cardio') {
                    // Parse cardio inputs
                    const [paceMin, paceSec] = pace.split(':').map(Number);
                    const paceSeconds = (paceMin * 60) + (paceSec || 0);
                    const distanceNum = parseFloat(distance);
                    const [durMin, durSec] = duration.split(':').map(Number);
                    const durationSeconds = (durMin * 60) + (durSec || 0);
                    const durationMinutes = durationSeconds / 60;
                    
                    // Base balls from duration
                    const baseBalls = Math.max(
                        POKEBALL_CONFIG.MIN,
                        Math.round(durationMinutes / POKEBALL_CONFIG.CARDIO_BASE_MINUTES_PER_BALL)
                    );
                    
                    // Distance multiplier
                    let distanceMultiplier = 1.0;
                    if (distanceNum > POKEBALL_CONFIG.CARDIO_DISTANCE_THRESHOLD) {
                        const steps = Math.floor(distanceNum - POKEBALL_CONFIG.CARDIO_DISTANCE_THRESHOLD);
                        distanceMultiplier = Math.pow(POKEBALL_CONFIG.CARDIO_DISTANCE_MULTIPLIER, steps);
                    }
                    
                    // Pace multiplier (check fastest tier first)
                    let paceMultiplier = 1.0;
                    for (const tier of POKEBALL_CONFIG.CARDIO_PACE_TIERS) {
                        if (paceSeconds < tier.pace) {
                            paceMultiplier = tier.mult;
                            break;
                        }
                    }
                    
                    // Streak bonus
                    const streakBonus = Math.floor((currentStreak.days * 2) / 3);
                    
                    // Calculate final
                    earned = Math.round(baseBalls * distanceMultiplier * paceMultiplier) + streakBonus;
                    
                    console.log('üèÉ Cardio Exchange:', {
                        baseBalls,
                        distanceMultiplier,
                        paceMultiplier,
                        streakBonus,
                        earned
                    });
                    
                } else if (workoutTab === 'lift') {
                    // Parse lift inputs
                    const calories = parseFloat(caloriesBurned);
                    const [durMin, durSec] = liftDuration.split(':').map(Number);
                    const durationMinutes = (durMin * 60 + (durSec || 0)) / 60;
                    
                    // Base balls from calories
                    const baseBalls = Math.max(
                        POKEBALL_CONFIG.MIN,
                        Math.round(calories / POKEBALL_CONFIG.LIFT_CALORIES_PER_BALL)
                    );
                    
                    // Time multiplier
                    let timeMultiplier = 1.0;
                    if (durationMinutes > POKEBALL_CONFIG.LIFT_TIME_THRESHOLD) {
                        timeMultiplier = POKEBALL_CONFIG.LIFT_TIME_MULTIPLIER;
                    }
                    
                    // Streak bonus
                    const streakBonus = Math.floor((currentStreak.days * 2) / 3);
                    
                    // Calculate final
                    earned = Math.round(baseBalls * timeMultiplier) + streakBonus;
                    
                    console.log('üèãÔ∏è Lift Exchange:', {
                        baseBalls,
                        timeMultiplier,
                        streakBonus,
                        earned
                    });
                }
                
                // Clamp to min/max
                earned = Math.max(POKEBALL_CONFIG.MIN, Math.min(POKEBALL_CONFIG.MAX, earned));
                
                // Add to stored pokeballs
                const newTotal = storedPokeballs + earned;
                setStoredPokeballs(newTotal);
                setHasExchanged(true);
                
                console.log(`‚ú® Earned ${earned} Pok√©balls! Total: ${newTotal}`);
                
                // Save to localStorage  
                window.storage.set('stored-pokeballs', newTotal.toString());
                
                // Store workout intensity AND workout data for capture session
                if (workoutTab === 'cardio') {
                    const [paceMin, paceSec] = pace.split(':').map(Number);
                    const paceSeconds = (paceMin * 60) + (paceSec || 0);
                    const distanceNum = parseFloat(distance);
                    const [durMin, durSec] = duration.split(':').map(Number);
                    const durationSeconds = (durMin * 60) + (durSec || 0);
                    
                    const newPRs = checkForPRs(paceSeconds, distanceNum, durationSeconds);
                    const intensity = calculateIntensity(paceSeconds, distanceNum, durationSeconds);
                    const { chances } = calculateRarityChances(intensity, currentStreak, newPRs);
                    
                    setLastWorkoutIntensity({ 
                        chances, 
                        newPRs,
                        workoutType: 'cardio',
                        pace,
                        distance,
                        duration
                    });
                } else if (workoutTab === 'lift') {
                    // For lift, use default chances since we don't have intensity calculation yet
                    const chances = {
                        common: { chance: 0.50 },
                        uncommon: { chance: 0.30 },
                        rare: { chance: 0.15 },
                        epic: { chance: 0.04 },
                        legendary: { chance: 0.01 }
                    };
                    
                    console.log('üèãÔ∏è Storing lift data:', {
                        liftDuration,
                        caloriesBurned,
                        avgHR
                    });
                    
                    setLastWorkoutIntensity({
                        chances,
                        newPRs: {},
                        workoutType: 'lift',
                        liftDuration,
                        caloriesBurned,
                        avgHR
                    });
                }
            };

            // =========================
            // üéØ CAPTURE SESSION SYSTEM (Phase 2)
            // =========================
            
            const CATCH_CONFIG = {
                BASE_PROBABILITY: {
                    legendary: 0.20,  // 2/10 - unchanged
                    epic: 0.40,       // 4/10 (was 0.50)
                    rare: 0.50,       // 5/10 (restored)
                    uncommon: 0.65,   // 6.5/10 (adjusted)
                    common: 0.80      // 8/10 (was 0.90)
                },
                SHINY_BONUS: {
                    legendary: 0.50,
                    default: 0.20
                }
            };

            // Generate 5-encounter capture session
            const generateCaptureSession = async () => {
                console.log('üéØ Generating 5-encounter capture session...');
                
                if (!lastWorkoutIntensity) {
                    alert('No workout intensity data. Please do a Pok√©ball Exchange first.');
                    return;
                }
                
                const encounters = [];
                const { chances } = lastWorkoutIntensity;
                
                // Generate 5 Pok√©mon using the same intensity
                for (let i = 0; i < 5; i++) {
                    const rarity = rollRarity(chances);
                    const { pokemonId, isShiny } = await getPokemonByRarity(rarity);
                    const actualRarity = getPokemonRarity(pokemonId);
                    
                    // Fetch Pokemon data
                    const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonId}`);
                    const fetchedData = await response.json();
                    
                    encounters.push({
                        encounterId: `encounter_${Date.now()}_${i}`,
                        pokemonId,
                        pokemonName: fetchedData?.name || 'unknown',
                        spriteUrl: isShiny ? fetchedData?.sprites.front_shiny : fetchedData?.sprites.front_default,
                        rarity: actualRarity,
                        isShiny,
                        status: 'active', // 'active' | 'captured' | 'ran'
                        attempts: 0
                    });
                    
                    // Small delay between generations
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const session = {
                    sessionId: `session_${Date.now()}`,
                    encounters,
                    currentIndex: 0,
                    createdAt: Date.now(),
                    workoutData: lastWorkoutIntensity.workoutType === 'lift' 
                        ? {
                            workoutType: 'lift',
                            liftDuration: lastWorkoutIntensity.liftDuration,
                            caloriesBurned: lastWorkoutIntensity.caloriesBurned,
                            avgHR: lastWorkoutIntensity.avgHR
                          }
                        : {
                            workoutType: 'cardio',
                            pace: lastWorkoutIntensity.pace,
                            distance: lastWorkoutIntensity.distance,
                            duration: lastWorkoutIntensity.duration
                          }
                };
                
                setCaptureSession(session);
                setCurrentEncounter(encounters[0]);
                
                // Save session to storage
                await window.storage.set('capture-session', JSON.stringify(session));
                
                console.log('‚úÖ Session created:', session);
                return session;
            };

            // Load existing session from storage
            const loadCaptureSession = async () => {
                try {
                    const result = await window.storage.get('capture-session');
                    if (result && result.value && result.value !== 'null') {
                        const session = JSON.parse(result.value);
                        setCaptureSession(session);
                        setCurrentEncounter(session.encounters[session.currentIndex]);
                        console.log('üìÇ Loaded existing session:', session);
                        return session;
                    }
                } catch (err) {
                    console.error('Error loading session:', err);
                }
                return null;
            };

            // Calculate catch probability
            const getCatchProbability = (rarity, isShiny) => {
                const base = CATCH_CONFIG.BASE_PROBABILITY[rarity] || CATCH_CONFIG.BASE_PROBABILITY.common;
                const shinyBonus = isShiny 
                    ? (rarity === 'legendary' ? CATCH_CONFIG.SHINY_BONUS.legendary : CATCH_CONFIG.SHINY_BONUS.default)
                    : 0;
                return Math.min(1.0, base + shinyBonus);
            };

            // Attempt to catch current encounter
            const attemptCatch = async () => {
                if (!currentEncounter || storedPokeballs <= 0 || isCatchAnimating) return;
                if (currentEncounter.status !== 'active') return;
                
                // Consume 1 Pok√©ball
                const newBallCount = storedPokeballs - 1;
                setStoredPokeballs(newBallCount);
                await window.storage.set('stored-pokeballs', newBallCount.toString());
                
                // Calculate success
                const probability = getCatchProbability(currentEncounter.rarity, currentEncounter.isShiny);
                const roll = Math.random();
                const success = roll <= probability;
                
                // Determine shake count based on closeness
                let shakes;
                if (success) {
                    // Successful catches: 1-3 shakes randomly
                    shakes = Math.random() < 0.3 ? 1 : (Math.random() < 0.6 ? 2 : 3);
                } else {
                    // Failed catches: more shakes for close calls
                    const howClose = roll / probability;
                    if (howClose < 1.2) shakes = 3; // Very close
                    else if (howClose < 1.5) shakes = 2; // Close
                    else shakes = 1; // Not close
                }
                
                setShakeCount(shakes);
                setIsCatchAnimating(true);
                
                console.log('üé≤ Catch attempt:', { probability, roll, success, shakes, rarity: currentEncounter.rarity });
                
                // Animate shakes (600ms per shake + 500ms initial)
                await new Promise(resolve => setTimeout(resolve, shakes * 600 + 500));
                
                setCatchResult(success ? 'success' : 'fail');
                setIsCatchAnimating(false);
                
                // Auto-clear result after 1.5 seconds if failed (allow retry)
                if (!success) {
                    setTimeout(() => {
                        setCatchResult(null);
                    }, 1500);
                }
                
                // Update encounter status
                if (success) {
                    const updatedEncounter = {
                        ...currentEncounter,
                        status: 'captured',
                        attempts: currentEncounter.attempts + 1
                    };
                    updateEncounterInSession(updatedEncounter);
                    
                    // Add to PC
                    // Add to PC with correct workout data
                    const pcData = {
                        pokemonId: updatedEncounter.pokemonId,
                        name: updatedEncounter.pokemonName,
                        isShiny: updatedEncounter.isShiny,
                        rarity: updatedEncounter.rarity,
                        spriteUrl: updatedEncounter.spriteUrl
                    };
                    
                    if (captureSession.workoutData.workoutType === 'cardio') {
                        pcData.pace = captureSession.workoutData.pace;
                        pcData.distance = captureSession.workoutData.distance;
                        pcData.duration = captureSession.workoutData.duration;
                    } else {
                        // Lift data
                        pcData.pace = '--';
                        pcData.distance = '--';
                        pcData.duration = captureSession.workoutData.liftDuration || '--';
                        pcData.caloriesBurned = captureSession.workoutData.caloriesBurned || '--';
                        pcData.avgHR = captureSession.workoutData.avgHR || '--';
                        
                        console.log('üíæ Adding lift Pokemon to PC:', {
                            duration: pcData.duration,
                            calories: pcData.caloriesBurned,
                            hr: pcData.avgHR,
                            fullData: pcData
                        });
                    }
                    
                    await addPokemonToPC(pcData);
                    
                    // Create activity feed entry with correct workout data
                    if (firebaseProfile && firebaseManager.user) {
                        const feedData = {
                            pokemonId: updatedEncounter.pokemonId,
                            pokemonName: updatedEncounter.pokemonName,
                            isShiny: updatedEncounter.isShiny,
                            rarity: updatedEncounter.rarity,
                            spriteUrl: updatedEncounter.spriteUrl,
                            trainerName: firebaseProfile.displayName,
                            trainerBadgeColor: firebaseProfile.badgeColor
                        };
                        
                        if (captureSession.workoutData.workoutType === 'cardio') {
                            feedData.pace = captureSession.workoutData.pace;
                            feedData.distance = captureSession.workoutData.distance;
                            feedData.duration = captureSession.workoutData.duration;
                        } else {
                            feedData.pace = '--';
                            feedData.distance = '--';
                            feedData.duration = captureSession.workoutData.liftDuration || '--';
                        }
                        
                        await createActivityFeedEntry(feedData);
                    }
                    
                    console.log('‚úÖ Pok√©mon captured!');
                } else {
                    const updatedEncounter = {
                        ...currentEncounter,
                        attempts: currentEncounter.attempts + 1
                    };
                    updateEncounterInSession(updatedEncounter);
                    console.log('‚ùå Catch failed');
                }
            };

            // Run from current encounter
            const runFromEncounter = () => {
                if (!currentEncounter || currentEncounter.status !== 'active') return;
                
                const updatedEncounter = {
                    ...currentEncounter,
                    status: 'ran'
                };
                updateEncounterInSession(updatedEncounter);
                
                console.log('üèÉ Ran from encounter');
                
                // Auto-advance to next
                setTimeout(() => advanceToNext(), 500);
            };

            // Advance to next encounter
            const advanceToNext = () => {
                if (!captureSession) return;
                
                const nextIndex = captureSession.currentIndex + 1;
                
                if (nextIndex < captureSession.encounters.length) {
                    const updatedSession = {
                        ...captureSession,
                        currentIndex: nextIndex
                    };
                    setCaptureSession(updatedSession);
                    setCurrentEncounter(updatedSession.encounters[nextIndex]);
                    setCatchResult(null);
                    
                    // Save updated session
                    window.storage.set('capture-session', JSON.stringify(updatedSession));
                    
                    console.log(`‚û°Ô∏è Advanced to encounter ${nextIndex + 1}/5`);
                } else {
                    // Session complete
                    endCaptureSession();
                }
            };

            // Update encounter in session
            const updateEncounterInSession = (updatedEncounter) => {
                const updatedEncounters = captureSession.encounters.map(enc =>
                    enc.encounterId === updatedEncounter.encounterId ? updatedEncounter : enc
                );
                
                const updatedSession = {
                    ...captureSession,
                    encounters: updatedEncounters
                };
                
                setCaptureSession(updatedSession);
                setCurrentEncounter(updatedEncounter);
                
                // Save updated session
                window.storage.set('capture-session', JSON.stringify(updatedSession));
            };

            // End capture session
            const endCaptureSession = async () => {
                console.log('üèÅ Capture session complete!');
                
                // Count captured Pok√©mon
                const capturedCount = captureSession.encounters.filter(e => e.status === 'captured').length;
                
                // Clear session from storage
                await window.storage.set('capture-session', 'null');
                
                // Reset states
                setCaptureSession(null);
                setCurrentEncounter(null);
                setCatchResult(null);
                setHasExchanged(false); // Allow new exchange
                
                alert(`üéâ Capture session complete! You caught ${capturedCount}/5 Pok√©mon. Check your PC!`);
            };
            

            const generatePokemon = async () => {
                setIsLoading(true);
                try {
                    const [paceMin, paceSec] = pace.split(':').map(Number);
                    const paceSeconds = (paceMin * 60) + (paceSec || 0);
                    const distanceNum = parseFloat(distance);
                    const [durMin, durSec] = duration.split(':').map(Number);
                    const durationSeconds = (durMin * 60) + (durSec || 0);
                    
                    const newPRs = checkForPRs(paceSeconds, distanceNum, durationSeconds);
                    const updatedStreak = await updateStreak();
                    const intensity = calculateIntensity(paceSeconds, distanceNum, durationSeconds);
                    const { chances, multiplier } = calculateRarityChances(intensity, updatedStreak, newPRs);

                    // Tier roll still uses your chance system...
                    const rarity = rollRarity(chances);
                    console.log('üé≤ Rolled tier:', rarity.tier);

                    // ...but Pok√©mon selection uses your rarity map.
                    const { pokemonId, isShiny, shinyChance } = await getPokemonByRarity(rarity);
                    console.log('üéØ Selected Pokemon ID:', pokemonId);

                    // ‚úÖ Actual rarity is always derived from the map (prevents mismatches forever)
                    const actualRarity = getPokemonRarity(pokemonId);
                    console.log('‚úÖ Actual rarity from map:', actualRarity);
                    const rarityColor = (RARITY_TIERS[actualRarity]?.color) || 'gray';

                    const fetchedPokemonData = await fetchPokemonData(pokemonId);
                    
                    const newRun = {
                        date: new Date().toISOString(),
                        pace: paceSeconds,
                        distance: distanceNum,
                        duration: durationSeconds,
                        intensity,
                        rarity: actualRarity,
                        pokemonId,
                        pokemonName: fetchedPokemonData?.name || 'unknown',
                        isShiny,
                        newPRs: Object.keys(newPRs).filter(key => newPRs[key])
                    };
                    
                    await saveRunHistory(newRun);
                    await updatePersonalRecords(paceSeconds, distanceNum, durationSeconds);
                    
                    // Add to PC with run stats
                    await addPokemonToPC({
                        pokemonId,
                        name: fetchedPokemonData?.name || 'unknown',
                        isShiny,
                        rarity: actualRarity,
                        spriteUrl: isShiny ? fetchedPokemonData?.sprites.front_shiny : fetchedPokemonData?.sprites.front_default,
                        pace: pace,
                        distance: distance,
                        duration: duration
                    });
                    
                    // üì∏ Create Activity Feed Entry (if Firebase profile exists)
                    if (firebaseProfile && firebaseManager.user) {
                        await createActivityFeedEntry({
                            pokemonId,
                            pokemonName: fetchedPokemonData?.name || 'unknown',
                            isShiny,
                            rarity: actualRarity,
                            spriteUrl: isShiny ? fetchedPokemonData?.sprites.front_shiny : fetchedPokemonData?.sprites.front_default,
                            pace: pace,
                            distance: distance,
                            duration: duration,
                            trainerName: firebaseProfile.displayName,
                            trainerBadgeColor: firebaseProfile.badgeColor
                        });
                    }
                    
                    const isLegendary = actualRarity === 'legendary';
                    
                    setRarityRoll({
                        tier: actualRarity,
                        color: rarityColor,
                        intensity,
                        multiplier,
                        chances,
                        shinyChance: (shinyChance * 100).toFixed(2)
                    });
                    
                    await updateJourney(newRun, isLegendary, fetchedPokemonData);
                    setIsLoading(false);
                } catch (error) {
                    console.error('Error:', error);
                    setIsLoading(false);
                }
            };

            const fetchPokemonData = async (pokemonId) => {
                try {
                    const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonId}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    setPokemonData(data);

                    const variants = [];
                    if (data.sprites.front_default) variants.push({ name: 'Default', key: 'front_default', url: data.sprites.front_default });
                    if (data.sprites.front_shiny) variants.push({ name: 'Shiny ‚ú®', key: 'front_shiny', url: data.sprites.front_shiny });
                    
                    setAvailableVariants(variants);
                    setSpriteVariant(isShiny && data.sprites.front_shiny ? 'front_shiny' : variants[0]?.key || 'front_default');
                    
                    return data;
                } catch (error) {
                    console.error('Error fetching Pokemon:', error);
                    return null;
                }
            };

            useEffect(() => {
                if (pokemonData && rarityRoll) generateImage();
            }, [pokemonData, spriteVariant, rarityRoll]);

            const getCurrentSpriteUrl = () => {
                if (!pokemonData) return null;
                const variant = availableVariants.find(v => v.key === spriteVariant);
                return variant ? variant.url : pokemonData.sprites.front_default;
            };

            const generateImage = () => {
                const canvas = canvasRef.current;
                if (!canvas || !pokemonData) return;

                // Increment generation counter
                imageGenerationRef.current += 1;
                const currentGeneration = imageGenerationRef.current;

                const ctx = canvas.getContext('2d');
                const width = 1080;
                const height = 1080;
                canvas.width = width;
                canvas.height = height;

                ctx.fillStyle = '#C5C9B8';
                ctx.fillRect(0, 0, width, height);

                const spriteUrl = getCurrentSpriteUrl();
                if (spriteUrl) {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => {
                        // Ignore stale callbacks
                        if (currentGeneration !== imageGenerationRef.current) {
                            console.log('üö´ Ignoring stale image callback');
                            return;
                        }

                        const scale = 6;
                        const spriteWidth = img.width * scale;
                        const spriteHeight = img.height * scale;
                        const spriteX = (width - spriteWidth) / 2;
                        const spriteY = 220;
                        
                        // Pokemon name above sprite (null-safe)
                        if (pokemonData?.name) {
                            ctx.fillStyle = '#000000';
                            ctx.font = 'bold 48px Arial';
                            ctx.textAlign = 'center';
                            const pokemonName = pokemonData.name.toUpperCase();
                            ctx.fillText(pokemonName, width / 2, spriteY - 60);
                        }
                        
                        ctx.imageSmoothingEnabled = false;
                        
                        if (isShiny) {
                            ctx.shadowColor = '#FFD700';
                            ctx.shadowBlur = 30;
                            for (let i = 0; i < 5; i++) {
                                ctx.drawImage(img, spriteX, spriteY, spriteWidth, spriteHeight);
                            }
                            ctx.shadowBlur = 0;
                        }
                        
                        ctx.drawImage(img, spriteX, spriteY, spriteWidth, spriteHeight);
                        
                        // Draw rarity icon (TCG style)
                        if (rarityRoll) {
                            const iconSize = 60;
                            const iconX = width / 2 - iconSize / 2;
                            const iconY = spriteY - 180;
                            
                            // Clear the icon area first to prevent overlays
                            ctx.clearRect(iconX - 5, iconY - 5, iconSize + 10, iconSize + 10);
                            // Redraw background in that area
                            ctx.fillStyle = '#C5C9B8';
                            ctx.fillRect(iconX - 5, iconY - 5, iconSize + 10, iconSize + 10);
                            
                            drawRarityIcon(ctx, iconX, iconY, iconSize, rarityRoll.tier);
                        }
                        
                        ctx.fillStyle = '#666666';
                        ctx.font = '20px monospace';
                        ctx.textAlign = 'left';
                        const timestamp = new Date().toLocaleString();
                        ctx.fillText(timestamp, spriteX - 60, spriteY + spriteHeight + 100);
                        
                        drawStatsBox(ctx, width, height);
                    };
                    img.onerror = () => {
                        console.error('Failed to load sprite image');
                    };
                    img.src = spriteUrl;
                }
            };

            const drawRarityIcon = (ctx, x, y, size, tier) => {
                ctx.save();
                
                switch(tier) {
                    case 'common':
                        ctx.fillStyle = '#6B7280';
                        ctx.beginPath();
                        ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'uncommon':
                        ctx.fillStyle = '#10B981';
                        ctx.beginPath();
                        ctx.moveTo(x + size/2, y);
                        ctx.lineTo(x + size, y + size/2);
                        ctx.lineTo(x + size/2, y + size);
                        ctx.lineTo(x, y + size/2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'rare':
                        ctx.fillStyle = '#3B82F6';
                        drawStar(ctx, x + size/2, y + size/2, 5, size/2, size/4);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        break;
                    case 'epic':
                        ctx.fillStyle = '#8B5CF6';
                        ctx.globalAlpha = 0.7;
                        drawStar(ctx, x + size/2 - 8, y + size/2, 5, size/2.2, size/4.4);
                        ctx.globalAlpha = 1;
                        drawStar(ctx, x + size/2 + 8, y + size/2, 5, size/2.2, size/4.4);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        break;
                    case 'legendary':
                        ctx.fillStyle = '#F59E0B';
                        drawStar(ctx, x + size/2, y + size/3, 5, size/2.5, size/5);
                        drawStar(ctx, x + size/4, y + size*2/3, 5, size/3, size/6);
                        drawStar(ctx, x + size*3/4, y + size*2/3, 5, size/3, size/6);
                        ctx.strokeStyle = '#FFFFFF';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        break;
                }
                
                ctx.restore();
            };

            const drawStar = (ctx, cx, cy, spikes, outerRadius, innerRadius) => {
                let rot = Math.PI / 2 * 3;
                let x = cx;
                let y = cy;
                const step = Math.PI / spikes;

                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                
                for (let i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    ctx.lineTo(x, y);
                    rot += step;

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y);
                    rot += step;
                }
                
                ctx.lineTo(cx, cy - outerRadius);
                ctx.closePath();
                ctx.fill();
            };

            const drawStatsBox = (ctx, width, height) => {
                const boxWidth = 800;
                const boxHeight = 250;
                const boxX = (width - boxWidth) / 2;
                const boxY = height - 330;

                ctx.fillStyle = '#000000';
                ctx.fillRect(boxX - 8, boxY - 8, boxWidth + 16, boxHeight + 16);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(boxX - 4, boxY - 4, boxWidth + 8, boxHeight + 8);
                ctx.fillStyle = '#E8E8D0';
                ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

                ctx.fillStyle = '#000000';
                ctx.font = 'bold 50px Arial';
                ctx.textAlign = 'left';
                
                const padding = 60;
                let textY = boxY + 70;
                
                ctx.fillText(`Avg Pace ${pace} min/mi`, boxX + padding, textY);
                textY += 80;
                ctx.fillText(`Distance ${distance} mi`, boxX + padding, textY);
                textY += 80;
                ctx.fillText(`Duration ${duration}`, boxX + padding, textY);
                
                // Calculate run start time (current time - duration)
                const now = new Date();
                const [durMin, durSec] = duration.split(':').map(Number);
                const durationMs = (durMin * 60 + (durSec || 0)) * 1000;
                const runStartTime = new Date(now - durationMs);
                
                // Format: DD/MM/YY HH:MM AM/PM
                const day = runStartTime.getDate().toString().padStart(2, '0');
                const month = (runStartTime.getMonth() + 1).toString().padStart(2, '0');
                const year = runStartTime.getFullYear().toString().slice(-2);
                let hours = runStartTime.getHours();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 should be 12
                const hoursStr = hours.toString();
                const minutes = runStartTime.getMinutes().toString().padStart(2, '0');
                const timestamp = `${day}/${month}/${year} ${hoursStr}:${minutes} ${ampm}`;
                
                // Draw timestamp in bottom-right corner (half size, 50% opacity)
                ctx.globalAlpha = 0.5;
                ctx.font = '25px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(timestamp, boxX + boxWidth - padding, boxY + boxHeight - 20);
                ctx.globalAlpha = 1.0; // Reset opacity
                ctx.textAlign = 'left'; // Reset alignment
            };

            const downloadImage = async () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                
                try {
                    canvas.toBlob(async (blob) => {
                        if (!blob) return;
                        
                        if (navigator.share && navigator.canShare) {
                            const file = new File([blob], `pokerun-${pokemonData?.name || 'pokemon'}.png`, { type: 'image/png' });
                            
                            if (navigator.canShare({ files: [file] })) {
                                try {
                                    await navigator.share({
                                        files: [file],
                                        title: 'My Pok√©Run',
                                        text: `Caught ${pokemonData?.name}!`
                                    });
                                    return;
                                } catch (err) {
                                    console.log('Share cancelled or failed:', err);
                                }
                            }
                        }
                        
                        const link = document.createElement('a');
                        link.download = `pokerun-${pokemonData?.name || 'pokemon'}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    }, 'image/png');
                } catch (error) {
                    console.error('Error sharing:', error);
                    const link = document.createElement('a');
                    link.download = `pokerun-${pokemonData?.name || 'pokemon'}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }
            };

            return (
                <div className="min-h-screen p-4 pb-20">
                    <div className="max-w-2xl mx-auto">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
                                Pok√©Run Journey
                            </h1>
                            <p className="text-sm text-gray-600">Track runs ‚Ä¢ Catch Pok√©mon ‚Ä¢ Complete journeys</p>
                        </div>

                        {/* Bill's PC, Starters & Feed Buttons */}
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <button
                                onClick={() => setCurrentView('pc')}
                                className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 rounded-xl p-3 text-white shadow-lg hover:shadow-2xl transition-all border border-slate-600"
                            >
                                <div className="text-xs font-semibold mb-1">üíæ Bill's PC</div>
                                <div className="text-lg font-bold">{(Array.isArray(pokemonPC) ? pokemonPC : []).length}</div>
                            </button>
                            <button
                                onClick={() => setCurrentView('starters')}
                                className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 rounded-xl p-3 text-white shadow-lg hover:shadow-2xl transition-all border border-slate-600"
                            >
                                <div className="text-xs font-semibold mb-1">‚≠ê Starters</div>
                                <div className="text-lg font-bold">{(Array.isArray(starterTeam) ? starterTeam : []).filter(s => s !== null).length}/6</div>
                            </button>
                            {firebaseProfile && (
                                <button
                                    onClick={() => setCurrentView('feed')}
                                    className="col-span-2 bg-gradient-to-br from-purple-600 to-indigo-700 hover:from-purple-500 hover:to-indigo-600 rounded-xl p-3 text-white shadow-lg hover:shadow-2xl transition-all border border-purple-500"
                                >
                                    <div className="text-xs font-semibold mb-1">üì∏ Activity Feed</div>
                                    <div className="text-lg font-bold">View Recent Catches</div>
                                </button>
                            )}
                        </div>

                        {currentView === 'main' && (
                        <>
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl p-6 mb-6 border border-slate-700">
                            {/* Badges at top in a horizontal line */}
                            <div className="flex justify-center gap-2 mb-3">
                                {/* Pok√©ball Inventory - using SVG Pok√©ball */}
                                <div className="flex items-center gap-2 px-3 py-2 rounded-lg font-bold text-xs text-white shadow-md bg-gradient-to-br from-red-600 to-red-700">
                                    <PokeballIcon size={20} />
                                    <span>{storedPokeballs}</span>
                                </div>
                                
                                {/* Streak Badge */}
                                <div className="flex items-center gap-2 px-3 py-2 rounded-lg font-bold text-xs text-white shadow-md bg-gradient-to-br from-gray-800 to-gray-900">
                                    <span>üî•</span>
                                    <span>{currentStreak.days}d</span>
                                </div>
                                
                                {/* Runs Badge */}
                                <div className="flex items-center gap-2 px-3 py-2 rounded-lg font-bold text-xs text-white shadow-md bg-gradient-to-br from-gray-800 to-gray-900">
                                    <span>üèÉ</span>
                                    <span>{runHistory.length}</span>
                                </div>
                                
                                {/* Profile Badge */}
                                <div className="relative" ref={profileMenuRef}>
                                <button 
                                    onClick={handleTrainerBadgeClick}
                                    disabled={isCreatingProfile || isLoadingProfile}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-sm text-white shadow-md hover:shadow-lg transition-all ${
                                        hasNotifications ? 'notification-glow' : ''
                                    } ${isCreatingProfile || isLoadingProfile ? 'opacity-50 cursor-wait badge-loading' : ''} ${
                                        !isLoadingProfile && firebaseProfile ? 'badge-illuminate' : ''
                                    }`}
                                    style={{ 
                                        backgroundColor: isLoadingProfile ? '#6b7280' : profileColor
                                    }}
                                >
                                    <span>{isLoadingProfile ? '‚è≥' : '‚ö°'}</span>
                                    <span>
                                        {isLoadingProfile 
                                            ? 'Loading...' 
                                            : isCreatingProfile 
                                                ? 'Creating...' 
                                                : (firebaseProfile ? firebaseProfile.displayName : trainerName)
                                        }
                                    </span>
                                </button>
                                    
                                    {/* Profile Dropdown Menu */}
                                    {showProfileMenu && (
                                        <div className="absolute right-0 top-full mt-2 bg-white rounded-xl shadow-2xl p-4 z-50 w-64 border-2 border-gray-200">
                                            {!showWipeConfirmation ? (
                                                <>
                                                    <div className="mb-4">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <label className="block text-xs font-semibold text-gray-600">TRAINER NAME</label>
                                                            {firebaseProfile && (
                                                                <svg className="w-4 h-4 text-green-500" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                                                    <circle cx="12" cy="12" r="11" fill="none" stroke="currentColor" strokeWidth="2"/>
                                                                </svg>
                                                            )}
                                                        </div>
                                                        {isEditingName ? (
                                                            <input 
                                                                type="text" 
                                                                value={trainerName}
                                                                onChange={(e) => handleNameInputChange(e.target.value)}
                                                                onFocus={() => {
                                                                    setOriginalTrainerName(trainerName);
                                                                    console.log('üìù Started editing name:', trainerName);
                                                                }}
                                                                onBlur={() => {
                                                                    console.log('üëã Name input blur - closing editor');
                                                                    setIsEditingName(false);
                                                                    // Name already saved by debounce or will save on next typing pause
                                                                }}
                                                                onKeyPress={(e) => {
                                                                    if (e.key === 'Enter') {
                                                                        console.log('‚èé Enter pressed');
                                                                        // Clear timeout and save immediately
                                                                        if (nameEditTimeout) {
                                                                            clearTimeout(nameEditTimeout);
                                                                        }
                                                                        const trimmedName = e.target.value.trim();
                                                                        if (trimmedName && trimmedName !== originalTrainerName) {
                                                                            console.log('üíæ Saving name on Enter:', trimmedName);
                                                                            handleNameChange(trimmedName);
                                                                        }
                                                                        setIsEditingName(false);
                                                                    }
                                                                }}
                                                                autoFocus
                                                                className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm"
                                                                maxLength={12}
                                                            />
                                                        ) : (
                                                            <button
                                                                onClick={() => setIsEditingName(true)}
                                                                className="w-full px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium text-left transition"
                                                            >
                                                                {trainerName}
                                                            </button>
                                                        )}
                                                    </div>
                                                    
                                                    <div>
                                                        <label className="block text-xs font-semibold text-gray-600 mb-2">BADGE COLOR</label>
                                                        <div className="grid grid-cols-4 gap-2">
                                                            {PROFILE_COLORS.map((color) => (
                                                                <button
                                                                    key={color.hex}
                                                                    onClick={() => {
                                                                        handleColorChange(color.hex);
                                                                    }}
                                                                    className={`w-full aspect-square rounded-lg transition-all ${
                                                                        profileColor === color.hex 
                                                                            ? 'ring-4 ring-offset-2 ring-gray-800 scale-110' 
                                                                            : 'hover:scale-105'
                                                                    }`}
                                                                    style={{ backgroundColor: color.hex }}
                                                                    title={color.name}
                                                                />
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex gap-2 mt-4">
                                                        {firebaseProfile && (
                                                            <>
                                                                <button
                                                                    onClick={() => {
                                                                        setShowProfileMenu(false);
                                                                        setShowFriendSearch(true);
                                                                    }}
                                                                    className="flex-1 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition relative"
                                                                >
                                                                    üë• Friends
                                                                    {friends.length > 0 && (
                                                                        <span className="absolute -top-2 -right-2 w-5 h-5 bg-gray-800 text-white rounded-full text-xs flex items-center justify-center font-bold">
                                                                            {friends.length}
                                                                        </span>
                                                                    )}
                                                                </button>
                                                                <button
                                                                    onClick={() => setShowWipeConfirmation(true)}
                                                                    className="px-3 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm font-medium transition"
                                                                >
                                                                    ‚öôÔ∏è
                                                                </button>
                                                            </>
                                                        )}
                                                        <button
                                                            onClick={() => setShowProfileMenu(false)}
                                                            className="px-3 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-lg text-sm font-medium transition"
                                                        >
                                                            ‚úï
                                                        </button>
                                                    </div>
                                                </>
                                            ) : (
                                                /* Wipe Confirmation Dialog */
                                                <div className="text-center">
                                                    <div className="text-4xl mb-3">‚ö†Ô∏è</div>
                                                    <h3 className="text-lg font-bold text-gray-800 mb-2">Delete All Data?</h3>
                                                    <p className="text-xs text-gray-600 mb-4">
                                                        This will permanently delete your trainer profile, all runs, Pok√©mon, and progress. You'll start fresh.
                                                    </p>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={handleWipeProfile}
                                                            disabled={isWiping}
                                                            className="flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold transition disabled:opacity-50"
                                                        >
                                                            {isWiping ? 'Wiping...' : 'Yes, Delete'}
                                                        </button>
                                                        <button
                                                            onClick={() => setShowWipeConfirmation(false)}
                                                            disabled={isWiping}
                                                            className="flex-1 px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg text-sm font-medium transition disabled:opacity-50"
                                                        >
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* üë• Friends Search & List Modal */}
                                    {showFriendSearch && firebaseProfile && (
                                        <div className="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
                                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[80vh] overflow-hidden flex flex-col">
                                                {/* Header */}
                                                <div className="p-4 border-b border-gray-200">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <h3 className="text-lg font-bold text-gray-800">üë• Friends</h3>
                                                        <button
                                                            onClick={() => setShowFriendSearch(false)}
                                                            className="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition"
                                                        >
                                                            ‚úï
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Search Bar */}
                                                    <div className="relative">
                                                        <input
                                                            type="text"
                                                            value={friendSearchQuery}
                                                            onChange={(e) => setFriendSearchQuery(e.target.value)}
                                                            placeholder="Type trainer name (3+ chars)..."
                                                            className="w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-lg text-sm"
                                                            maxLength={30}
                                                        />
                                                        <div className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">
                                                            {isSearching ? '‚è≥' : friendSearchQuery.length >= 3 ? 'üîç' : `${friendSearchQuery.length}/3`}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Content Area - Scrollable */}
                                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                                    {/* Search Results */}
                                                    {friendSearchResults.length > 0 && (
                                                        <div>
                                                            <h4 className="text-xs font-semibold text-gray-600 mb-2">
                                                                {friendSearchResults.some(r => r.matchType === 'exact') ? 'RESULTS' : 'SUGGESTIONS'}
                                                            </h4>
                                                            <div className="space-y-2">
                                                                {friendSearchResults.map(result => (
                                                                    <div
                                                                        key={result.uid}
                                                                        className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                                                                    >
                                                                        <div className="flex items-center gap-2 flex-1 min-w-0">
                                                                            <div
                                                                                className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0"
                                                                                style={{ backgroundColor: result.badgeColor }}
                                                                            >
                                                                                ‚ö°
                                                                            </div>
                                                                            <div className="min-w-0 flex-1">
                                                                                <div className="font-medium text-sm truncate">{result.displayName}</div>
                                                                                {result.matchType !== 'exact' && (
                                                                                    <div className="text-xs text-gray-500">Suggested match</div>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        {result.isFriend ? (
                                                                            <span className="text-xs text-green-600 font-medium flex-shrink-0">‚úì Friends</span>
                                                                        ) : (
                                                                            <button
                                                                                onClick={() => sendFriendRequest(result.uid)}
                                                                                className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold transition flex-shrink-0 ${
                                                                                    result.hasPendingRequest 
                                                                                        ? 'bg-yellow-500 hover:bg-yellow-600 ring-2 ring-yellow-300' 
                                                                                        : 'bg-green-500 hover:bg-green-600'
                                                                                }`}
                                                                            >
                                                                                {result.hasPendingRequest ? '‚àí' : '+'}
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Incoming Friend Requests */}
                                                    {incomingRequests.length > 0 && (
                                                        <div>
                                                            <h4 className="text-xs font-semibold text-gray-600 mb-2">FRIEND REQUESTS</h4>
                                                            <div className="space-y-2">
                                                                {incomingRequests.map(senderId => {
                                                                    const senderProfile = friendProfiles[senderId];
                                                                    if (!senderProfile) {
                                                                        // Load profile if not cached
                                                                        database.ref(`users/${senderId}/profile`).once('value').then(snap => {
                                                                            if (snap.exists()) {
                                                                                setFriendProfiles(prev => ({
                                                                                    ...prev,
                                                                                    [senderId]: snap.val()
                                                                                }));
                                                                            }
                                                                        });
                                                                        return null;
                                                                    }
                                                                    return (
                                                                        <div
                                                                            key={senderId}
                                                                            className="flex items-center justify-between p-3 bg-gray-100 bg-opacity-50 rounded-lg relative"
                                                                        >
                                                                            <div className="flex items-center gap-2">
                                                                                <div
                                                                                    className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm"
                                                                                    style={{ backgroundColor: senderProfile.badgeColor }}
                                                                                >
                                                                                    ‚ö°
                                                                                </div>
                                                                                <span className="font-medium text-sm">{senderProfile.displayName}</span>
                                                                            </div>
                                                                            <div className="flex gap-1">
                                                                                <button
                                                                                    onClick={() => acceptFriendRequest(senderId)}
                                                                                    className="w-8 h-8 bg-green-500 hover:bg-green-600 rounded-full flex items-center justify-center text-white font-bold transition"
                                                                                >
                                                                                    ‚úì
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => declineFriendRequest(senderId)}
                                                                                    className="w-8 h-8 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-white font-bold transition"
                                                                                >
                                                                                    ‚úï
                                                                                </button>
                                                                            </div>
                                                                            {/* Question mark indicator */}
                                                                            <div className="absolute right-2 top-2 w-4 h-4 bg-gray-400 rounded-full flex items-center justify-center text-white text-xs">
                                                                                ?
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Friends List */}
                                                    {friends.length > 0 && (
                                                        <div>
                                                            <h4 className="text-xs font-semibold text-gray-600 mb-2">MY FRIENDS ({friends.length})</h4>
                                                            <div className="space-y-2">
                                                                {friends
                                                                    .map(friendId => ({
                                                                        id: friendId,
                                                                        profile: friendProfiles[friendId]
                                                                    }))
                                                                    .filter(f => f.profile)
                                                                    .sort((a, b) => a.profile.displayName.localeCompare(b.profile.displayName))
                                                                    .map(friend => (
                                                                        <button
                                                                            key={friend.id}
                                                                            onClick={() => {
                                                                                console.log('üñ±Ô∏è FRIEND CLICKED FROM SEARCH MODAL:', friend.id);
                                                                                setShowFriendSearch(false);
                                                                                viewFriendStarters(friend.id);
                                                                            }}
                                                                            className="w-full flex items-center gap-2 p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition cursor-pointer text-left"
                                                                        >
                                                                            <div
                                                                                className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm"
                                                                                style={{ backgroundColor: friend.profile.badgeColor }}
                                                                            >
                                                                                ‚ö°
                                                                            </div>
                                                                            <span className="font-medium text-sm">{friend.profile.displayName}</span>
                                                                        </button>
                                                                    ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Empty States */}
                                                    {friends.length === 0 && incomingRequests.length === 0 && friendSearchResults.length === 0 && (
                                                        <div className="text-center py-8 text-gray-500">
                                                            <div className="text-4xl mb-2">üë•</div>
                                                            <div className="text-sm">Search for trainers to add friends!</div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Your Workout title - now below badges */}
                            <h2 className="text-xl font-bold text-white text-center mb-4">Your Workout</h2>
                            
                            {/* Workout Type Tabs */}
                            <div className="flex gap-2 mb-4">
                                <button
                                    onClick={() => setWorkoutTab('cardio')}
                                    className={`flex-1 py-2 px-4 rounded-lg font-bold text-sm transition ${
                                        workoutTab === 'cardio'
                                            ? 'bg-purple-600 text-white'
                                            : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
                                    }`}
                                >
                                    üèÉ Cardio
                                </button>
                                <button
                                    onClick={() => setWorkoutTab('lift')}
                                    className={`flex-1 py-2 px-4 rounded-lg font-bold text-sm transition ${
                                        workoutTab === 'lift'
                                            ? 'bg-purple-600 text-white'
                                            : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
                                    }`}
                                >
                                    üèãÔ∏è Lift
                                </button>
                            </div>
                            
                            {/* Cardio Inputs */}
                            {workoutTab === 'cardio' && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Pace (min/mi)</label>
                                    <input type="text" value={pace} 
                                           onChange={(e) => handlePaceChange(e.target.value)}
                                           onBlur={handlePaceBlur}
                                           className="w-full px-4 py-3 bg-slate-700 border-2 border-slate-600 rounded-lg text-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none transition" placeholder="8:53" />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Distance (miles)</label>
                                    <input type="text" value={distance} 
                                           onChange={(e) => handleDistanceChange(e.target.value)}
                                           onBlur={handleDistanceBlur}
                                           className="w-full px-4 py-3 bg-slate-700 border-2 border-slate-600 rounded-lg text-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none transition" placeholder="1.82" />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Duration (mm:ss)</label>
                                    <input type="text" value={duration} 
                                           onChange={(e) => handleDurationChange(e.target.value)}
                                           onBlur={handleDurationBlur}
                                           className="w-full px-4 py-3 bg-slate-700 border-2 border-slate-600 rounded-lg text-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none transition" placeholder="16:27" />
                                </div>
                            </div>
                            )}
                            
                            {/* Lift Inputs */}
                            {workoutTab === 'lift' && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Duration (mm:ss)</label>
                                    <input type="text" value={liftDuration} 
                                           onChange={(e) => setLiftDuration(e.target.value)}
                                           className="w-full px-4 py-3 bg-slate-700 border-2 border-slate-600 rounded-lg text-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none transition" placeholder="45:00" />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Calories Burned</label>
                                    <input type="text" value={caloriesBurned} 
                                           onChange={(e) => setCaloriesBurned(e.target.value)}
                                           className="w-full px-4 py-3 bg-slate-700 border-2 border-slate-600 rounded-lg text-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none transition" placeholder="350" />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-300 mb-2">Avg Heart Rate</label>
                                    <input type="text" value={avgHR} 
                                           onChange={(e) => setAvgHR(e.target.value)}
                                           className="w-full px-4 py-3 bg-slate-700 border-2 border-slate-600 rounded-lg text-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none transition" placeholder="145" />
                                </div>
                            </div>
                            )}
                            
                            {/* Action Buttons */}
                            <div className="grid grid-cols-2 gap-3 mt-6">
                                <button 
                                    onClick={handlePokeballExchange}
                                    disabled={hasExchanged}
                                    className={`py-4 rounded-lg font-bold text-lg transition shadow-lg ${
                                        hasExchanged
                                            ? 'bg-gray-600 text-gray-400 cursor-not-allowed opacity-50'
                                            : 'bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white hover:shadow-red-500/50'
                                    }`}
                                >
                                    {hasExchanged ? '‚úì Exchanged' : '‚ö™ Pok√©ball Exchange'}
                                </button>
                                
                                <button 
                                    onClick={generateCaptureSession}
                                    disabled={!hasExchanged || storedPokeballs === 0 || captureSession !== null}
                                    className={`py-4 rounded-lg font-bold text-lg transition shadow-lg ${
                                        hasExchanged && storedPokeballs > 0 && !captureSession
                                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white hover:shadow-purple-500/50'
                                            : 'bg-gray-600 text-gray-400 cursor-not-allowed opacity-50'
                                    }`}
                                >
                                    {captureSession ? 'üéØ Session Active' : 'üéØ Go Capture'}
                                </button>
                            </div>
                        </div>

                        {/* üéØ CAPTURE SESSION UI */}
                        {captureSession && currentEncounter && (
                            <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl p-6 mb-6 border border-slate-700">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-white capitalize">Wild {currentEncounter.pokemonName}!</h2>
                                    <div className="text-sm font-bold text-gray-400">
                                        Encounter {captureSession.currentIndex + 1}/5
                                    </div>
                                </div>
                                
                                {/* Pokemon Card - Match old shareable card style */}
                                <div className="relative bg-[#C5C9B8] rounded-2xl overflow-hidden mb-4">
                                    <EncounterCard 
                                        encounter={currentEncounter}
                                        workoutData={captureSession.workoutData}
                                        isCatchAnimating={isCatchAnimating}
                                        catchResult={catchResult}
                                        shakeCount={shakeCount}
                                    />
                                </div>
                                
                                {/* Action Buttons */}
                                <div className="grid grid-cols-2 gap-3">
                                    {currentEncounter.status === 'active' && !catchResult ? (
                                        <>
                                            <button
                                                onClick={attemptCatch}
                                                disabled={storedPokeballs === 0 || isCatchAnimating}
                                                className="py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-bold text-lg transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                ‚ö™ Catch ({storedPokeballs} left)
                                            </button>
                                            <button
                                                onClick={runFromEncounter}
                                                disabled={isCatchAnimating}
                                                className="py-4 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white rounded-lg font-bold text-lg transition shadow-lg disabled:opacity-50"
                                            >
                                                üèÉ Run
                                            </button>
                                        </>
                                    ) : currentEncounter.status === 'captured' ? (
                                        <>
                                            <button
                                                disabled
                                                className="py-4 bg-green-600 text-white rounded-lg font-bold text-lg opacity-50 cursor-not-allowed"
                                            >
                                                ‚úì Captured
                                            </button>
                                            <button
                                                onClick={advanceToNext}
                                                className="py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg font-bold text-lg transition shadow-lg"
                                            >
                                                ‚û°Ô∏è Next
                                            </button>
                                        </>
                                    ) : null}
                                </div>
                                
                                {/* Session Progress Dots */}
                                <div className="flex gap-2 justify-center mt-4">
                                    {captureSession.encounters.map((enc, idx) => (
                                        <div
                                            key={enc.encounterId}
                                            className={`w-3 h-3 rounded-full ${
                                                enc.status === 'captured' ? 'bg-green-500' :
                                                enc.status === 'ran' ? 'bg-gray-500' :
                                                idx === captureSession.currentIndex ? 'bg-purple-500 ring-2 ring-purple-300' :
                                                'bg-gray-700'
                                            }`}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {pokemonData && (
                            <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl p-6 border border-slate-700">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold capitalize text-white">{pokemonData.name}</h2>
                                    <div className="flex gap-2">
                                        {rarityRoll && (
                                            <span className={`px-3 py-1 rounded-lg font-bold text-sm ${
                                                rarityRoll.tier === 'legendary' ? 'bg-gradient-to-r from-yellow-400 to-orange-400 text-white' :
                                                rarityRoll.tier === 'epic' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' :
                                                rarityRoll.tier === 'rare' ? 'bg-blue-500 text-white' :
                                                rarityRoll.tier === 'uncommon' ? 'bg-green-500 text-white' :
                                                'bg-gray-500 text-white'
                                            }`}>
                                                {rarityRoll.tier.toUpperCase()}
                                            </span>
                                        )}
                                        {isShiny && <span className="px-3 py-1 bg-yellow-400 text-white rounded-lg font-bold text-sm">‚ú® SHINY</span>}
                                    </div>
                                </div>
                                
                                <div className="bg-slate-700 rounded-lg p-4 mb-4 border border-slate-600">
                                    <canvas ref={canvasRef} className="w-full h-auto rounded-lg" style={{ maxHeight: '400px' }} />
                                </div>

                                <button onClick={downloadImage}
                                    className="w-full py-3 bg-black hover:bg-gray-900 text-white rounded-lg font-medium transition">
                                    Share your PokeRun
                                </button>
                            </div>
                        )}
                        </>
                        )}

                        {/* Bill's PC View */}
                        {currentView === 'pc' && (
                            <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl p-6 mb-6 border border-slate-700">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-white">üíæ Bill's PC</h2>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                setDeleteMode(!deleteMode);
                                                setShowDeletePrompt(null);
                                            }}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium transition shadow-lg ${
                                                deleteMode 
                                                    ? 'bg-red-500 hover:bg-red-600 text-white' 
                                                    : 'bg-slate-700 hover:bg-slate-600 text-white border border-slate-600'
                                            }`}
                                        >
                                            üóëÔ∏è
                                        </button>
                                        <button
                                            onClick={() => {
                                                setCurrentView('main');
                                                setSelectingForSlot(null);
                                                setDeleteMode(false);
                                            }}
                                            className="px-4 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-lg text-sm font-medium transition"
                                        >
                                            Back
                                        </button>
                                    </div>
                                </div>

                                {pokemonPC.length === 0 ? (
                                    <div className="text-center py-12 text-gray-500">
                                        <div className="text-4xl mb-2">üì≠</div>
                                        <div>No Pok√©mon yet!</div>
                                        <div className="text-sm">Complete runs to catch Pok√©mon</div>
                                    </div>
                                ) : (
                                    <>
                                        {selectingForSlot !== null && (
                                            <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-3 mb-4">
                                                <div className="text-sm font-semibold text-blue-800">
                                                    Select a Pok√©mon for Starter Slot {selectingForSlot + 1}
                                                </div>
                                            </div>
                                        )}
                                        <div className="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto">
                                            {(Array.isArray(pokemonPC) ? pokemonPC : []).map((pokemon) => (
                                                <div key={pokemon.id} className="relative">
                                                    <PokemonCard
                                                        pokemon={pokemon}
                                                        className="bg-gray-50 rounded-lg border-2 border-gray-200"
                                                        onClick={() => {
                                                            if (selectingForSlot !== null && !deleteMode) {
                                                                addToStarters(selectingForSlot, pokemon);
                                                            }
                                                        }}
                                                        showDelete={deleteMode}
                                                        onDelete={() => setShowDeletePrompt(pokemon.id)}
                                                    />
                                                    
                                                    {showDeletePrompt === pokemon.id && (
                                                        <div className="absolute inset-0 bg-black bg-opacity-90 rounded-lg flex flex-col items-center justify-center gap-2 z-20">
                                                            <div className="text-white text-sm font-bold">Delete?</div>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        deletePokemonFromPC(pokemon.id);
                                                                    }}
                                                                    className="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded font-bold text-xs"
                                                                >
                                                                    Yes
                                                                </button>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setShowDeletePrompt(null);
                                                                    }}
                                                                    className="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded font-bold text-xs"
                                                                >
                                                                    No
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* Starters View - Full Screen */}
                        {currentView === 'starters' && (
                            <div className="fixed inset-0 bg-gradient-to-br from-purple-600 to-pink-600 z-50 overflow-y-auto">
                                <div className="min-h-screen p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold text-white">‚≠ê Starter Team</h2>
                                        <button
                                            onClick={() => setCurrentView('main')}
                                            className="px-4 py-2 bg-white hover:bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition shadow-lg"
                                        >
                                            Back
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 max-w-md mx-auto">
                                    {(Array.isArray(starterTeam) ? starterTeam : [null, null, null, null, null, null]).map((starter, index) => (
                                        <div
                                            key={index}
                                            className="relative bg-gray-50 rounded-lg border-2 border-gray-200"
                                        >
                                            {starter ? (
                                                <div className="relative">
                                                    <PokemonCard
                                                        pokemon={starter}
                                                        className="p-0"
                                                    />
                                                    <button
                                                        onClick={() => removeFromStarters(index)}
                                                        className="absolute top-2 right-2 w-7 h-7 bg-red-500 hover:bg-red-600 text-white rounded-full text-sm font-bold shadow-lg z-10"
                                                    >
                                                        √ó
                                                    </button>
                                                </div>
                                            ) : (
                                                <button
                                                    onClick={() => {
                                                        setSelectingForSlot(index);
                                                        setCurrentView('pc');
                                                    }}
                                                    className="w-full h-full flex flex-col items-center justify-center hover:bg-gray-100 transition py-8"
                                                >
                                                    <div className="text-3xl opacity-30 mb-1">‚ö™</div>
                                                    <div className="text-xl font-bold text-gray-400">+</div>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                </div>
                            </div>
                        )}

                        {/* üë• Friends List View - Full Screen */}
                        {currentView === 'friends' && firebaseProfile && (
                            <div className="fixed inset-0 bg-gradient-to-br from-blue-600 to-indigo-600 z-50 overflow-y-auto">
                                <div className="min-h-screen p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold text-white">üë• Friends</h2>
                                        <button
                                            onClick={() => setCurrentView('main')}
                                            className="px-4 py-2 bg-white hover:bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition shadow-lg"
                                        >
                                            Back
                                        </button>
                                    </div>

                                    {/* Search Button */}
                                    <button
                                        onClick={() => setShowFriendSearch(true)}
                                        className="w-full mb-6 px-4 py-3 bg-white hover:bg-gray-50 text-gray-800 rounded-xl font-medium transition shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <span>üîç</span>
                                        <span>Search for Trainers</span>
                                    </button>

                                    {/* Incoming Friend Requests */}
                                    {incomingRequests.length > 0 && (
                                        <div className="mb-6">
                                            <h3 className="text-lg font-bold text-white mb-3">Friend Requests ({incomingRequests.length})</h3>
                                            <div className="space-y-3">
                                                {incomingRequests.map(senderId => {
                                                    const senderProfile = friendProfiles[senderId];
                                                    if (!senderProfile) {
                                                        database.ref(`users/${senderId}/profile`).once('value').then(snap => {
                                                            if (snap.exists()) {
                                                                setFriendProfiles(prev => ({
                                                                    ...prev,
                                                                    [senderId]: snap.val()
                                                                }));
                                                            }
                                                        });
                                                        return null;
                                                    }
                                                    return (
                                                        <div
                                                            key={senderId}
                                                            className="bg-white bg-opacity-50 backdrop-blur rounded-xl p-4 flex items-center justify-between"
                                                        >
                                                            <div className="flex items-center gap-3">
                                                                <div
                                                                    className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg"
                                                                    style={{ backgroundColor: senderProfile.badgeColor }}
                                                                >
                                                                    ‚ö°
                                                                </div>
                                                                <div>
                                                                    <div className="font-bold text-gray-800">{senderProfile.displayName}</div>
                                                                    <div className="text-xs text-gray-600">Wants to be friends</div>
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={() => acceptFriendRequest(senderId)}
                                                                    className="w-10 h-10 bg-green-500 hover:bg-green-600 rounded-full flex items-center justify-center text-white font-bold transition shadow-lg"
                                                                >
                                                                    ‚úì
                                                                </button>
                                                                <button
                                                                    onClick={() => declineFriendRequest(senderId)}
                                                                    className="w-10 h-10 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-white font-bold transition shadow-lg"
                                                                >
                                                                    ‚úï
                                                                </button>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    {/* Friends List */}
                                    {friends.length > 0 ? (
                                        <div>
                                            <h3 className="text-lg font-bold text-white mb-3">My Friends ({friends.length})</h3>
                                            <div className="space-y-3">
                                                {friends
                                                    .map(friendId => ({
                                                        id: friendId,
                                                        profile: friendProfiles[friendId]
                                                    }))
                                                    .filter(f => f.profile)
                                                    .sort((a, b) => a.profile.displayName.localeCompare(b.profile.displayName))
                                                    .map(friend => {
                                                        const hasTrade = pendingTrades[friend.id];
                                                        return (
                                                            <div key={friend.id} className="flex gap-2">
                                                                <button
                                                                    onClick={() => {
                                                                        console.log('üñ±Ô∏è FRIEND TILE CLICKED:', friend.id);
                                                                        viewFriendStarters(friend.id);
                                                                    }}
                                                                    className="flex-1 bg-white rounded-xl p-4 flex items-center gap-3 shadow-lg hover:shadow-xl hover:bg-gray-50 transition cursor-pointer text-left"
                                                                >
                                                                    <div
                                                                        className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg"
                                                                        style={{ backgroundColor: friend.profile.badgeColor }}
                                                                    >
                                                                        ‚ö°
                                                                    </div>
                                                                    <div className="flex-1">
                                                                        <div className="font-bold text-gray-800">{friend.profile.displayName}</div>
                                                                        <div className="text-xs text-gray-500">Tap to view profile ‚Üí</div>
                                                                    </div>
                                                                </button>
                                                                
                                                                {/* Trade Notification Tile */}
                                                                {hasTrade && (
                                                                    <button
                                                                        onClick={() => setViewingTradeRequest(hasTrade)}
                                                                        className="w-16 bg-gradient-to-br from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 rounded-xl flex items-center justify-center text-white text-2xl shadow-lg transition"
                                                                    >
                                                                        ü§ù
                                                                    </button>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12">
                                            <div className="text-6xl mb-4">üë•</div>
                                            <div className="text-white text-lg font-medium mb-2">No friends yet!</div>
                                            <div className="text-blue-100 text-sm">Search for trainers to add friends</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* ü§ù Trade Review Window */}
                        {viewingTradeRequest && (
                            <div className="fixed inset-0 bg-black bg-opacity-70 z-[80] flex items-center justify-center p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6">
                                    <h3 className="text-2xl font-bold mb-6 text-center">Trade Request</h3>
                                    
                                    {/* Trade Diagram */}
                                    <div className="flex items-center gap-4 mb-6">
                                        {/* Their offer */}
                                        <div className="flex-1">
                                            <div className="text-center mb-2 font-bold text-gray-700">
                                                {friendProfiles[viewingTradeRequest.from]?.displayName} offers:
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                {viewingTradeRequest.fromPokemon.map((pokemon, i) => (
                                                    <div key={i} className="bg-gray-50 rounded-lg border-2 border-gray-200">
                                                        <PokemonCard pokemon={pokemon} />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {/* Arrow */}
                                        <div className="text-4xl text-gray-400">‚áÑ</div>
                                        
                                        {/* Your offer */}
                                        <div className="flex-1">
                                            <div className="text-center mb-2 font-bold text-gray-700">You give:</div>
                                            <div className="grid grid-cols-3 gap-2">
                                                {viewingTradeRequest.toPokemon.map((pokemon, i) => (
                                                    <div key={i} className="bg-gray-50 rounded-lg border-2 border-gray-200">
                                                        <PokemonCard pokemon={pokemon} />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Actions */}
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => denyTrade(viewingTradeRequest)}
                                            className="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-bold transition"
                                        >
                                            ‚úï Deny
                                        </button>
                                        <button
                                            onClick={() => acceptTrade(viewingTradeRequest)}
                                            className="flex-1 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-bold transition"
                                        >
                                            ‚úì Accept Trade
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* üë§ Friend's Starters View Modal - REMOVED (using friendProfile view instead) */}
                        {false && viewingFriendId && friendProfiles[viewingFriendId] && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4">
                                <div className="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] overflow-y-auto">
                                    <div className="p-6">
                                        {/* Header */}
                                        <div className="flex justify-between items-center mb-6">
                                            <div className="flex items-center gap-3">
                                                <div
                                                    className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg"
                                                    style={{ backgroundColor: friendProfiles[viewingFriendId].badgeColor }}
                                                >
                                                    ‚ö°
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold text-white">{friendProfiles[viewingFriendId].displayName}</h3>
                                                    <div className="text-sm text-purple-100">Starter Team</div>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    setViewingFriendId(null);
                                                    setViewingFriendStarters([]);
                                                }}
                                                className="w-10 h-10 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center text-white text-xl transition"
                                            >
                                                ‚úï
                                            </button>
                                        </div>

                                        {/* Starters Grid */}
                                        <div className="grid grid-cols-2 gap-4">
                                            {viewingFriendStarters.map((starter, index) => (
                                                <div
                                                    key={index}
                                                    className="relative bg-white bg-opacity-90 rounded-lg p-3 border-2 border-white shadow-lg"
                                                >
                                                    {starter ? (
                                                        <>
                                                            <div className="text-center text-xs font-semibold capitalize text-gray-800">
                                                                {starter.pokemonName}
                                                            </div>
                                                            <div className="flex justify-around text-xs text-gray-600 font-medium my-1">
                                                                <span>{starter.pace || '--'}</span>
                                                                <span>{starter.distance || '--'}mi</span>
                                                                <span>{starter.duration || '--'}</span>
                                                            </div>
                                                            <img 
                                                                src={starter.spriteUrl} 
                                                                alt={starter.pokemonName}
                                                                className="w-20 h-20 mx-auto"
                                                            />
                                                            <div className="flex gap-1 justify-center mt-1">
                                                                <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                                                    starter.rarity === 'legendary' ? 'bg-yellow-400' :
                                                                    starter.rarity === 'epic' ? 'bg-purple-500 text-white' :
                                                                    starter.rarity === 'rare' ? 'bg-blue-500 text-white' :
                                                                    starter.rarity === 'uncommon' ? 'bg-green-500 text-white' :
                                                                    'bg-gray-400 text-white'
                                                                }`}>
                                                                    {starter.rarity.toUpperCase()}
                                                                </span>
                                                                {starter.isShiny && (
                                                                    <span className="px-2 py-0.5 bg-yellow-300 rounded text-xs font-bold">
                                                                        ‚ú®
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </>
                                                    ) : (
                                                        <div className="w-full h-full flex flex-col items-center justify-center py-4">
                                                            <div className="text-3xl opacity-30 mb-1">‚ö™</div>
                                                            <div className="text-sm text-gray-400">Empty</div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* üë§ Friend Profile View */}
                        {currentView === 'friendProfile' && viewingFriendId && (
                            <div className="fixed inset-0 bg-gradient-to-br from-indigo-600 to-purple-600 z-50 overflow-y-auto">
                                <div className="min-h-screen p-6">
                                    {/* Header */}
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold text-white">
                                            {friendProfiles[viewingFriendId]?.displayName || 'Friend'}'s Profile
                                        </h2>
                                        <button
                                            onClick={() => {
                                                setCurrentView('friends');
                                                setTradingWithFriend(null);
                                                setSelectedTheirPokemon([]);
                                                setSelectedMyPokemon([]);
                                            }}
                                            className="px-4 py-2 bg-white hover:bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition shadow-lg"
                                        >
                                            Back
                                        </button>
                                    </div>

                                    {/* Tabs */}
                                    <div className="flex gap-2 mb-6">
                                        <button
                                            onClick={() => setFriendProfileTab('starters')}
                                            className={`flex-1 py-3 rounded-lg font-bold transition ${
                                                friendProfileTab === 'starters'
                                                    ? 'bg-white text-indigo-600'
                                                    : 'bg-white bg-opacity-30 text-white hover:bg-opacity-40'
                                            }`}
                                        >
                                            ‚≠ê Starters
                                        </button>
                                        <button
                                            onClick={() => setFriendProfileTab('pc')}
                                            className={`flex-1 py-3 rounded-lg font-bold transition ${
                                                friendProfileTab === 'pc'
                                                    ? 'bg-white text-indigo-600'
                                                    : 'bg-white bg-opacity-30 text-white hover:bg-opacity-40'
                                            }`}
                                        >
                                            üíæ Bill's PC
                                        </button>
                                    </div>

                                    {/* Starters Tab */}
                                    {friendProfileTab === 'starters' && (
                                        <div className="bg-white rounded-2xl p-6 shadow-2xl">
                                            <div className="grid grid-cols-2 gap-4">
                                                {viewingFriendStarters.map((starter, index) => (
                                                    <div
                                                        key={index}
                                                        className="bg-gray-50 rounded-lg border-2 border-gray-200 min-h-[200px] flex items-center justify-center"
                                                    >
                                                        {starter ? (
                                                            <PokemonCard pokemon={starter} />
                                                        ) : (
                                                            <div className="text-gray-400 text-center">
                                                                <div className="text-3xl mb-2">‚ö™</div>
                                                                <div className="text-sm">Empty</div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* PC Tab */}
                                    {friendProfileTab === 'pc' && (
                                        <div className="bg-white rounded-2xl p-6 shadow-2xl">
                                            {/* Trade Controls */}
                                            {!tradingWithFriend && (
                                                <button
                                                    onClick={initiateTrade}
                                                    className="w-full mb-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-bold transition shadow-lg"
                                                >
                                                    ü§ù Initiate Trade
                                                </button>
                                            )}

                                            {tradingWithFriend && (
                                                <div className="mb-4 space-y-2">
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => setTradeView('their')}
                                                            className={`flex-1 py-2 rounded-lg font-bold ${
                                                                tradeView === 'their'
                                                                    ? 'bg-indigo-600 text-white'
                                                                    : 'bg-gray-200 text-gray-700'
                                                            }`}
                                                        >
                                                            Their PC ({selectedTheirPokemon.length}/3)
                                                        </button>
                                                        <button
                                                            onClick={() => setTradeView('my')}
                                                            className={`flex-1 py-2 rounded-lg font-bold ${
                                                                tradeView === 'my'
                                                                    ? 'bg-indigo-600 text-white'
                                                                    : 'bg-gray-200 text-gray-700'
                                                            }`}
                                                        >
                                                            My PC ({selectedMyPokemon.length}/3)
                                                        </button>
                                                    </div>
                                                    <button
                                                        onClick={sendTradeRequest}
                                                        disabled={selectedTheirPokemon.length === 0 || selectedMyPokemon.length === 0}
                                                        className="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-bold transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        üì§ Send Trade Request
                                                    </button>
                                                </div>
                                            )}

                                            {/* Pokemon Grid */}
                                            <div className="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto">
                                                {tradeView === 'their' ? (
                                                    viewingFriendPC.length === 0 ? (
                                                        <div className="col-span-2 text-center py-8 text-gray-500">
                                                            <div className="text-4xl mb-2">üì≠</div>
                                                            <div className="font-bold mb-2">Friend's PC is empty</div>
                                                            <div className="text-sm text-gray-400">
                                                                {friendProfiles[viewingFriendId]?.displayName} needs to reload their app to sync their Pok√©mon to the cloud
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        viewingFriendPC.map((pokemon) => {
                                                            const isSelected = tradingWithFriend && selectedTheirPokemon.find(p => p.id === pokemon.id);
                                                            return (
                                                                <div
                                                                    key={pokemon.id}
                                                                    onClick={() => tradingWithFriend && toggleTheirPokemon(pokemon)}
                                                                    className={`relative rounded-lg border-4 transition cursor-pointer ${
                                                                        isSelected
                                                                            ? 'border-blue-500 bg-blue-50'
                                                                            : 'border-gray-200 bg-gray-50 hover:border-blue-300'
                                                                    }`}
                                                                >
                                                                    {isSelected && (
                                                                        <div className="absolute top-2 right-2 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold z-10">
                                                                            ‚úì
                                                                        </div>
                                                                    )}
                                                                    <PokemonCard pokemon={pokemon} />
                                                                </div>
                                                            );
                                                        })
                                                    )
                                                ) : (
                                                    pokemonPC.length === 0 ? (
                                                        <div className="col-span-2 text-center py-8 text-gray-500">
                                                            <div className="text-4xl mb-2">üì≠</div>
                                                            <div>Your PC is empty</div>
                                                        </div>
                                                    ) : (
                                                        pokemonPC.map((pokemon) => {
                                                            const isSelected = selectedMyPokemon.find(p => p.id === pokemon.id);
                                                            return (
                                                                <div
                                                                    key={pokemon.id}
                                                                    onClick={() => toggleMyPokemon(pokemon)}
                                                                    className={`relative rounded-lg border-4 transition cursor-pointer ${
                                                                        isSelected
                                                                            ? 'border-green-500 bg-green-50'
                                                                            : 'border-gray-200 bg-gray-50 hover:border-green-300'
                                                                    }`}
                                                                >
                                                                    {isSelected && (
                                                                        <div className="absolute top-2 right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold z-10">
                                                                            ‚úì
                                                                        </div>
                                                                    )}
                                                                    <PokemonCard pokemon={pokemon} />
                                                                </div>
                                                            );
                                                        })
                                                    )
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* üì∏ Activity Feed View - Tinder-Style Swipeable Cards */}
                        {currentView === 'feed' && firebaseProfile && (
                            <div className="fixed inset-0 bg-gradient-to-br from-purple-600 to-pink-600 z-50 overflow-hidden">
                                <div className="h-full flex flex-col">
                                    {/* Header */}
                                    <div className="flex justify-between items-center p-6 pb-4">
                                        <h2 className="text-2xl font-bold text-white">üì∏ Activity Feed</h2>
                                        <button
                                            onClick={() => setCurrentView('main')}
                                            className="px-4 py-2 bg-white hover:bg-gray-100 text-gray-800 rounded-lg text-sm font-medium transition shadow-lg"
                                        >
                                            Back
                                        </button>
                                    </div>

                                    {/* Loading State */}
                                    {isLoadingFeed && activityFeed.length === 0 && (
                                        <div className="flex-1 flex items-center justify-center">
                                            <div className="text-center">
                                                <div className="loader mb-4"></div>
                                                <div className="text-white text-lg">Loading activity...</div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Card Stack Container */}
                                    {!isLoadingFeed && activityFeed.length > 0 && (
                                        <ActivityCardStack 
                                            activities={activityFeed}
                                            onGiveCandy={giveRareCandy}
                                            currentUserId={firebaseManager.user?.uid}
                                        />
                                    )}

                                    {/* Empty State */}
                                    {!isLoadingFeed && activityFeed.length === 0 && (
                                        <div className="flex-1 flex items-center justify-center p-6">
                                            <div className="text-center">
                                                <div className="text-6xl mb-4">üì≠</div>
                                                <div className="text-white text-xl font-bold mb-2">No Activity Yet</div>
                                                <div className="text-purple-100 text-sm">
                                                    Catch some Pok√©mon or add friends to see activity!
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        console.log('Root created, attempting render...');
        root.render(<PokemonRunTracker />);
        console.log('Render called successfully');

        // =========================
        // üß™ STEP 1 QA: TEST COMMANDS
        // =========================
        // Expose firebaseManager globally for console testing
        window.firebaseManager = firebaseManager;
        window.testFirebase = {
            async testAuth() {
                console.log('üß™ Testing Anonymous Auth...');
                try {
                    await firebaseManager.signInAnonymously();
                    console.log('‚úÖ Auth test passed');
                    return true;
                } catch (error) {
                    console.error('‚ùå Auth test failed:', error);
                    return false;
                }
            },
            async testProfile() {
                console.log('üß™ Testing Profile Creation...');
                try {
                    const profile = await firebaseManager.createTrainerProfile();
                    console.log('‚úÖ Profile created:', profile);
                    return profile;
                } catch (error) {
                    console.error('‚ùå Profile test failed:', error);
                    return false;
                }
            },
            async testMigration() {
                console.log('üß™ Testing Migration...');
                try {
                    await firebaseManager.migrateLocalStorageToFirebase();
                    console.log('‚úÖ Migration test passed');
                    return true;
                } catch (error) {
                    console.error('‚ùå Migration test failed:', error);
                    return false;
                }
            },
            async runAll() {
                console.log('üß™ Running all Step 1 tests...');
                const authResult = await this.testAuth();
                if (!authResult) return;
                
                const profileResult = await this.testProfile();
                if (!profileResult) return;
                
                await this.testMigration();
                
                console.log('‚úÖ All Step 1 tests complete! Check Firebase Console for data.');
            }
        };

        // üß™ STEP 4: ACTIVITY FEED TEST COMMANDS
        window.testActivityFeed = {
            async loadFeed() {
                console.log('üß™ Testing Activity Feed Load...');
                try {
                    // Access the loadActivityFeed function from the React component
                    // Note: This requires the component to expose it, so this is a placeholder
                    console.log('üì∏ To test: Catch a Pok√©mon and check Firebase Console');
                    console.log('üìç Path: users/{your-uid}/activity/');
                    return true;
                } catch (error) {
                    console.error('‚ùå Activity feed test failed:', error);
                    return false;
                }
            }
        };

        console.log('');
        console.log('üî• FIREBASE LOADED - Steps 1-4 (Core)');
        console.log('üìã Test Commands:');
        console.log('  testFirebase.runAll()       - Run all tests');
        console.log('  testFirebase.testAuth()     - Test anonymous auth');
        console.log('  testFirebase.testProfile()  - Test profile creation');
        console.log('  testFirebase.testMigration() - Test localStorage migration');
        console.log('');
        console.log('üì∏ Activity Feed:');
        console.log('  - Catch a Pok√©mon to create activity entry');
        console.log('  - Check Firebase Console: users/{uid}/activity/');
        console.log('');
    </script>

</body>
</html>
